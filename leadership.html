<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO 45001 | Policy Workstation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Space Grotesk', sans-serif; }</style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [session, setSession] = useState(null);
            const [formData, setFormData] = useState({
                orgName: '',
                siteCode: '',
                preamble: '',
                conditions: '',
                objectives: '',
                legal: '',
                hazard: '',
                improvement: '',
                workers: '',
                approvedBy: '',
                date: new Date().toLocaleDateString()
            });

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if (!s) { window.location.href = "index.html"; return; }
                const sess = JSON.parse(s);
                setSession(sess);

                // Load saved draft
                const saved = localStorage.getItem('isoPolicyDraft');
                if (saved) {
                    setFormData(JSON.parse(saved));
                } else {
                    setFormData(prev => ({
                        ...prev,
                        orgName: sess.orgName || '',
                        siteCode: sess.assignedSite || 'HQ'
                    }));
                }
            }, []);

            useEffect(() => {
                if (session) {
                    localStorage.setItem('isoPolicyDraft', JSON.stringify(formData));
                }
            }, [formData, session]);

            const exportPolicyPDF = () => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pW = pdf.internal.pageSize.getWidth();

                // Header
                pdf.setFillColor(30, 41, 59);
                pdf.rect(0, 0, pW, 35, 'F');
                pdf.setTextColor(255);
                pdf.setFontSize(20);
                pdf.setFont("helvetica", "bold");
                pdf.text("OCCUPATIONAL HEALTH & SAFETY POLICY", pW / 2, 20, { align: 'center' });
                pdf.setFontSize(10);
                pdf.text(formData.orgName || '[ORGANIZATION NAME]', pW / 2, 28, { align: 'center' });

                pdf.setTextColor(0);
                pdf.setFontSize(11);
                let y = 50;

                const sections = [
                    { title: "5.2(a) Safe & Healthy Working Conditions", text: formData.conditions },
                    { title: "5.2(b) Objectives Framework", text: formData.objectives },
                    { title: "5.2(c) Legal Compliance", text: formData.legal },
                    { title: "5.2(d) Hazard Elimination & Risk Reduction", text: formData.hazard },
                    { title: "5.2(e) Continual Improvement", text: formData.improvement },
                    { title: "5.2(f) Worker Consultation & Participation", text: formData.workers }
                ];

                sections.forEach(s => {
                    if (y > 250) { pdf.addPage(); y = 30; }
                    pdf.setFont("helvetica", "bold");
                    pdf.text(s.title, 20, y);
                    y += 7;
                    pdf.setFont("helvetica", "normal");
                    const lines = pdf.splitTextToSize(s.text || "No commitment entered.", pW - 40);
                    pdf.text(lines, 20, y);
                    y += (lines.length * 6) + 10;
                });

                // Signature
                y = Math.max(y, 240);
                pdf.line(20, y, 90, y);
                pdf.text("Authorized Signature", 20, y + 5);
                pdf.text(`Date: ${formData.date}`, pW - 50, y + 5);

                pdf.save(`${formData.siteCode || 'SITE'}-OH&S-Policy.pdf`);
            };

            const saveToArchive = () => {
                const arc = JSON.parse(localStorage.getItem('isoArchive')) || { drafts: [], approved: [] };
                arc.drafts.unshift({
                    ...formData,
                    companyName: formData.orgName,
                    version: 'DRAFT',
                    author: session?.user || 'Unknown',
                    role: session?.role || 'System',
                    timestamp: new Date().toLocaleString()
                });
                localStorage.setItem('isoArchive', JSON.stringify(arc));
                alert("Policy Draft saved to Archive!");
            };

            if (!session) return null;

            const PolicyInput = ({ label, id, icon, placeholder }) => (
                <div className="space-y-2">
                    <label className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                        <i className={`fas ${icon} text-blue-500`}></i> {label}
                    </label>
                    <textarea
                        className="w-full border-2 border-slate-200 p-4 rounded-xl bg-white focus:border-blue-500 outline-none transition-colors h-28 resize-none"
                        placeholder={placeholder}
                        value={formData[id]}
                        onChange={(e) => setFormData({ ...formData, [id]: e.target.value })}
                    />
                </div>
            );

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar */}
                    <aside className="w-72 bg-slate-900 text-white flex flex-col shadow-2xl">
                        <div className="p-6 border-b border-slate-700/50">
                            <div className="flex items-center gap-3 mb-4">
                                <a href="home.html" className="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center text-slate-400 hover:text-white transition-colors">
                                    <i className="fas fa-home text-sm"></i>
                                </a>
                                <div>
                                    <h1 className="text-lg font-bold">Policy Workstation</h1>
                                    <p className="text-[10px] text-blue-400 font-mono uppercase">Clause 5.2</p>
                                </div>
                            </div>
                        </div>

                        <div className="p-6 space-y-4 flex-1">
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Organization</label>
                                <input
                                    className="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-sm focus:border-blue-500 outline-none"
                                    placeholder="Organization Name"
                                    value={formData.orgName}
                                    onChange={e => setFormData({ ...formData, orgName: e.target.value })}
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Site Code</label>
                                <input
                                    className="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-sm font-mono uppercase focus:border-blue-500 outline-none"
                                    placeholder="SITE-01"
                                    value={formData.siteCode}
                                    onChange={e => setFormData({ ...formData, siteCode: e.target.value.toUpperCase() })}
                                />
                            </div>
                        </div>

                        <div className="p-6 border-t border-slate-700/50 space-y-3">
                            <button onClick={exportPolicyPDF} className="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold text-xs uppercase flex items-center justify-center gap-2 transition-colors">
                                <i className="fas fa-file-pdf"></i> Export Policy PDF
                            </button>
                            <button onClick={saveToArchive} className="w-full bg-orange-600 hover:bg-orange-500 py-4 rounded-xl font-bold text-xs uppercase flex items-center justify-center gap-2 transition-colors">
                                <i className="fas fa-save"></i> Save to Archive
                            </button>
                            <a href="archive.html" className="block text-center py-2 text-[10px] text-slate-500 hover:text-white transition-colors">
                                View Archive â†’
                            </a>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto bg-slate-50 p-8">
                        <div className="max-w-4xl mx-auto">
                            <div className="mb-8">
                                <h2 className="text-2xl font-bold text-slate-800">OH&S Policy Drafting</h2>
                                <p className="text-slate-500 text-sm mt-1">Define your organization's safety commitments aligned with ISO 45001 Clause 5.2 requirements.</p>
                            </div>

                            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-8 space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <PolicyInput
                                        label="5.2(a) Safe & Healthy Conditions"
                                        id="conditions"
                                        icon="fa-heart-pulse"
                                        placeholder="Commitment to provide safe and healthy working conditions for the prevention of work-related injury and ill health..."
                                    />
                                    <PolicyInput
                                        label="5.2(b) Objectives Framework"
                                        id="objectives"
                                        icon="fa-bullseye"
                                        placeholder="How the policy provides a framework for setting OH&S objectives..."
                                    />
                                    <PolicyInput
                                        label="5.2(c) Legal Compliance"
                                        id="legal"
                                        icon="fa-scale-balanced"
                                        placeholder="Commitment to fulfill legal requirements and other requirements..."
                                    />
                                    <PolicyInput
                                        label="5.2(d) Hazard Elimination"
                                        id="hazard"
                                        icon="fa-triangle-exclamation"
                                        placeholder="Commitment to eliminate hazards and reduce OH&S risks (refer to 8.1.2)..."
                                    />
                                    <PolicyInput
                                        label="5.2(e) Continual Improvement"
                                        id="improvement"
                                        icon="fa-chart-line"
                                        placeholder="Commitment to continual improvement of the OH&S management system..."
                                    />
                                    <PolicyInput
                                        label="5.2(f) Consultation & Participation"
                                        id="workers"
                                        icon="fa-comments"
                                        placeholder="Commitment to consultation and participation of workers, and representatives..."
                                    />
                                </div>

                                <div className="pt-6 border-t border-slate-100">
                                    <div className="flex items-center justify-between text-sm text-slate-500">
                                        <span>Auto-saved to local storage</span>
                                        <span className="flex items-center gap-2">
                                            <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                                            Draft saved
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
