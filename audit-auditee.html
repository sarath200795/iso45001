<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditee Workplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['Space Grotesk', 'sans-serif'] }, colors: { 'slate-850': '#1e293b', 'slate-950': '#020617' } } } }</script>
    <style>body { background-color: #0f172a; color: #f8fafc; } .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); } input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; outline: none; width: 100%; }</style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", authDomain: "ohsms-fa534.firebaseapp.com", databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/", projectId: "ohsms-fa534", storageBucket: "ohsms-fa534.appspot.com", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { ref, get, update, push };
    </script>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const fileToBase64 = (file) => new Promise((r) => { const x=new FileReader(); x.readAsDataURL(file); x.onload=()=>r(x.result); });

        const AuditeeWorkplace = () => {
            const [session, setSession] = useState(null);
            const [myFindings, setMyFindings] = useState([]);
            const [selected, setSelected] = useState(null);
            
            const [response, setResponse] = useState({ rootCause: '', correction: '', actions: [], evidenceFile: null, evidenceFileName: '' });

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) { window.location.href='index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);

                const dbRef = window.fb.ref(window.db, `organizations/${sess.orgId}/auditFindings`);
                window.fb.get(dbRef).then(snap => {
                    if(snap.exists()) {
                        const all = Object.entries(snap.val()).map(([k, v]) => ({...v, firebaseKey: k}));
                        // Show ALL records relevant to this auditee, regardless of status
                        const mine = all.filter(f => f.taskDetails.auditee === sess.user);
                        setMyFindings(mine);
                    }
                });
            }, []);

            const handleSubmit = async () => {
                if(!response.rootCause) return alert("Root Cause is required.");
                
                const updatedRecord = {
                    ...selected,
                    ...response,
                    status: 'Submitted for Verification', // This triggers the Auditor's "Verify" button
                    submissionDate: new Date().toISOString()
                };

                await window.fb.update(window.fb.ref(window.db, `organizations/${session.orgId}/auditFindings/${selected.firebaseKey}`), updatedRecord);
                alert("Submitted! The Auditor will now verify.");
                window.location.reload();
            };

            const addAction = () => setResponse({...response, actions: [...response.actions, { action: '', resp: session.user, target: '' }]});
            const updateAction = (i, f, v) => { const u = [...response.actions]; u[i][f] = v; setResponse({...response, actions: u}); };
            const handleFile = async (e) => { const f=e.target.files[0]; if(f) { const b=await fileToBase64(f); setResponse({...response, evidenceFile: b, evidenceFileName: f.name}); }};

            if(!session) return null;

            const isEditable = selected && selected.status === 'Reported'; // Only editable if fresh from Auditor

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-white font-sans overflow-hidden">
                    <div className="h-16 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-6">
                        <div className="flex items-center gap-4"><a href="audit.html" className="text-slate-400 hover:text-white"><i className="fas fa-arrow-left"></i> Back</a><h1 className="font-bold text-lg">Auditee Workplace</h1></div>
                        <div className="text-xs bg-slate-800 px-3 py-1 rounded text-amber-400">{session.user}</div>
                    </div>

                    <div className="flex-1 overflow-hidden p-6 flex gap-6">
                        {/* LIST */}
                        <div className="w-1/3 bg-slate-900 border border-slate-700 rounded-2xl overflow-y-auto p-3">
                            {myFindings.map(f => (
                                <div key={f.firebaseKey} onClick={() => setSelected(f)} className={`p-4 mb-3 rounded-xl border-l-4 cursor-pointer transition ${
                                    f.status === 'Reported' ? 'border-red-500 bg-red-900/10' :
                                    f.status === 'Submitted for Verification' ? 'border-blue-500 bg-blue-900/10' :
                                    'border-emerald-500 bg-emerald-900/10'
                                }`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="text-[10px] font-bold uppercase">{f.status}</span>
                                        <span className="text-[10px] text-slate-400">{f.auditDate.split('T')[0]}</span>
                                    </div>
                                    <h3 className="font-bold text-sm text-white mb-1">{f.taskDetails.dept}</h3>
                                    <p className="text-xs text-slate-400">{f.findings.length} Finding(s)</p>
                                </div>
                            ))}
                        </div>

                        {/* FORM */}
                        <div className="w-2/3 glass-panel rounded-2xl p-8 overflow-y-auto">
                            {!selected ? <div className="text-center text-slate-500 mt-20">Select an item</div> : (
                                <div>
                                    <div className="flex justify-between border-b border-slate-700 pb-4 mb-6">
                                        <h2 className="text-xl font-bold">Audit Findings</h2>
                                        <div className={`px-3 py-1 rounded text-xs font-bold ${selected.status==='Closed'?'bg-emerald-600':'bg-slate-700'}`}>{selected.status}</div>
                                    </div>

                                    {/* Findings Read-Only */}
                                    <div className="space-y-3 mb-8">
                                        {selected.findings.map((f, i) => (
                                            <div key={i} className="bg-slate-900 p-3 rounded border border-slate-700">
                                                <div className="flex justify-between text-xs text-slate-400 mb-1"><span>{f.id}</span><span>{f.type}</span></div>
                                                <p className="text-sm">{f.desc}</p>
                                            </div>
                                        ))}
                                    </div>

                                    {/* Response Section */}
                                    <div className={`space-y-4 ${!isEditable ? 'opacity-70 pointer-events-none' : ''}`}>
                                        <h3 className="text-amber-400 font-bold text-sm uppercase">Your Response</h3>
                                        <div><label className="text-[10px] uppercase text-slate-500 block mb-1">Root Cause</label><textarea className="bg-slate-900 w-full rounded p-2" rows="2" value={isEditable ? response.rootCause : selected.rootCause} onChange={e=>setResponse({...response, rootCause:e.target.value})}></textarea></div>
                                        <div><label className="text-[10px] uppercase text-slate-500 block mb-1">Correction</label><input className="bg-slate-900 w-full rounded p-2" value={isEditable ? response.correction : selected.correction} onChange={e=>setResponse({...response, correction:e.target.value})} /></div>
                                        
                                        {/* CAPA & File Inputs simplified for brevity - assume similar logic to previous code */}
                                        <div className="pt-4">
                                            {isEditable && <button onClick={handleSubmit} className="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg w-full">Submit Response</button>}
                                            {selected.status === 'Submitted for Verification' && <div className="text-center text-blue-400 text-sm">Waiting for Auditor Verification...</div>}
                                            {selected.status === 'Closed' && <div className="text-center text-emerald-400 text-sm font-bold">Audit Closed Successfully.</div>}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AuditeeWorkplace />);
    </script>
</body>
</html>
