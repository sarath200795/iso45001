<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create ISO 45001 Document</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; color: #333; }
        
        .section-title { font-size: 1.1em; font-weight: bold; margin-top: 20px; margin-bottom: 10px; color: #555; }
        
        .row { display: flex; gap: 20px; margin-bottom: 15px; }
        .col { flex: 1; }
        
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { resize: vertical; }
        
        /* Read-only fields styling */
        .auto-generated { background-color: #e9ecef; color: #495057; cursor: not-allowed; font-family: monospace; font-weight: bold; }

        .btn-group { margin-top: 20px; text-align: right; }
        button { padding: 10px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        .btn-save { background-color: #28a745; color: white; }
        .btn-cancel { background-color: #6c757d; color: white; margin-right: 10px; }
        
        .context-banner { background: #e2e6ea; padding: 10px; border-radius: 4px; margin-bottom: 20px; font-size: 0.9em; color: #333; }
    </style>
</head>
<body>

<div class="container">
    <h2>New OH&S Document Control</h2>

    <div class="context-banner" id="contextBanner">
        Loading Organization Context...
    </div>

    <form id="docForm">
        <div class="section-title">1. Document Identification</div>
        <div class="row">
            <div class="col">
                <label>ISO 45001 Clause (PDCA)</label>
                <select id="isoClause" onchange="generateDocRef()">
                    <option value="" disabled selected>Select Clause...</option>
                    <optgroup label="PLAN">
                        <option value="4.1">4.1 Context of the Organization</option>
                        <option value="4.2">4.2 Needs of Workers</option>
                        <option value="5.2">5.2 OH&S Policy</option>
                        <option value="6.1">6.1 Actions to address risks</option>
                    </optgroup>
                    <optgroup label="DO">
                        <option value="7.2">7.2 Competence</option>
                        <option value="7.5">7.5 Documented Information</option>
                        <option value="8.1">8.1 Operational Planning</option>
                        <option value="8.2">8.2 Emergency Preparedness</option>
                    </optgroup>
                    <optgroup label="CHECK">
                        <option value="9.1">9.1 Monitoring & Measurement</option>
                        <option value="9.2">9.2 Internal Audit</option>
                        <option value="9.3">9.3 Management Review</option>
                    </optgroup>
                    <optgroup label="ACT">
                        <option value="10.2">10.2 Incident & Nonconformity</option>
                        <option value="10.3">10.3 Continual Improvement</option>
                    </optgroup>
                </select>
            </div>
            <div class="col">
                <label>Document Reference ID (Auto-Generated)</label>
                <input type="text" id="docId" class="auto-generated" readonly>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>Document Title</label>
                <input type="text" id="docTitle" placeholder="e.g., Hazard Identification Procedure">
            </div>
            <div class="col">
                <label>Document Type</label>
                <select id="docType">
                    <option value="Procedure">Procedure</option>
                    <option value="Policy">Policy</option>
                    <option value="Work Instruction">Work Instruction</option>
                    <option value="Form/Checklist">Form / Checklist</option>
                    <option value="Manual">Manual</option>
                </select>
            </div>
        </div>

        <div class="section-title">2. Version & Control</div>
        <div class="row">
            <div class="col">
                <label>Revision Number</label>
                <input type="text" id="revNum" value="1.0">
            </div>
            <div class="col">
                <label>Issue Date</label>
                <input type="date" id="issueDate">
            </div>
            <div class="col">
                <label>Status</label>
                <select id="docStatus">
                    <option value="Draft">Draft</option>
                    <option value="Under Review">Under Review</option>
                    <option value="Released">Released</option>
                    <option value="Obsolete">Obsolete</option>
                </select>
            </div>
        </div>

        <div class="section-title">3. Responsibility</div>
        <div class="row">
            <div class="col">
                <label>Prepared By</label>
                <input type="text" id="preparedBy" placeholder="Name/Role">
            </div>
            <div class="col">
                <label>Approved By</label>
                <input type="text" id="approvedBy" placeholder="Name/Role (e.g. Site Manager)">
            </div>
        </div>

        <div class="section-title">4. Document Content</div>
        <div class="row">
            <div class="col">
                <textarea id="docContent" rows="12" placeholder="Enter the procedure text, scope, definitions, and responsibilities here..."></textarea>
            </div>
        </div>

        <div class="btn-group">
            <button type="button" class="btn-cancel" onclick="window.history.back()">Cancel</button>
            <button type="button" class="btn-save" onclick="saveDocument()">Save Document</button>
        </div>
    </form>
</div>

<script>
    // 1. GLOBAL CONTEXT VARIABLES
    let orgId = localStorage.getItem('orgId') || 'UNKNOWN_ORG';
    let siteId = localStorage.getItem('siteId') || 'UNKNOWN_SITE';

    // 2. INITIALIZATION
    window.onload = function() {
        // Display Context to user
        document.getElementById('contextBanner').innerText = 
            ` Creating Document for: Organization [${orgId}] - Site [${siteId}]`;
        
        // Set default date to today
        document.getElementById('issueDate').valueAsDate = new Date();
    };

    // 3. AUTO-NAMING LOGIC
    function generateDocRef() {
        const clause = document.getElementById('isoClause').value.replace('.', '');
        const typeShort = document.getElementById('docType').value.substring(0,3).toUpperCase();
        
        if(!clause) return;

        // Generate a random 4 digit suffix for uniqueness (in a real app, you'd fetch the next sequence number)
        const suffix = Math.floor(1000 + Math.random() * 9000);

        // FORMAT: ORG-SITE-TYPE-CLAUSE-SUFFIX
        // Example: GOOG-HYD4-PRO-ISO41-1023
        const ref = `${orgId}-${siteId}-${typeShort}-ISO${clause}-${suffix}`;
        
        document.getElementById('docId').value = ref;
    }

    // Listener for Doc Type change to update ID as well
    document.getElementById('docType').addEventListener('change', generateDocRef);

    // 4. SAVE FUNCTION
    function saveDocument() {
        const docId = document.getElementById('docId').value;
        if(!docId) { alert("Please select a clause to generate a Document ID."); return; }

        const newDoc = {
            id: docId,
            orgId: orgId,        // HIDDEN SAVED DATA
            siteId: siteId,      // HIDDEN SAVED DATA
            clause: document.getElementById('isoClause').value,
            title: document.getElementById('docTitle').value,
            type: document.getElementById('docType').value,
            revision: document.getElementById('revNum').value,
            date: document.getElementById('issueDate').value,
            status: document.getElementById('docStatus').value,
            preparedBy: document.getElementById('preparedBy').value,
            approvedBy: document.getElementById('approvedBy').value,
            content: document.getElementById('docContent').value,
            timestamp: new Date().toISOString()
        };

        // Get existing docs or init empty array
        let docs = JSON.parse(localStorage.getItem('isoDocuments')) || [];
        docs.push(newDoc);
        localStorage.setItem('isoDocuments', JSON.stringify(docs));

        alert('Document Saved Successfully!');
        window.location.href = 'index5.html'; // Go to list view
    }
</script>

</body>
</html>