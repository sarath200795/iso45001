<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Dashboard | OHSMS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Space Grotesk', 'sans-serif'] },
                    colors: { 'slate-850': '#1e293b', 'slate-950': '#020617' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .glass-panel { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .kpi-card { transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-5px); }
        input { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; width: 100%; outline: none; }
        input:focus { border-color: #3b82f6; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen">
    <div id="root" class="h-full"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, get, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", authDomain: "ohsms-fa534.firebaseapp.com", databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/", projectId: "ohsms-fa534", storageBucket: "ohsms-fa534.appspot.com", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { ref, push, get, update, remove };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const KPICard = ({ title, value, subtext, color, icon }) => (
            <div className={`glass-panel p-6 rounded-xl border-l-4 ${color} kpi-card relative overflow-hidden`}>
                <div className="flex justify-between items-start z-10 relative">
                    <div>
                        <p className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">{title}</p>
                        <h3 className="text-3xl font-bold text-white">{value}</h3>
                        <p className="text-[10px] text-slate-500 mt-2">{subtext}</p>
                    </div>
                    <div className={`text-2xl opacity-20 p-2 rounded-lg bg-white/5`}>{icon}</div>
                </div>
            </div>
        );

        const Dashboard = () => {
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            const [incidents, setIncidents] = useState([]);
            const [manHours, setManHours] = useState([]);
            
            // --- DATE FILTER STATE ---
            const [filterStart, setFilterStart] = useState(new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0]);
            const [filterEnd, setFilterEnd] = useState(new Date().toISOString().split('T')[0]);

            // Man Hour Logging Form
            const [logDate, setLogDate] = useState(new Date().toISOString().split('T')[0]);
            const [permHours, setPermHours] = useState(0);
            const [contHours, setContHours] = useState(0);

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) { window.location.href='index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);

                const fetchData = async () => {
                    const snap = await window.fb.get(window.fb.ref(window.db, `organizations/${sess.orgId}`));
                    if(snap.exists()) {
                        const val = snap.val();
                        if(val.incidents) setIncidents(Object.values(val.incidents));
                        if(val.manHours) setManHours(Object.values(val.manHours));
                    }
                    setLoading(false);
                };
                fetchData();
            }, []);

            // --- FILTERING ---
            const filteredIncidents = useMemo(() => {
                if (!filterStart || !filterEnd) return incidents;
                return incidents.filter(i => i.date >= filterStart && i.date <= filterEnd);
            }, [incidents, filterStart, filterEnd]);

            const filteredManHours = useMemo(() => {
                if (!filterStart || !filterEnd) return manHours;
                return manHours.filter(m => m.date >= filterStart && m.date <= filterEnd);
            }, [manHours, filterStart, filterEnd]);

            // --- CALCULATIONS ---
            const stats = useMemo(() => {
                const totalManHours = filteredManHours.reduce((acc, curr) => acc + parseFloat(curr.perm || 0) + parseFloat(curr.cont || 0), 0) || 1;
                
                const nearMiss = filteredIncidents.filter(i => i.type === 'Near Miss').length;
                const firstAid = filteredIncidents.filter(i => i.type === 'First Aid injury').length;
                const lti = filteredIncidents.filter(i => i.type === 'Lost Time injury').length;
                const recordable = filteredIncidents.filter(i => ['Lost Time injury', 'Reportable Injury'].includes(i.type)).length;

                const calcRate = (count) => ((count * 200000) / totalManHours).toFixed(2);

                let totalActions = 0;
                let closedActions = 0;
                filteredIncidents.forEach(inc => {
                    if(inc.capa) {
                        inc.capa.forEach(c => {
                            totalActions++;
                            if(c.status === 'Closed') closedActions++;
                        });
                    }
                });
                const closureRate = totalActions === 0 ? 100 : Math.round((closedActions / totalActions) * 100);

                const totalPerm = filteredManHours.reduce((acc, curr) => acc + parseFloat(curr.perm || 0), 0);
                const totalCont = filteredManHours.reduce((acc, curr) => acc + parseFloat(curr.cont || 0), 0);
                const permPercent = totalManHours > 1 ? Math.round((totalPerm / totalManHours) * 100) : 0;
                const contPercent = totalManHours > 1 ? Math.round((totalCont / totalManHours) * 100) : 0;

                return {
                    nmr: calcRate(nearMiss),
                    fair: calcRate(firstAid),
                    ltir: calcRate(lti),
                    rir: calcRate(recordable),
                    capa: closureRate,
                    totalHours: totalManHours,
                    permPercent,
                    contPercent
                };
            }, [filteredIncidents, filteredManHours]);

            const handleLogHours = async () => {
                if(permHours < 0 || contHours < 0) return alert("Hours cannot be negative");
                if(permHours == 0 && contHours == 0) return alert("Please enter hours");

                const newLog = {
                    date: logDate,
                    perm: parseFloat(permHours),
                    cont: parseFloat(contHours),
                    loggedBy: session.user,
                    timestamp: new Date().toISOString()
                };

                await window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/manHours`), newLog);
                alert("Man Hours Logged!");
                setManHours([...manHours, newLog]);
                setPermHours(0);
                setContHours(0);
            };

            // --- CHART ---
            useEffect(() => {
                if(!loading) {
                    const ctx = document.getElementById('trendChart');
                    if(ctx) {
                        if(window.myChart) window.myChart.destroy();
                        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                        const monthlyCounts = new Array(12).fill(0);
                        filteredIncidents.forEach(inc => {
                            const d = new Date(inc.date);
                            monthlyCounts[d.getMonth()]++;
                        });

                        window.myChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: months,
                                datasets: [{
                                    label: 'Incidents in Period',
                                    data: monthlyCounts,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: { beginAtZero: true, grid: { color: '#1e293b' }, ticks: { color: '#94a3b8' } },
                                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                                }
                            }
                        });
                    }
                }
            }, [loading, filteredIncidents]);

            if(loading) return <div className="flex h-screen items-center justify-center text-white text-xl font-bold animate-pulse">Loading Dashboard...</div>;

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-white font-sans overflow-hidden">
                    {/* Header */}
                    <div className="h-16 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-6">
                        <div className="flex items-center gap-4">
                            <a href="home.html" className="text-slate-400 hover:text-white flex items-center gap-2 transition-colors"><i className="fas fa-arrow-left"></i> Back</a>
                            <div className="h-6 w-px bg-slate-700 mx-2"></div>
                            <h1 className="font-bold text-lg tracking-tight">Safety Dashboard</h1>
                        </div>
                        <div className="flex items-center gap-4">
                            <span className="text-xs text-slate-400 bg-slate-800 px-3 py-1 rounded-full border border-slate-700">User: <b className="text-white">{session.user}</b></span>
                        </div>
                    </div>

                    {/* Main Content (Full Width) */}
                    <div className="flex-1 overflow-y-auto p-8 custom-scroll">
                        <div className="max-w-7xl mx-auto">
                            
                            {/* --- DATE FILTER BAR --- */}
                            <div className="glass-panel p-4 rounded-xl mb-8 flex justify-between items-center border border-slate-700">
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400"><i className="fas fa-filter"></i></div>
                                    <div><h3 className="font-bold text-white text-sm">Dashboard Filter</h3><p className="text-[10px] text-slate-400">Date Range for KPIs & Charts</p></div>
                                </div>
                                <div className="flex gap-4 items-center">
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 font-bold uppercase">From</label><input type="date" value={filterStart} onChange={e=>setFilterStart(e.target.value)} className="bg-slate-900 border-slate-700 py-1" /></div>
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 font-bold uppercase">To</label><input type="date" value={filterEnd} onChange={e=>setFilterEnd(e.target.value)} className="bg-slate-900 border-slate-700 py-1" /></div>
                                </div>
                            </div>

                            {/* KPI Grid */}
                            <h3 className="text-xl font-bold text-white mb-6">Key Performance Indicators</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8">
                                <KPICard title="NMR (Near Miss Rate)" value={stats.nmr} subtext="Per 200k Hours" color="border-yellow-500" icon={<i className="fas fa-exclamation"></i>} />
                                <KPICard title="FAIR (First Aid Rate)" value={stats.fair} subtext="Per 200k Hours" color="border-blue-500" icon={<i className="fas fa-user-nurse"></i>} />
                                <KPICard title="LTIR (Lost Time Rate)" value={stats.ltir} subtext="Per 200k Hours" color="border-red-500" icon={<i className="fas fa-crutch"></i>} />
                                <KPICard title="RIR (Recordable Rate)" value={stats.rir} subtext="OSHA Recordables" color="border-orange-500" icon={<i className="fas fa-file-medical"></i>} />
                                <div className="glass-panel p-6 rounded-xl border-l-4 border-emerald-500 relative overflow-hidden">
                                    <div className="flex justify-between items-start z-10 relative">
                                        <div>
                                            <p className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">CAPA Closure</p>
                                            <h3 className="text-3xl font-bold text-emerald-400">{stats.capa}%</h3>
                                            <p className="text-[10px] text-slate-500 mt-2">Action Effectiveness</p>
                                        </div>
                                        <div className="text-2xl text-emerald-500/20"><i className="fas fa-check-circle"></i></div>
                                    </div>
                                    <div className="absolute bottom-0 left-0 h-1 bg-emerald-500/30 w-full"><div className="h-full bg-emerald-500" style={{width: `${stats.capa}%`}}></div></div>
                                </div>
                            </div>

                            {/* Charts & Man Hours Row */}
                            <div className="grid grid-cols-3 gap-6 mb-8">
                                <div className="col-span-2 glass-panel p-6 rounded-xl border border-slate-700">
                                    <h4 className="text-sm font-bold text-slate-400 uppercase mb-4">Incident Trend (Selected Range)</h4>
                                    <div className="h-64">
                                        <canvas id="trendChart"></canvas>
                                    </div>
                                </div>
                                <div className="glass-panel p-6 rounded-xl border border-slate-700">
                                    <h4 className="text-sm font-bold text-slate-400 uppercase mb-4">Total Man-Hours</h4>
                                    <div className="flex items-center justify-center h-48 flex-col">
                                        <span className="text-5xl font-bold text-white mb-2">{Math.round(stats.totalHours).toLocaleString()}</span>
                                        <span className="text-sm text-slate-500 bg-slate-900 px-3 py-1 rounded-full">Cumulative Hours</span>
                                    </div>
                                    <div className="border-t border-slate-700 pt-4 mt-2">
                                        <div className="flex justify-between text-xs text-slate-400 mb-1"><span>Permanent Staff</span><span>{stats.permPercent}%</span></div>
                                        <div className="w-full bg-slate-800 rounded-full h-1.5 mb-3"><div className="bg-blue-500 h-1.5 rounded-full" style={{width: `${stats.permPercent}%`}}></div></div>
                                        <div className="flex justify-between text-xs text-slate-400 mb-1"><span>Contractors</span><span>{stats.contPercent}%</span></div>
                                        <div className="w-full bg-slate-800 rounded-full h-1.5"><div className="bg-purple-500 h-1.5 rounded-full" style={{width: `${stats.contPercent}%`}}></div></div>
                                    </div>
                                </div>
                            </div>

                            {/* Man Hour Logger */}
                            <div className="glass-panel p-6 rounded-xl flex items-end gap-4 border-l-4 border-purple-500">
                                <div className="flex-1">
                                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><i className="fas fa-clock text-purple-400"></i> Daily Man-Hour Log</h3>
                                    <div className="flex gap-4">
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Date</label>
                                            <input type="date" value={logDate} onChange={e=>setLogDate(e.target.value)} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Permanent Staff (Hrs)</label>
                                            <input type="number" value={permHours} onChange={e=>setPermHours(e.target.value)} placeholder="0" />
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Contractor (Hrs)</label>
                                            <input type="number" value={contHours} onChange={e=>setContHours(e.target.value)} placeholder="0" />
                                        </div>
                                    </div>
                                </div>
                                <button onClick={handleLogHours} className="bg-purple-600 hover:bg-purple-500 text-white font-bold px-6 py-3 rounded-lg h-[42px] mb-px shadow-lg transition transform active:scale-95">Log Hours</button>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
