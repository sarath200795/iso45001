<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO 45001 | Performance & Improvement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Space Grotesk', sans-serif; }</style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const getContext = () => {
            const sess = JSON.parse(sessionStorage.getItem('isoSession') || '{}');
            return { org: sess.orgId || 'ORG', site: sess.assignedSite || 'SITE', name: sess.orgName || 'Organization' };
        };

        const generateReportPDF = (title, data, columns) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            const ctx = getContext();
            doc.setFillColor(220, 38, 38);
            doc.rect(0, 0, 300, 20, 'F');
            doc.setTextColor(255);
            doc.setFontSize(14);
            doc.text(title.toUpperCase(), 14, 13);
            doc.setFontSize(10);
            doc.text(`${ctx.org} - ${ctx.site}`, 280, 13, { align: 'right' });
            doc.autoTable({ startY: 25, head: [columns], body: data, theme: 'grid', headStyles: { fillColor: [50, 50, 50] } });
            doc.save(`${ctx.org}-${ctx.site}-${title.replace(/\s/g, '_')}.pdf`);
        };

        const App = () => {
            const [session, setSession] = useState(null);
            const [view, setView] = useState('dashboard');
            const ctx = getContext();

            const [incidents, setIncidents] = useState(() => JSON.parse(localStorage.getItem('isoIncidents')) || []);
            const [newIncident, setNewIncident] = useState({ date: '', type: 'Near Miss', location: '', desc: '', rootCause: '', action: '', status: 'Open' });

            const [audits, setAudits] = useState(() => JSON.parse(localStorage.getItem('isoAudits')) || []);
            const [newAudit, setNewAudit] = useState({ date: '', area: '', auditor: '', findings: '', type: 'Internal', status: 'Scheduled' });

            const [improvements, setImprovements] = useState(() => JSON.parse(localStorage.getItem('isoImprovements')) || []);
            const [newImprovement, setNewImprovement] = useState({ source: 'Risk Assessment', desc: '', benefit: '', owner: '', status: 'Proposed' });

            useEffect(() => { const s = sessionStorage.getItem('isoSession'); if (!s) { window.location.href = "index.html"; return; } setSession(JSON.parse(s)); }, []);
            useEffect(() => localStorage.setItem('isoIncidents', JSON.stringify(incidents)), [incidents]);
            useEffect(() => localStorage.setItem('isoAudits', JSON.stringify(audits)), [audits]);
            useEffect(() => localStorage.setItem('isoImprovements', JSON.stringify(improvements)), [improvements]);

            const addIncident = () => { if (!newIncident.desc) return alert("Description required"); setIncidents([{ ...newIncident, id: Date.now() }, ...incidents]); setNewIncident({ date: '', type: 'Near Miss', location: '', desc: '', rootCause: '', action: '', status: 'Open' }); };
            const addAudit = () => { if (!newAudit.area) return alert("Area required"); setAudits([{ ...newAudit, id: Date.now() }, ...audits]); setNewAudit({ date: '', area: '', auditor: '', findings: '', type: 'Internal', status: 'Scheduled' }); };
            const addImprovement = () => { if (!newImprovement.desc) return alert("Description required"); setImprovements([{ ...newImprovement, id: Date.now() }, ...improvements]); setNewImprovement({ source: 'Risk Assessment', desc: '', benefit: '', owner: '', status: 'Proposed' }); };
            const deleteItem = (setList, list, id) => { if (confirm("Delete?")) setList(list.filter(i => i.id !== id)); };

            const stats = useMemo(() => ({
                incidentsOpen: incidents.filter(i => i.status === 'Open' || i.status === 'Investigating').length,
                auditsDue: audits.filter(a => a.status === 'Scheduled').length,
                improvementsActive: improvements.filter(i => i.status === 'In Progress' || i.status === 'Proposed').length
            }), [incidents, audits, improvements]);

            if (!session) return null;

            const NavButton = ({ id, icon, label, clause }) => (
                <button onClick={() => setView(id)} className={`w-full text-left p-4 rounded-xl font-medium flex items-center gap-3 transition-all ${view === id ? 'bg-red-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-700/50'}`}>
                    <i className={`fas ${icon} w-5 text-center`}></i>
                    <div><span className="block">{label}</span>{clause && <span className="text-[9px] opacity-60">{clause}</span>}</div>
                </button>
            );

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="w-64 bg-slate-900 text-white flex flex-col shadow-2xl">
                        <div className="p-6 border-b border-slate-700/50">
                            <div className="flex items-center gap-3">
                                <a href="home.html" className="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center text-slate-400 hover:text-white transition-colors"><i className="fas fa-home text-sm"></i></a>
                                <div><h1 className="text-lg font-bold">Performance</h1><p className="text-[10px] text-red-400 font-mono uppercase">Check & Act</p></div>
                            </div>
                            <div className="mt-4 text-[10px] bg-slate-800/50 p-3 rounded-xl text-center font-mono text-slate-400">{ctx.org} / {ctx.site}</div>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <NavButton id="dashboard" icon="fa-chart-pie" label="Dashboard" />
                            <div className="pt-3 pb-1 text-[9px] font-bold text-slate-500 uppercase px-4">Clause 10.2</div>
                            <NavButton id="incidents" icon="fa-exclamation-triangle" label="Incident Report" />
                            <div className="pt-3 pb-1 text-[9px] font-bold text-slate-500 uppercase px-4">Clause 9.2</div>
                            <NavButton id="audits" icon="fa-clipboard-check" label="Internal Audit" />
                            <div className="pt-3 pb-1 text-[9px] font-bold text-slate-500 uppercase px-4">Clause 10.3</div>
                            <NavButton id="improvement" icon="fa-rocket" label="Continual Improv." />
                        </nav>
                        <div className="p-4 border-t border-slate-700/50">
                            <a href="home.html" className="block w-full text-center py-3 text-xs font-medium text-slate-500 hover:text-white transition-colors"><i className="fas fa-arrow-left mr-2"></i>Back to Home</a>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-y-auto bg-slate-50 p-8">
                        {view === 'dashboard' && (
                            <div className="max-w-6xl mx-auto space-y-8">
                                <div><h2 className="text-2xl font-bold text-slate-800">Performance Overview</h2><p className="text-slate-500 text-sm">Live metrics for Incident, Audit, and Improvement workflows.</p></div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-white p-6 rounded-2xl border-l-4 border-orange-500 shadow-sm"><div className="flex justify-between"><div><p className="text-xs font-bold text-slate-400 uppercase">Open Incidents</p><p className="text-4xl font-bold text-slate-800 mt-2">{stats.incidentsOpen}</p></div><div className="w-12 h-12 bg-orange-50 rounded-xl flex items-center justify-center text-orange-500"><i className="fas fa-exclamation-circle text-xl"></i></div></div></div>
                                    <div className="bg-white p-6 rounded-2xl border-l-4 border-blue-500 shadow-sm"><div className="flex justify-between"><div><p className="text-xs font-bold text-slate-400 uppercase">Scheduled Audits</p><p className="text-4xl font-bold text-slate-800 mt-2">{stats.auditsDue}</p></div><div className="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center text-blue-500"><i className="fas fa-calendar-check text-xl"></i></div></div></div>
                                    <div className="bg-white p-6 rounded-2xl border-l-4 border-emerald-500 shadow-sm"><div className="flex justify-between"><div><p className="text-xs font-bold text-slate-400 uppercase">Active Improvements</p><p className="text-4xl font-bold text-slate-800 mt-2">{stats.improvementsActive}</p></div><div className="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-500"><i className="fas fa-lightbulb text-xl"></i></div></div></div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"><h3 className="font-bold text-slate-700 mb-4 border-b pb-2">Recent Incidents</h3>{incidents.slice(0, 5).map(i => (<div key={i.id} className="flex justify-between text-sm py-3 border-b last:border-0"><span className="text-slate-600">{i.type} at {i.location}</span><span className={`font-bold text-xs px-2 py-1 rounded ${i.status === 'Open' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>{i.status}</span></div>))}{incidents.length === 0 && <p className="text-sm text-slate-400 italic">No incidents recorded.</p>}</div>
                                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"><h3 className="font-bold text-slate-700 mb-4 border-b pb-2">Upcoming Audits</h3>{audits.filter(a => a.status === 'Scheduled').slice(0, 5).map(a => (<div key={a.id} className="flex justify-between text-sm py-3 border-b last:border-0"><span className="text-slate-600">{a.area} ({a.type})</span><span className="font-mono text-xs text-blue-500">{a.date}</span></div>))}{audits.filter(a => a.status === 'Scheduled').length === 0 && <p className="text-sm text-slate-400 italic">No audits scheduled.</p>}</div>
                                </div>
                            </div>
                        )}

                        {view === 'incidents' && (
                            <div className="max-w-6xl mx-auto space-y-6">
                                <div className="flex justify-between items-center"><div><h2 className="text-2xl font-bold text-slate-800">Incident & Non-Conformity Log</h2><p className="text-slate-500 text-sm">Clause 10.2 - Record and investigate incidents.</p></div><button onClick={() => generateReportPDF('Incident_Log', incidents.map(i => [i.date, i.type, i.location, i.desc, i.status]), ['Date', 'Type', 'Location', 'Description', 'Status'])} className="bg-slate-800 text-white px-5 py-3 rounded-xl text-xs font-bold hover:bg-slate-700 flex items-center gap-2"><i className="fas fa-download"></i>Export PDF</button></div>
                                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <input type="date" className="p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none" value={newIncident.date} onChange={e => setNewIncident({ ...newIncident, date: e.target.value })} />
                                        <select className="p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none bg-white" value={newIncident.type} onChange={e => setNewIncident({ ...newIncident, type: e.target.value })}><option>Near Miss</option><option>First Aid</option><option>Lost Time Injury</option><option>Property Damage</option><option>Environmental</option></select>
                                        <input placeholder="Location" className="p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none" value={newIncident.location} onChange={e => setNewIncident({ ...newIncident, location: e.target.value })} />
                                        <select className="p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none bg-white" value={newIncident.status} onChange={e => setNewIncident({ ...newIncident, status: e.target.value })}><option>Open</option><option>Investigating</option><option>Closed</option></select>
                                    </div>
                                    <textarea placeholder="Description of Incident" className="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none h-24" value={newIncident.desc} onChange={e => setNewIncident({ ...newIncident, desc: e.target.value })}></textarea>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <textarea placeholder="Root Cause Analysis (e.g. 5 Whys)" className="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none h-20" value={newIncident.rootCause} onChange={e => setNewIncident({ ...newIncident, rootCause: e.target.value })}></textarea>
                                        <textarea placeholder="Corrective Action" className="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none h-20" value={newIncident.action} onChange={e => setNewIncident({ ...newIncident, action: e.target.value })}></textarea>
                                    </div>
                                    <button onClick={addIncident} className="w-full bg-red-600 hover:bg-red-500 text-white py-4 rounded-xl font-bold uppercase tracking-wider transition-colors">Log Incident</button>
                                </div>
                                <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-100"><tr><th className="p-4 font-bold text-slate-500 text-xs uppercase">Date</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Type</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Description</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Action</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Status</th><th className="p-4"></th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {incidents.map(i => (<tr key={i.id} className="hover:bg-slate-50"><td className="p-4 font-mono text-xs text-slate-500">{i.date}</td><td className="p-4"><span className="font-bold text-slate-700">{i.type}</span><div className="text-xs text-slate-400">{i.location}</div></td><td className="p-4 text-slate-600 max-w-xs truncate">{i.desc}</td><td className="p-4 text-slate-500 max-w-xs truncate">{i.action || '-'}</td><td className="p-4"><span className={`px-3 py-1 rounded-lg text-xs font-bold ${i.status === 'Closed' ? 'bg-emerald-50 text-emerald-600' : 'bg-orange-50 text-orange-600'}`}>{i.status}</span></td><td className="p-4"><button onClick={() => deleteItem(setIncidents, incidents, i.id)} className="text-slate-300 hover:text-red-500"><i className="fas fa-trash"></i></button></td></tr>))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {view === 'audits' && (
                            <div className="max-w-6xl mx-auto space-y-6">
                                <div className="flex justify-between items-center"><div><h2 className="text-2xl font-bold text-slate-800">Internal Audit Programme</h2><p className="text-slate-500 text-sm">Clause 9.2 - Plan and conduct internal audits.</p></div><button onClick={() => generateReportPDF('Audit_Schedule', audits.map(a => [a.date, a.area, a.type, a.auditor, a.status]), ['Date', 'Area', 'Type', 'Auditor', 'Status'])} className="bg-slate-800 text-white px-5 py-3 rounded-xl text-xs font-bold hover:bg-slate-700 flex items-center gap-2"><i className="fas fa-download"></i>Export PDF</button></div>
                                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                        <input type="date" className="p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none" value={newAudit.date} onChange={e => setNewAudit({ ...newAudit, date: e.target.value })} />
                                        <input placeholder="Area / Process" className="p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none" value={newAudit.area} onChange={e => setNewAudit({ ...newAudit, area: e.target.value })} />
                                        <select className="p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none bg-white" value={newAudit.type} onChange={e => setNewAudit({ ...newAudit, type: e.target.value })}><option>Internal</option><option>External</option><option>Walkthrough</option></select>
                                        <input placeholder="Auditor Name" className="p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none" value={newAudit.auditor} onChange={e => setNewAudit({ ...newAudit, auditor: e.target.value })} />
                                        <select className="p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none bg-white" value={newAudit.status} onChange={e => setNewAudit({ ...newAudit, status: e.target.value })}><option>Scheduled</option><option>Completed</option><option>Overdue</option></select>
                                    </div>
                                    <textarea placeholder="Audit Findings / Non-Conformities Summary" className="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none h-20" value={newAudit.findings} onChange={e => setNewAudit({ ...newAudit, findings: e.target.value })}></textarea>
                                    <button onClick={addAudit} className="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold uppercase tracking-wider transition-colors">Schedule Audit</button>
                                </div>
                                <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-100"><tr><th className="p-4 font-bold text-slate-500 text-xs uppercase">Date</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Area</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Auditor</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Findings</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Status</th><th className="p-4"></th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {audits.map(a => (<tr key={a.id} className="hover:bg-slate-50"><td className="p-4 font-mono text-xs text-slate-500">{a.date}</td><td className="p-4"><span className="font-bold text-slate-700">{a.area}</span><div className="text-xs text-slate-400">{a.type}</div></td><td className="p-4 text-xs">{a.auditor}</td><td className="p-4 text-slate-500 max-w-xs truncate italic">{a.findings || 'No findings'}</td><td className="p-4"><span className={`px-3 py-1 rounded-lg text-xs font-bold ${a.status === 'Completed' ? 'bg-emerald-50 text-emerald-600' : a.status === 'Overdue' ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}`}>{a.status}</span></td><td className="p-4"><button onClick={() => deleteItem(setAudits, audits, a.id)} className="text-slate-300 hover:text-red-500"><i className="fas fa-trash"></i></button></td></tr>))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {view === 'improvement' && (
                            <div className="max-w-6xl mx-auto space-y-6">
                                <div className="flex justify-between items-center"><div><h2 className="text-2xl font-bold text-slate-800">Continual Improvement Register</h2><p className="text-slate-500 text-sm">Clause 10.3 - Track improvement opportunities.</p></div><button onClick={() => generateReportPDF('CI_Register', improvements.map(i => [i.source, i.desc, i.benefit, i.owner, i.status]), ['Source', 'Idea', 'Benefit', 'Owner', 'Status'])} className="bg-slate-800 text-white px-5 py-3 rounded-xl text-xs font-bold hover:bg-slate-700 flex items-center gap-2"><i className="fas fa-download"></i>Export PDF</button></div>
                                <div className="bg-white p-6 rounded-2xl border-l-4 border-emerald-500 shadow-sm space-y-4">
                                    <h3 className="font-bold text-emerald-700 text-sm uppercase">Log New Opportunity</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <select className="p-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none bg-white" value={newImprovement.source} onChange={e => setNewImprovement({ ...newImprovement, source: e.target.value })}><option>Risk Assessment</option><option>Employee Suggestion</option><option>Audit Finding</option><option>Incident Review</option><option>Management Review</option></select>
                                        <input placeholder="Owner / Champion" className="p-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none" value={newImprovement.owner} onChange={e => setNewImprovement({ ...newImprovement, owner: e.target.value })} />
                                        <select className="p-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none bg-white" value={newImprovement.status} onChange={e => setNewImprovement({ ...newImprovement, status: e.target.value })}><option>Proposed</option><option>In Progress</option><option>Implemented</option><option>Effectiveness Verified</option></select>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <textarea placeholder="Description of Improvement Opportunity" className="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none h-24" value={newImprovement.desc} onChange={e => setNewImprovement({ ...newImprovement, desc: e.target.value })}></textarea>
                                        <textarea placeholder="Expected Benefit (Safety/Efficiency)" className="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none h-24" value={newImprovement.benefit} onChange={e => setNewImprovement({ ...newImprovement, benefit: e.target.value })}></textarea>
                                    </div>
                                    <button onClick={addImprovement} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-4 rounded-xl font-bold uppercase tracking-wider transition-colors">Register Improvement</button>
                                </div>
                                <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-100"><tr><th className="p-4 font-bold text-slate-500 text-xs uppercase">Source</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Opportunity</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Benefit</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Owner</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Status</th><th className="p-4"></th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {improvements.map(i => (<tr key={i.id} className="hover:bg-slate-50"><td className="p-4 text-xs font-bold text-slate-500">{i.source}</td><td className="p-4 font-bold text-slate-700">{i.desc}</td><td className="p-4 text-xs italic text-slate-600">{i.benefit}</td><td className="p-4 text-xs">{i.owner}</td><td className="p-4"><span className={`px-3 py-1 rounded-lg text-xs font-bold ${i.status === 'Implemented' || i.status === 'Effectiveness Verified' ? 'bg-emerald-50 text-emerald-600' : i.status === 'Proposed' ? 'bg-purple-50 text-purple-600' : 'bg-blue-50 text-blue-600'}`}>{i.status}</span></td><td className="p-4"><button onClick={() => deleteItem(setImprovements, improvements, i.id)} className="text-slate-300 hover:text-red-500"><i className="fas fa-trash"></i></button></td></tr>))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
