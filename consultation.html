<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultation & Participation</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { 'slate-850': '#1e293b', 'slate-950': '#020617' } }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; outline: none; width: 100%; }
        input:focus, select:focus, textarea:focus { border-color: #3b82f6; }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, push, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", 
            authDomain: "ohsms-fa534.firebaseapp.com",
            databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/",
            projectId: "ohsms-fa534",
            storageBucket: "ohsms-fa534.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { ref, get, push, update };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const MEETING_TYPES = [
            "Committee Meeting", "Incident Investigation", "Policy Decision", 
            "Objective & Targets", "Legal Aspects", "Continual Improvement Plans", "Program Management"
        ];

        // --- COMPONENT: NEW MEETING FORM ---
        const MeetingForm = ({ siteId, onSave }) => {
            const [data, setData] = useState({
                interaction: 'Consultation', category: 'Committee Meeting', date: '', time: '', agenda: '',
                minutes: []
            });

            const addRow = () => setData({...data, minutes: [...data.minutes, { point:'', action:'', owner:'', dept:'', due:'', status:'Open' }]});
            
            const updateRow = (idx, field, val) => {
                const rows = [...data.minutes]; rows[idx][field] = val;
                setData({...data, minutes: rows});
            };

            const removeRow = (idx) => {
                const rows = data.minutes.filter((_,i) => i!==idx);
                setData({...data, minutes: rows});
            };

            const handleSubmit = () => {
                if(!data.date || !data.agenda) { alert("Please fill required fields"); return; }
                onSave(data);
            };

            return (
                <div className="animate-fade-in space-y-6">
                    <div className="glass-panel p-6 rounded-2xl">
                        <h3 className="text-blue-400 font-bold mb-4 uppercase text-sm border-b border-white/10 pb-2">1. Meeting Info</h3>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div><label className="text-xs text-slate-400">Interaction Type</label><select value={data.interaction} onChange={e=>setData({...data, interaction:e.target.value})}><option>Consultation</option><option>Participation</option></select></div>
                            <div><label className="text-xs text-slate-400">Meeting Name</label><select value={data.category} onChange={e=>setData({...data, category:e.target.value})}>{MEETING_TYPES.map(t=><option key={t}>{t}</option>)}</select></div>
                            <div><label className="text-xs text-slate-400">Date</label><input type="date" value={data.date} onChange={e=>setData({...data, date:e.target.value})} /></div>
                            <div><label className="text-xs text-slate-400">Time</label><input type="time" value={data.time} onChange={e=>setData({...data, time:e.target.value})} /></div>
                        </div>
                        <div><label className="text-xs text-slate-400">Agenda</label><textarea rows="2" value={data.agenda} onChange={e=>setData({...data, agenda:e.target.value})} placeholder="Purpose of meeting..."></textarea></div>
                    </div>

                    <div className="glass-panel p-6 rounded-2xl">
                        <div className="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                            <h3 className="text-purple-400 font-bold uppercase text-sm">2. Minutes of Meeting (MOM) & Actions</h3>
                            <button onClick={addRow} className="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded transition">+ Add Point</button>
                        </div>
                        {data.minutes.map((row, i) => (
                            <div key={i} className="grid grid-cols-1 md:grid-cols-12 gap-2 mb-4 bg-slate-800/50 p-3 rounded border border-slate-700 relative group">
                                <div className="md:col-span-3"><input placeholder="Discussion Point" value={row.point} onChange={e=>updateRow(i,'point',e.target.value)} /></div>
                                <div className="md:col-span-3"><input placeholder="Action Required" value={row.action} onChange={e=>updateRow(i,'action',e.target.value)} /></div>
                                <div className="md:col-span-2"><input placeholder="Responsible Person" value={row.owner} onChange={e=>updateRow(i,'owner',e.target.value)} /></div>
                                <div className="md:col-span-2"><input placeholder="Department" value={row.dept} onChange={e=>updateRow(i,'dept',e.target.value)} /></div>
                                <div className="md:col-span-2"><input type="date" value={row.due} onChange={e=>updateRow(i,'due',e.target.value)} /></div>
                                <button onClick={()=>removeRow(i)} className="absolute -top-2 -right-2 bg-red-500 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition">x</button>
                            </div>
                        ))}
                        {data.minutes.length === 0 && <p className="text-slate-500 text-center text-sm italic py-4">No minutes recorded yet.</p>}
                    </div>

                    <div className="flex justify-end">
                        <button onClick={handleSubmit} className="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition">Save Meeting Record</button>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: MEETING CARDS ---
        const MeetingList = ({ meetings }) => {
            const formatDate = (dateStr) => {
                if(!dateStr) return '';
                return new Date(dateStr).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
            };

            const getStatus = (minutes) => {
                if(!minutes) return { label: 'No Actions', color: 'text-slate-400' };
                const pending = minutes.filter(m => m.status !== 'Closed').length;
                return pending > 0 
                    ? { label: `${pending} Pending Points`, color: 'text-orange-400' }
                    : { label: 'All Closed', color: 'text-emerald-400' };
            };

            return (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in">
                    {meetings.length === 0 && <div className="col-span-full text-center py-20 text-slate-500">No meetings recorded for this site.</div>}
                    {meetings.map(m => {
                        const status = getStatus(m.minutes);
                        return (
                            <div key={m.id} className="glass-panel p-5 rounded-2xl border-l-4 border-blue-500 hover:-translate-y-1 transition duration-300">
                                <div className="flex justify-between items-start mb-3">
                                    <span className="text-[10px] uppercase font-bold tracking-wider text-slate-500">{m.interaction}</span>
                                    <span className={`text-[10px] font-bold px-2 py-1 rounded bg-slate-800 ${status.color}`}>{status.label}</span>
                                </div>
                                <h3 className="text-lg font-bold text-white mb-1">{m.category}</h3>
                                <p className="text-xs text-slate-400 font-mono mb-4"><i className="fas fa-calendar-alt mr-2"></i>{formatDate(m.date)}</p>
                                <div className="border-t border-slate-700 pt-3 mt-auto">
                                    <p className="text-sm text-slate-300 line-clamp-2">{m.agenda}</p>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- COMPONENT: DASHBOARD ---
        const Dashboard = ({ meetings }) => {
            const [filterCat, setFilterCat] = useState('All');
            const [filterMonth, setFilterMonth] = useState('All');

            // 1. Flatten Data & Filter
            const filteredData = useMemo(() => {
                let flat = [];
                meetings.forEach(m => {
                    const mDate = new Date(m.date);
                    const mMonth = mDate.toLocaleString('default', { month: 'long' });
                    
                    if (filterCat !== 'All' && m.category !== filterCat) return;
                    if (filterMonth !== 'All' && mMonth !== filterMonth) return;

                    if(m.minutes) {
                        m.minutes.forEach(act => {
                            flat.push({
                                meetingName: m.category,
                                date: m.date,
                                month: mMonth,
                                point: act.point,
                                action: act.action,
                                owner: act.owner,
                                status: act.status || 'Open'
                            });
                        });
                    }
                });
                return flat;
            }, [meetings, filterCat, filterMonth]);

            // 2. Calculate Stats
            const stats = useMemo(() => {
                const meetingsCount = new Set(filteredData.map(d => d.date + d.meetingName)).size; // Approx distinct meetings based on filter
                const total = filteredData.length;
                const open = filteredData.filter(d => d.status === 'Open').length;
                const progress = filteredData.filter(d => d.status === 'In Progress').length;
                const closed = filteredData.filter(d => d.status === 'Closed').length;
                return { meetings: meetingsCount, total, open, progress, closed };
            }, [filteredData]);

            // 3. Export
            const exportExcel = () => {
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "Meeting Name,Date,Point,Action,Owner,Status\n"
                    + filteredData.map(e => `${e.meetingName},${e.date},"${e.point}","${e.action}",${e.owner},${e.status}`).join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "consultation_points.csv");
                document.body.appendChild(link);
                link.click();
            };

            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            return (
                <div className="space-y-6 animate-fade-in">
                    {/* Filters */}
                    <div className="glass-panel p-4 rounded-xl flex gap-4 items-center flex-wrap">
                        <div className="flex items-center gap-2 text-sm text-slate-400"><i className="fas fa-filter"></i> Filters:</div>
                        <select className="w-40" value={filterCat} onChange={e=>setFilterCat(e.target.value)}>
                            <option value="All">All Categories</option>
                            {MEETING_TYPES.map(t=><option key={t} value={t}>{t}</option>)}
                        </select>
                        <select className="w-40" value={filterMonth} onChange={e=>setFilterMonth(e.target.value)}>
                            <option value="All">All Months</option>
                            {months.map(m=><option key={m} value={m}>{m}</option>)}
                        </select>
                        <button onClick={exportExcel} className="ml-auto bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2">
                            <i className="fas fa-file-excel"></i> Export CSV
                        </button>
                    </div>

                    {/* KPI Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><div className="text-slate-400 text-xs uppercase">Meetings</div><div className="text-2xl font-bold text-white">{stats.meetings}</div></div>
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><div className="text-slate-400 text-xs uppercase">Total Points</div><div className="text-2xl font-bold text-blue-400">{stats.total}</div></div>
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><div className="text-slate-400 text-xs uppercase">Open</div><div className="text-2xl font-bold text-red-400">{stats.open}</div></div>
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><div className="text-slate-400 text-xs uppercase">In Progress</div><div className="text-2xl font-bold text-yellow-400">{stats.progress}</div></div>
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><div className="text-slate-400 text-xs uppercase">Closed</div><div className="text-2xl font-bold text-emerald-400">{stats.closed}</div></div>
                    </div>

                    {/* Table */}
                    <div className="glass-panel rounded-xl overflow-hidden">
                        <table className="w-full text-left text-sm text-slate-300">
                            <thead className="bg-slate-900 text-xs uppercase font-bold text-slate-500">
                                <tr><th className="p-4">Meeting</th><th className="p-4">Point & Action</th><th className="p-4">Owner</th><th className="p-4">Status</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {filteredData.map((d, i) => (
                                    <tr key={i} className="hover:bg-slate-800/50">
                                        <td className="p-4">
                                            <div className="font-bold text-white">{d.meetingName}</div>
                                            <div className="text-xs text-slate-500">{d.date}</div>
                                        </td>
                                        <td className="p-4">
                                            <div className="font-bold mb-1">{d.point}</div>
                                            <div className="text-xs text-blue-400"><i className="fas fa-arrow-right mr-1"></i> {d.action}</div>
                                        </td>
                                        <td className="p-4">{d.owner}</td>
                                        <td className="p-4">
                                            <span className={`px-2 py-1 rounded text-[10px] font-bold ${d.status==='Closed'?'bg-emerald-500/10 text-emerald-400':(d.status==='In Progress'?'bg-yellow-500/10 text-yellow-400':'bg-red-500/10 text-red-400')}`}>
                                                {d.status}
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('form');
            const [session, setSession] = useState(null);
            const [siteId, setSiteId] = useState('GLOBAL');
            const [meetings, setMeetings] = useState([]);

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) { window.location.href = 'index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);

                const params = new URLSearchParams(window.location.search);
                const ctx = params.get('site');
                if(ctx && ctx !== 'GLOBAL') setSiteId(ctx);

                // Fetch Data
                const dbRef = window.fb.ref(window.db);
                window.fb.get(window.fb.ref(window.db, `organizations/${sess.orgId}/consultation`)).then(snap => {
                    if(snap.exists()) {
                        const all = Object.entries(snap.val()).map(([k,v]) => ({id:k, ...v}));
                        // Filter by site if specific site selected
                        const filtered = (ctx && ctx !== 'GLOBAL') ? all.filter(m => m.siteId === ctx) : all;
                        setMeetings(filtered);
                    }
                });
            }, []);

            const handleSave = async (data) => {
                const payload = { ...data, siteId: siteId, timestamp: Date.now() };
                await window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/consultation`), payload);
                alert("Meeting Saved!");
                window.location.reload(); // Simple reload to refresh data
            };

            if(!session) return null;

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-white">
                    {/* Header */}
                    <div className="h-16 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-6">
                        <div className="flex items-center gap-4">
                            <a href="home.html" className="text-slate-400 hover:text-white"><i className="fas fa-arrow-left"></i> Back</a>
                            <h1 className="font-bold text-lg">Consultation & Participation</h1>
                        </div>
                        <div className="text-xs bg-slate-800 px-3 py-1 rounded text-emerald-400 border border-emerald-900">{siteId}</div>
                    </div>

                    {/* Navigation Tabs */}
                    <div className="flex justify-center border-b border-slate-800 bg-slate-900/50">
                        {['form', 'list', 'dashboard'].map(tab => (
                            <button 
                                key={tab} 
                                onClick={()=>setView(tab)} 
                                className={`px-8 py-3 text-sm font-bold uppercase tracking-wider transition-all border-b-2 ${view===tab ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-500 hover:text-white'}`}
                            >
                                {tab === 'form' ? 'Record Meeting' : (tab === 'list' ? 'Meeting History' : 'Analytics')}
                            </button>
                        ))}
                    </div>

                    {/* Content Area */}
                    <div className="p-6 flex-1 overflow-y-auto max-w-7xl mx-auto w-full">
                        {view === 'form' && <MeetingForm siteId={siteId} onSave={handleSave} />}
                        {view === 'list' && <MeetingList meetings={meetings} />}
                        {view === 'dashboard' && <Dashboard meetings={meetings} />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
