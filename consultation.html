<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultation & Participation | ERP</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Space Grotesk', 'sans-serif'] }, colors: { 'slate-850': '#1e293b', 'slate-950': '#020617' } } } }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.2s; }
        .glass-panel:hover { border-color: rgba(59, 130, 246, 0.4); transform: translateY(-2px); cursor: pointer; }
        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; outline: none; width: 100%; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #2dd4bf; }
        input:disabled, select:disabled, textarea:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .status-Open { color: #f87171; background: rgba(248, 113, 113, 0.1); }
        .status-InProgress { color: #facc15; background: rgba(250, 204, 21, 0.1); }
        .status-Closed { color: #34d399; background: rgba(52, 211, 153, 0.1); }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* --- FIXED PRINT STYLES --- */
        @media print {
            @page { size: A4; margin: 15mm; }
            body * { visibility: hidden; } /* Hide everything by default */
            .print-overlay, .print-overlay * { visibility: visible !important; color: black !important; } /* Show only overlay */
            .print-overlay { 
                position: absolute; top: 0; left: 0; width: 100%; min-height: 100%; 
                background: white; z-index: 9999; display: block !important; 
                font-family: sans-serif;
            }
            .no-print { display: none !important; }
            
            /* Print Formatting */
            h1 { font-size: 24pt; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; }
            h2 { font-size: 14pt; background: #eee !important; padding: 5px; margin-top: 20px; border-bottom: 1px solid #000; -webkit-print-color-adjust: exact; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10pt; }
            th, td { border: 1px solid black !important; padding: 6px; text-align: left; }
            th { background-color: #f0f0f0 !important; font-weight: bold; }
        }
        .print-overlay { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, push, update, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", authDomain: "ohsms-fa534.firebaseapp.com", databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/", projectId: "ohsms-fa534", storageBucket: "ohsms-fa534.appspot.com", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { ref, get, push, update, set, remove };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const MEETING_TYPES = ["Committee Meeting", "Incident Investigation", "Policy Decision", "Objective & Targets", "Legal Aspects", "Continual Improvement Plans", "Program Management"];

        // --- COMPONENTS ---
        const UserSelect = ({ users, value, onChange, disabled, placeholder }) => (
            <select value={value} onChange={e => onChange(e.target.value)} disabled={disabled} className="w-full">
                <option value="">{placeholder || 'Select User...'}</option>
                {users.map(u => <option key={u.id} value={u.name}>{u.name} ({u.role})</option>)}
            </select>
        );

        const SiteSelect = ({ sites, value, onChange, disabled }) => (
            <select value={value} onChange={e => onChange(e.target.value)} disabled={disabled} className="w-full">
                <option value="">Select Site...</option>
                {sites.map(s => <option key={s.code} value={s.code}>{s.name} ({s.code})</option>)}
            </select>
        );

        // --- MEETING FORM (NEW RECORD) ---
        const MeetingForm = ({ session, sites, users, siteId, permissions, prefill, onSave, onPrint }) => {
            const [selectedSite, setSelectedSite] = useState(siteId === 'GLOBAL' ? '' : siteId);
            const [form, setForm] = useState({
                interaction: 'Consultation', category: prefill?.category || 'Committee Meeting',
                date: prefill?.date || new Date().toISOString().split('T')[0], time: prefill?.time || '',
                agenda: prefill?.agenda || '', attendees: [], 
                minutes: '', actions: [] 
            });
            const [newAttendee, setNewAttendee] = useState('');

            const siteUsers = useMemo(() => {
                if (!selectedSite) return users;
                return users.filter(u => u.role === 'Owner' || (u.accessibleSites && u.accessibleSites.includes(selectedSite)) || u.assignedSite === selectedSite);
            }, [users, selectedSite]);

            const canEdit = !permissions.viewOnly;

            const addAttendee = () => { if (newAttendee && !form.attendees.includes(newAttendee)) { setForm({ ...form, attendees: [...form.attendees, newAttendee] }); setNewAttendee(''); } };
            const addAction = () => setForm({...form, actions: [...form.actions, { action: '', owner: '', due: '', status: 'Open' }]});
            const updateAction = (i, f, v) => { const na = [...form.actions]; na[i][f] = v; setForm({...form, actions: na}); };
            const removeAction = (i) => setForm({...form, actions: form.actions.filter((_, x) => x !== i)});

            const handleSubmit = () => {
                if (!selectedSite) return alert('Please select a site');
                if (!form.category || !form.date) return alert('Fill required fields');
                const meetingId = `MOM-${selectedSite}-${Date.now().toString().slice(-6)}`;
                const finalData = { ...form, id: meetingId, siteId: selectedSite, createdBy: session.user, timestamp: Date.now() };
                onSave(finalData);
            };

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="glass-panel p-6 rounded-xl border border-slate-700">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-teal-400 flex items-center gap-2"><i className="fas fa-edit"></i> Record Meeting Minutes</h2>
                            {/* Print Preview Button for Form */}
                            <button onClick={() => onPrint({...form, siteId: selectedSite, id: 'DRAFT'})} className="text-slate-400 hover:text-white"><i className="fas fa-print"></i></button>
                        </div>
                        
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div><label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Site</label><SiteSelect sites={sites} value={selectedSite} onChange={v => { setSelectedSite(v); setForm({...form, attendees: []}); }} disabled={!canEdit || siteId !== 'GLOBAL'} /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Category</label><select value={form.category} onChange={e => setForm({...form, category: e.target.value})} disabled={!canEdit}>{MEETING_TYPES.map(t => <option key={t}>{t}</option>)}</select></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Date</label><input type="date" value={form.date} onChange={e => setForm({...form, date: e.target.value})} disabled={!canEdit} /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Time</label><input type="time" value={form.time} onChange={e => setForm({...form, time: e.target.value})} disabled={!canEdit} /></div>
                            <div className="col-span-4"><label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Agenda</label><input value={form.agenda} onChange={e => setForm({...form, agenda: e.target.value})} placeholder="Meeting purpose..." disabled={!canEdit} /></div>
                        </div>

                        <div className="mb-6 bg-slate-950 p-4 rounded-xl border border-slate-800">
                            <label className="text-[10px] uppercase font-bold text-slate-500 block mb-2">Attendees</label>
                            <div className="flex gap-2 mb-2">
                                <UserSelect users={siteUsers} value={newAttendee} onChange={setNewAttendee} disabled={!canEdit} placeholder="Select attendee..." />
                                {canEdit && <button onClick={addAttendee} className="bg-teal-600 hover:bg-teal-500 text-white px-4 rounded font-bold text-sm whitespace-nowrap">+ Add</button>}
                            </div>
                            <div className="flex flex-wrap gap-2">{form.attendees.map((a, i) => <span key={i} className="bg-slate-800 px-3 py-1 rounded-full text-xs flex items-center gap-2 border border-slate-700">{a}{canEdit && <button onClick={() => setForm({...form, attendees: form.attendees.filter((_, x) => x !== i)})} className="text-red-400 hover:text-red-300">×</button>}</span>)}</div>
                        </div>

                        <div className="mb-6">
                            <label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Minutes / Discussion Points</label>
                            <textarea rows="6" value={form.minutes} onChange={e=>setForm({...form, minutes:e.target.value})} className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-sm text-white focus:border-teal-500" placeholder="Record the general discussion points here..." disabled={!canEdit}></textarea>
                        </div>

                        <div className="bg-slate-800/50 p-4 rounded-xl border border-teal-500/30">
                            <div className="flex justify-between items-center mb-3">
                                <label className="text-xs uppercase font-bold text-teal-400"><i className="fas fa-list-check mr-2"></i> Action Plan (CAPA)</label>
                                {canEdit && <button onClick={addAction} className="text-[10px] bg-teal-600 px-3 py-1.5 rounded text-white font-bold hover:bg-teal-500">+ Add Action</button>}
                            </div>
                            <div className="space-y-2">
                                {form.actions.map((c, i) => (
                                    <div key={i} className="grid grid-cols-12 gap-2 items-center">
                                        <div className="col-span-6"><input value={c.action} onChange={e=>updateAction(i, 'action', e.target.value)} placeholder="Action Description..." className="text-xs bg-slate-900 border-slate-700" disabled={!canEdit} /></div>
                                        <div className="col-span-3"><select value={c.owner} onChange={e=>updateAction(i, 'owner', e.target.value)} className="text-xs bg-slate-900 border-slate-700" disabled={!canEdit}><option value="">Owner...</option>{users.map(u=><option key={u.id} value={u.name}>{u.name}</option>)}</select></div>
                                        <div className="col-span-2"><input type="date" value={c.due} onChange={e=>updateAction(i, 'due', e.target.value)} className="text-xs bg-slate-900 border-slate-700" disabled={!canEdit} /></div>
                                        <div className="col-span-1 text-center">{canEdit && <button onClick={()=>removeAction(i)} className="text-red-400 hover:text-white"><i className="fas fa-times"></i></button>}</div>
                                    </div>
                                ))}
                                {form.actions.length === 0 && <div className="text-center text-xs text-slate-500 italic py-2">No actions added yet.</div>}
                            </div>
                        </div>

                        {canEdit && <div className="flex justify-end mt-6"><button onClick={handleSubmit} className="bg-gradient-to-r from-teal-600 to-emerald-600 hover:from-teal-500 hover:to-emerald-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition-transform transform hover:-translate-y-1">Save Meeting Record</button></div>}
                    </div>
                </div>
            );
        };

        // --- REPOSITORY VIEW ---
        const MeetingRepository = ({ meetings, onView, onDelete, permissions }) => {
            const [filter, setFilter] = useState({ site: 'All', category: 'All' });

            const filtered = useMemo(() => {
                return meetings.filter(m => (filter.site === 'All' || m.siteId === filter.site) && (filter.category === 'All' || m.category === filter.category));
            }, [meetings, filter]);

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex gap-4 mb-6 bg-slate-900 p-4 rounded-xl border border-slate-800">
                        <div><label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Site</label><select className="bg-slate-800 p-2 rounded w-32 border border-slate-700" value={filter.site} onChange={e => setFilter({...filter, site: e.target.value})}><option value="All">All Sites</option>{[...new Set(meetings.map(m => m.siteId))].map(s => <option key={s}>{s}</option>)}</select></div>
                        <div><label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Category</label><select className="bg-slate-800 p-2 rounded w-40 border border-slate-700" value={filter.category} onChange={e => setFilter({...filter, category: e.target.value})}><option value="All">All Categories</option>{MEETING_TYPES.map(t => <option key={t}>{t}</option>)}</select></div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {filtered.map(m => (
                            <div key={m.firebaseKey} className="glass-panel p-5 rounded-xl border-l-4 border-teal-500 relative group" onClick={() => onView(m)}>
                                <div className="flex justify-between items-start mb-2">
                                    <span className="font-mono text-xs text-teal-400">{m.id}</span>
                                    <span className="text-[10px] bg-slate-800 text-slate-300 px-2 py-0.5 rounded border border-slate-700">{m.date}</span>
                                </div>
                                <h3 className="font-bold text-white mb-1 truncate">{m.category}</h3>
                                <p className="text-xs text-slate-400 mb-3">{m.siteId} • {m.interaction}</p>
                                <div className="flex justify-between items-center border-t border-slate-800 pt-3">
                                    <span className="text-[10px] text-slate-500 font-bold uppercase">Actions: <span className="text-white text-sm ml-1">{m.actions ? m.actions.length : 0}</span></span>
                                    {!permissions.viewOnly && permissions.canDelete && <button onClick={e => { e.stopPropagation(); onDelete(m); }} className="text-slate-600 hover:text-red-400 text-sm transition-colors"><i className="fas fa-trash"></i></button>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('list');
            const [session, setSession] = useState(null);
            const [meetings, setMeetings] = useState([]);
            const [selectedMeeting, setSelectedMeeting] = useState(null); // For Modal View
            const [printData, setPrintData] = useState(null); // For Print Overlay
            
            const [siteId, setSiteId] = useState('GLOBAL');
            const [sites, setSites] = useState([]);
            const [users, setUsers] = useState([]);
            const [permissions, setPermissions] = useState({ viewOnly: false, canEditOwnedActions: false, canDelete: false });
            const [prefill, setPrefill] = useState(null);

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if (!s) { window.location.href = 'index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);

                const params = new URLSearchParams(window.location.search);
                const ctx = params.get('site');
                if (ctx && ctx !== 'GLOBAL') setSiteId(ctx);

                setPermissions({
                    viewOnly: (params.get('viewOnly') === 'true') || sess.role === 'User',
                    canEditOwnedActions: sess.role === 'Manager',
                    canDelete: sess.role === 'Owner'
                });

                if (params.get('category')) {
                    setPrefill({ category: params.get('category'), date: params.get('date'), time: params.get('time'), agenda: params.get('agenda') });
                    setView('form');
                }

                const dbRef = window.fb.ref(window.db, `organizations/${sess.orgId}`);
                window.fb.get(dbRef).then(snap => {
                    if (snap.exists()) {
                        const data = snap.val();
                        if (data.meetings || data.consultations) {
                            const raw = data.consultations || data.meetings || {};
                            setMeetings(Object.entries(raw).map(([k, v]) => ({ firebaseKey: k, ...v })).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)));
                        }
                        if (data.sites) setSites(Object.values(data.sites));
                        if (data.users) setUsers(Object.entries(data.users).map(([k, v]) => ({ id: k, ...v })).filter(u => u.status === 'Active'));
                    }
                });
            }, []);

            const handleSave = async (data) => {
                await window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/consultations`), data);
                alert("Meeting saved!");
                window.location.reload();
            };

            const handleDelete = async (meeting) => {
                if (confirm("Delete this record?")) {
                    await window.fb.remove(window.fb.ref(window.db, `organizations/${session.orgId}/consultations/${meeting.firebaseKey}`));
                    setMeetings(meetings.filter(m => m.firebaseKey !== meeting.firebaseKey));
                }
            };

            const preparePrint = (meeting) => {
                setPrintData(meeting);
                setTimeout(() => window.print(), 500);
            };

            if (!session) return null;

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-white font-sans overflow-hidden">
                    <header className="h-16 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-6 no-print">
                        <div className="flex items-center gap-4">
                            <a href="home.html" className="text-slate-400 hover:text-white flex items-center gap-2"><i className="fas fa-arrow-left"></i> Back</a>
                            <h1 className="font-bold text-lg">Consultation & Participation</h1>
                        </div>
                        <div className="flex bg-slate-800 p-1 rounded-lg gap-1">
                            <button onClick={() => setView('list')} className={`px-4 py-1.5 rounded text-xs font-bold uppercase transition ${view === 'list' ? 'bg-teal-600 text-white' : 'text-slate-400 hover:text-white'}`}>Meetings</button>
                            <button onClick={() => setView('form')} className={`px-4 py-1.5 rounded text-xs font-bold uppercase transition ${view === 'form' ? 'bg-teal-600 text-white' : 'text-slate-400 hover:text-white'}`}>New Record</button>
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto p-8 custom-scroll">
                        <div className="max-w-6xl mx-auto">
                            {view === 'form' && <MeetingForm session={session} sites={sites} users={users} siteId={siteId} permissions={permissions} prefill={prefill} onSave={handleSave} onPrint={preparePrint} />}
                            {view === 'list' && <MeetingRepository meetings={meetings} onView={(m) => { setSelectedMeeting(m); preparePrint(m); }} onDelete={handleDelete} permissions={permissions} />}
                        </div>
                    </main>

                    {/* OVERLAY FOR PRINTING ONLY */}
                    {printData && (
                        <div className="print-overlay p-10">
                            <div className="flex justify-between items-center mb-6 border-b-2 border-black pb-4">
                                <div>
                                    <h1 className="text-2xl font-bold uppercase mb-1">Minutes of Meeting</h1>
                                    <p className="text-sm font-bold">Ref ID: {printData.id}</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-sm">Date: {printData.date}</p>
                                    <p className="text-sm">Site: {printData.siteId}</p>
                                </div>
                            </div>

                            <div className="mb-6 border border-black p-4">
                                <h2 className="text-lg font-bold mb-4 uppercase bg-gray-200 p-2">1. Meeting Details</h2>
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong>Category:</strong> {printData.category}</div>
                                    <div><strong>Type:</strong> {printData.interaction}</div>
                                    <div><strong>Time:</strong> {printData.time}</div>
                                    <div><strong>Logged By:</strong> {printData.createdBy}</div>
                                </div>
                                <div className="mt-4 text-sm">
                                    <strong>Agenda:</strong> {printData.agenda}
                                </div>
                            </div>

                            <div className="mb-6 border border-black p-4">
                                <h2 className="text-lg font-bold mb-4 uppercase bg-gray-200 p-2">2. Attendees</h2>
                                <p className="text-sm">{(printData.attendees || []).join(', ')}</p>
                            </div>

                            <div className="mb-6 border border-black p-4">
                                <h2 className="text-lg font-bold mb-4 uppercase bg-gray-200 p-2">3. Discussion Minutes</h2>
                                <div className="text-sm whitespace-pre-wrap">{printData.minutes}</div>
                            </div>

                            <div className="mb-6 border border-black p-4">
                                <h2 className="text-lg font-bold mb-4 uppercase bg-gray-200 p-2">4. Action Plan (CAPA)</h2>
                                <table className="w-full text-sm border-collapse border border-black">
                                    <thead>
                                        <tr className="bg-gray-100">
                                            <th className="border border-black p-2">Action Item</th>
                                            <th className="border border-black p-2">Owner</th>
                                            <th className="border border-black p-2">Due Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {(printData.actions || []).map((row, idx) => (
                                            <tr key={idx}>
                                                <td className="border border-black p-2">{row.action}</td>
                                                <td className="border border-black p-2">{row.owner}</td>
                                                <td className="border border-black p-2">{row.due}</td>
                                            </tr>
                                        ))}
                                        {(!printData.actions || printData.actions.length === 0) && <tr><td colSpan="3" className="border border-black p-2 text-center italic">No actions recorded.</td></tr>}
                                    </tbody>
                                </table>
                            </div>

                            <div className="flex justify-between mt-12 pt-12">
                                <div className="border-t border-black w-1/3 pt-2 text-center text-sm font-bold">Prepared By</div>
                                <div className="border-t border-black w-1/3 pt-2 text-center text-sm font-bold">Approved By</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
