<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standards & Procedures | Enterprise Hub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Space Grotesk', 'sans-serif'] },
                    colors: { 'slate-850': '#1e293b', 'slate-950': '#020617' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .hover-card:hover { transform: translateY(-5px); border-color: #6366f1; box-shadow: 0 10px 30px -10px rgba(99, 102, 241, 0.3); }
        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; width: 100%; outline: none; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #6366f1; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", authDomain: "ohsms-fa534.firebaseapp.com", databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/", projectId: "ohsms-fa534", storageBucket: "ohsms-fa534.appspot.com", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { ref, push, get, remove };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CATEGORIES = ["Policy", "SOP / Procedure", "Manual", "Form / Template", "Record", "Legal Register"];

        // Simple Templates for the Generator
        const TEMPLATES = {
            "SOP / Procedure": (title) => `STANDARD OPERATING PROCEDURE (SOP)\n\n1.0 PURPOSE\nThe purpose of this procedure is to define the guidelines for ${title}.\n\n2.0 SCOPE\nThis SOP applies to all employees involved in ${title}.\n\n3.0 RESPONSIBILITIES\n- Manager: Ensure compliance.\n- Operator: Follow steps.\n\n4.0 PROCEDURE\n4.1 Step One: Prepare area.\n4.2 Step Two: Execute task.\n4.3 Step Three: Verify completion.\n\n5.0 SAFETY PRECAUTIONS\n- Wear appropriate PPE.\n- Follow LOTO procedures if applicable.`,
            "Policy": (title) => `POLICY STATEMENT: ${title}\n\n1. POLICY OVERVIEW\nOur organization is committed to maintaining high standards in ${title}.\n\n2. OBJECTIVES\n- Zero accidents related to ${title}.\n- Full compliance with legal standards.\n\n3. APPLICABILITY\nAll staff, contractors, and visitors.\n\n4. COMPLIANCE\nFailure to comply may result in disciplinary action.`,
            "Manual": (title) => `SAFETY MANUAL SECTION: ${title}\n\n1. INTRODUCTION\nDetailed instructions on ${title}.\n\n2. REFERENCE DOCUMENTS\n- ISO 45001:2018\n- Local Regulations`
        };

        const StandardsApp = () => {
            const [session, setSession] = useState(null);
            const [view, setView] = useState('menu'); // 'menu', 'generator', 'repository'
            const [files, setFiles] = useState([]);
            const [loading, setLoading] = useState(false);

            // Generator State
            const [genData, setGenData] = useState({ title: '', category: 'SOP / Procedure', content: '' });

            // Repository State
            const [searchTerm, setSearchTerm] = useState('');
            const [filterCat, setFilterCat] = useState('All');

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) { window.location.href='index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);
                loadFiles(sess);
            }, []);

            const loadFiles = async (sess) => {
                setLoading(true);
                const snap = await window.fb.get(window.fb.ref(window.db, `organizations/${sess.orgId}/standards`));
                if(snap.exists()) setFiles(Object.entries(snap.val()).map(([k, v]) => ({ ...v, firebaseKey: k })));
                else setFiles([]);
                setLoading(false);
            };

            const handleGenerate = () => {
                if(!genData.title) return alert("Enter a title first.");
                const template = TEMPLATES[genData.category] || TEMPLATES["SOP / Procedure"];
                setGenData({ ...genData, content: template(genData.title) });
            };

            const handleSaveGenerated = async () => {
                if(!genData.title || !genData.content) return alert("Content is empty.");
                
                // Convert text content to a simple Blob URL for "download" simulation
                const blob = new Blob([genData.content], { type: 'text/plain' });
                const reader = new FileReader();
                reader.readAsDataURL(blob); 
                reader.onloadend = async () => {
                    const base64data = reader.result;
                    
                    const newFile = {
                        title: genData.title,
                        category: genData.category,
                        version: '1.0',
                        file: base64data, // Storing text file as base64
                        type: 'text/plain',
                        uploadedBy: session.user,
                        date: new Date().toISOString().split('T')[0]
                    };

                    await window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/standards`), newFile);
                    alert("Document Saved to Repository!");
                    loadFiles(session);
                    setView('repository');
                    setGenData({ title: '', category: 'SOP / Procedure', content: '' });
                };
            };

            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const newFile = {
                        title: file.name,
                        category: "Uploaded",
                        version: "1.0",
                        file: reader.result,
                        uploadedBy: session.user,
                        date: new Date().toISOString().split('T')[0]
                    };
                    await window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/standards`), newFile);
                    alert("File Uploaded!");
                    loadFiles(session);
                };
            };

            const handleDelete = async (key) => {
                if(confirm("Delete this document?")) {
                    await window.fb.remove(window.fb.ref(window.db, `organizations/${session.orgId}/standards/${key}`));
                    loadFiles(session);
                }
            };

            const filteredFiles = useMemo(() => {
                return files.filter(f => {
                    const matchCat = filterCat === 'All' || f.category === filterCat;
                    const matchSearch = f.title.toLowerCase().includes(searchTerm.toLowerCase());
                    return matchCat && matchSearch;
                });
            }, [files, filterCat, searchTerm]);

            if(!session) return null;

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-white font-sans overflow-hidden">
                    {/* Header */}
                    <div className="h-16 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-6">
                        <div className="flex items-center gap-4">
                            <a href="home.html" className="text-slate-400 hover:text-white flex items-center gap-2"><i className="fas fa-arrow-left"></i> Back</a>
                            <h1 className="font-bold text-lg">Standards & Procedures</h1>
                        </div>
                        {view !== 'menu' && <button onClick={()=>setView('menu')} className="bg-slate-800 text-slate-300 px-3 py-1 rounded text-xs hover:bg-slate-700">Main Menu</button>}
                    </div>

                    <div className="flex-1 overflow-y-auto p-8 custom-scroll">
                        <div className="max-w-6xl mx-auto">
                            
                            {/* MENU VIEW */}
                            {view === 'menu' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">
                                    {/* Tile 1: Generator */}
                                    <div onClick={()=>setView('generator')} className="glass-panel p-10 rounded-2xl border border-slate-700 cursor-pointer hover-card group transition-all flex flex-col items-center text-center">
                                        <div className="w-20 h-20 bg-indigo-600/20 rounded-full flex items-center justify-center text-4xl text-indigo-400 mb-6 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                            <i className="fas fa-wand-magic-sparkles"></i>
                                        </div>
                                        <h2 className="text-2xl font-bold text-white mb-2">Standard Document Generator</h2>
                                        <p className="text-slate-400">Create SOPs, Policies, and Manuals using built-in templates. Draft, edit, and save directly to the system.</p>
                                    </div>

                                    {/* Tile 2: Repository */}
                                    <div onClick={()=>setView('repository')} className="glass-panel p-10 rounded-2xl border border-slate-700 cursor-pointer hover-card group transition-all flex flex-col items-center text-center">
                                        <div className="w-20 h-20 bg-blue-600/20 rounded-full flex items-center justify-center text-4xl text-blue-400 mb-6 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                            <i className="fas fa-server"></i>
                                        </div>
                                        <h2 className="text-2xl font-bold text-white mb-2">Standard Documentation Repository</h2>
                                        <p className="text-slate-400">Centralized storage for all safety documents. Search, filter, version control, and secure access.</p>
                                    </div>
                                </div>
                            )}

                            {/* GENERATOR VIEW */}
                            {view === 'generator' && (
                                <div className="glass-panel p-8 rounded-xl border border-slate-700 animate-fade-in">
                                    <h2 className="text-2xl font-bold mb-6 text-indigo-400 flex items-center gap-3"><i className="fas fa-wand-magic-sparkles"></i> Create New Document</h2>
                                    
                                    <div className="grid grid-cols-2 gap-6 mb-6">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Document Title</label>
                                            <input value={genData.title} onChange={e=>setGenData({...genData, title:e.target.value})} placeholder="e.g. Electrical Safety SOP" className="bg-slate-900" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Category</label>
                                            <select value={genData.category} onChange={e=>setGenData({...genData, category:e.target.value})} className="bg-slate-900">
                                                {CATEGORIES.map(c=><option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    <button onClick={handleGenerate} className="bg-slate-800 text-indigo-400 px-4 py-2 rounded text-sm font-bold mb-4 hover:bg-slate-700 border border-slate-700"><i className="fas fa-bolt mr-2"></i>Generate Template Draft</button>

                                    <div className="mb-6">
                                        <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Content Editor</label>
                                        <textarea value={genData.content} onChange={e=>setGenData({...genData, content:e.target.value})} className="h-96 font-mono text-sm bg-slate-900 leading-relaxed p-4" placeholder="Generated content will appear here..."></textarea>
                                    </div>

                                    <button onClick={handleSaveGenerated} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:-translate-y-1">Save to Repository</button>
                                </div>
                            )}

                            {/* REPOSITORY VIEW */}
                            {view === 'repository' && (
                                <div className="space-y-6 animate-fade-in">
                                    {/* Toolbar */}
                                    <div className="glass-panel p-4 rounded-xl flex gap-4 items-center border border-slate-700">
                                        <div className="flex-1 relative">
                                            <i className="fas fa-search absolute left-3 top-3 text-slate-500 text-xs"></i>
                                            <input placeholder="Search documents..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="pl-8 bg-slate-900 border-none text-sm py-2" />
                                        </div>
                                        <select value={filterCat} onChange={e=>setFilterCat(e.target.value)} className="w-48 bg-slate-900 border-none text-sm py-2">
                                            <option value="All">All Categories</option>
                                            {CATEGORIES.map(c=><option key={c} value={c}>{c}</option>)}
                                            <option value="Uploaded">Uploaded Files</option>
                                        </select>
                                        <div className="relative overflow-hidden">
                                            <button className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2"><i className="fas fa-cloud-upload-alt"></i> Upload PDF</button>
                                            <input type="file" onChange={handleUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                        </div>
                                    </div>

                                    {/* Grid */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {filteredFiles.map(f => (
                                            <div key={f.firebaseKey} className="glass-panel p-4 rounded-xl border border-slate-700 flex flex-col justify-between group hover:border-blue-500/50 transition relative">
                                                <div className="absolute top-4 right-4 text-2xl text-slate-700 group-hover:text-blue-500/20 transition"><i className={`fas ${f.category==='Uploaded'?'fa-file-pdf':'fa-file-alt'}`}></i></div>
                                                <div>
                                                    <div className="flex justify-between items-start mb-2 pr-8">
                                                        <span className="text-[10px] bg-slate-800 text-slate-300 px-2 py-0.5 rounded border border-slate-700">{f.category}</span>
                                                    </div>
                                                    <h3 className="font-bold text-white mb-1 truncate" title={f.title}>{f.title}</h3>
                                                    <p className="text-[10px] text-slate-400">v{f.version} • {f.date} • {f.uploadedBy}</p>
                                                </div>
                                                <div className="flex gap-2 mt-4 pt-3 border-t border-slate-700/50">
                                                    <a href={f.file} download={f.title} className="flex-1 bg-slate-800 hover:bg-slate-700 text-center py-1.5 rounded text-xs font-bold text-white transition"><i className="fas fa-download mr-1"></i> Download</a>
                                                    {session.role === 'Owner' && <button onClick={()=>handleDelete(f.firebaseKey)} className="px-3 bg-red-900/20 hover:bg-red-900/40 text-red-400 rounded text-xs"><i className="fas fa-trash"></i></button>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    {filteredFiles.length === 0 && <div className="text-center text-slate-500 text-sm mt-10 p-10 glass-panel rounded-xl">No documents found in the repository.</div>}
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StandardsApp />);
    </script>
</body>
</html>
