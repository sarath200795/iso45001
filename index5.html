<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO 45001 | Clause 5 Leadership</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Space Grotesk', sans-serif; }</style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const generateManualPDF = (doc) => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('landscape');
            const pW = pdf.internal.pageSize.getWidth();
            const prefix = `${doc.orgCode}-${doc.siteCode}`.toUpperCase();
            
            const addHeader = (title, id) => {
                pdf.setFillColor(30, 41, 59);
                pdf.rect(0, 0, pW, 20, 'F');
                pdf.setTextColor(255);
                pdf.setFontSize(10);
                pdf.text(title, 14, 13);
                pdf.text(`Doc ID: ${prefix}-C5-${id} | Ver: ${doc.version || 'Draft'}`, pW - 14, 13, { align: 'right' });
                pdf.setTextColor(0);
            };

            addHeader("LEADERSHIP MANUAL - REVISION HISTORY", "REV");
            pdf.setFontSize(18);
            pdf.text(doc.companyName || "LEADERSHIP MANUAL", pW/2, 40, {align:'center'});
            pdf.autoTable({ startY: 55, head: [['Version', 'Date', 'Changes']], body: (doc.revisions || []).map(r => [r.ver, r.date, r.change]), theme: 'grid' });

            pdf.addPage();
            addHeader("OH&S POLICY (5.2)", "POL");
            let y = 35;
            const labels = { a: "Safe & Healthy Conditions:", b: "Objectives Framework:", c: "Legal Requirements:", d: "Hazard Elimination:", e: "Continual Improvement:", f: "Consultation & Participation:" };
            
            // Render Clauses
            Object.keys(labels).forEach(k => {
                if(y > 150) { pdf.addPage(); addHeader("OH&S POLICY (CONT.)", "POL"); y = 30; }
                pdf.setFontSize(10); pdf.setFont("helvetica", "bold");
                pdf.text(`5.2(${k}) ${labels[k]}`, 14, y); y += 6;
                pdf.setFont("helvetica", "normal");
                const text = doc.policySpecifics?.[k] || "Not specified.";
                const splitText = pdf.splitTextToSize(text, pW - 28);
                pdf.text(splitText, 14, y); y += (splitText.length * 5) + 10;
            });

            // --- NEW: Render Additional Notes in PDF ---
            if (doc.policyText) {
                if(y > 140) { pdf.addPage(); addHeader("OH&S POLICY (NOTES)", "POL"); y = 30; }
                y += 5;
                pdf.setFontSize(11); pdf.setFont("helvetica", "bold");
                pdf.text("Additional Policy Notes & Context:", 14, y); 
                y += 7;
                pdf.setFontSize(10); pdf.setFont("helvetica", "normal");
                const noteText = pdf.splitTextToSize(doc.policyText, pW - 28);
                pdf.text(noteText, 14, y);
            }

            pdf.addPage();
            addHeader("RASCI RESPONSIBILITY MATRIX (5.3)", "RASCI");
            if (doc.definedRoles && doc.rasciProcesses) {
                const roleCols = doc.definedRoles.map(r => r.title);
                const headRow = [['Process / Activity', ...roleCols]];
                const bodyRows = doc.rasciProcesses.map(proc => {
                    const row = [proc.name];
                    roleCols.forEach(roleTitle => {
                        const a = proc.assignments.find(a => a.role === roleTitle);
                        row.push(a ? a.code : '-');
                    });
                    return row;
                });
                pdf.autoTable({ startY: 30, head: headRow, body: bodyRows, theme: 'grid', headStyles: { fillColor: [30, 41, 59], fontSize: 8 }, styles: { fontSize: 8, cellPadding: 2, halign: 'center' }, columnStyles: { 0: { halign: 'left', fontStyle: 'bold', cellWidth: 50 } } });
            }
            pdf.save(`${prefix}-Clause5-Manual.pdf`);
        };

        const CONSULT_OPTIONS = ["1. Needs of interested parties", "2. Establishing Policy", "3. Assigning Roles", "4. Legal Requirements", "5. Objectives", "6. Outsourcing", "7. Monitoring", "8. Audit", "9. Continual Improvement"];

        const App = () => {
            const [session, setSession] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [newRoleName, setNewRoleName] = useState('');
            const [newProcessName, setNewProcessName] = useState('');

            const [formData, setFormData] = useState(() => {
                const saved = localStorage.getItem('isoDataClause5');
                const parsed = saved ? JSON.parse(saved) : {};
                const sess = JSON.parse(sessionStorage.getItem('isoSession') || '{}');
                return {
                    orgCode: sess.orgId || 'ORG', siteCode: sess.assignedSite || 'SITE-HQ',
                    companyName: sess.orgName || 'My Organization', version: parsed.version || 'DRAFT',
                    policySpecifics: parsed.policySpecifics || { a: '', b: '', c: '', d: '', e: '', f: '' },
                    // --- NEW: Initialize policyText ---
                    policyText: parsed.policyText || '', 
                    definedRoles: parsed.definedRoles || [{ title: 'Top Management' }, { title: 'Safety Manager' }, { title: 'Worker Rep' }],
                    rasciProcesses: parsed.rasciProcesses || [{ name: 'Policy Development', assignments: [] }, { name: 'Hazard Identification', assignments: [] }, { name: 'Risk Assessment', assignments: [] }, { name: 'Incident Investigation', assignments: [] }, { name: 'Internal Audit', assignments: [] }],
                    consultationLog: parsed.consultationLog || [], revisions: parsed.revisions || []
                };
            });

            const [newItem, setNewItem] = useState({ meeting: '', type: 'Consultation', option: '', actions: '', responsible: '', due: '', status: 'Open' });

            useEffect(() => { const s = sessionStorage.getItem('isoSession'); if (!s) { window.location.href = "index.html"; return; } setSession(JSON.parse(s)); }, []);
            useEffect(() => { localStorage.setItem('isoDataClause5', JSON.stringify(formData)); }, [formData]);

            const addRole = () => { if (!newRoleName) return; setFormData(p => ({ ...p, definedRoles: [...p.definedRoles, { title: newRoleName }] })); setNewRoleName(''); };
            const removeRole = (i) => { if (!confirm("Remove?")) return; const t = formData.definedRoles[i].title; setFormData(p => ({ ...p, definedRoles: p.definedRoles.filter((_, j) => j !== i), rasciProcesses: p.rasciProcesses.map(pr => ({ ...pr, assignments: pr.assignments.filter(a => a.role !== t) })) })); };
            const addProcess = () => { if (!newProcessName) return; setFormData(p => ({ ...p, rasciProcesses: [...p.rasciProcesses, { name: newProcessName, assignments: [] }] })); setNewProcessName(''); };
            const removeProcess = (i) => { if (!confirm("Delete?")) return; setFormData(p => ({ ...p, rasciProcesses: p.rasciProcesses.filter((_, j) => j !== i) })); };
            const updateAssignment = (pi, rt, c) => { setFormData(p => { const np = [...p.rasciProcesses]; let na = np[pi].assignments.filter(a => a.role !== rt); if (c) na.push({ role: rt, code: c }); np[pi] = { ...np[pi], assignments: na }; return { ...p, rasciProcesses: np }; }); };
            const getAssignment = (pi, rt) => { const f = formData.rasciProcesses[pi]?.assignments.find(a => a.role === rt); return f ? f.code : ''; };

            const addLogItem = () => { if (!newItem.meeting || !newItem.actions) { alert("Fill Meeting & Actions"); return; } setFormData(p => ({ ...p, consultationLog: [...p.consultationLog, newItem] })); setNewItem({ meeting: '', type: 'Consultation', option: '', actions: '', responsible: '', due: '', status: 'Open' }); };
            const deleteLogItem = (i) => { if (!confirm("Delete?")) return; setFormData(p => ({ ...p, consultationLog: p.consultationLog.filter((_, j) => j !== i) })); };
            const handleStatusChange = (i, s) => { setFormData(p => { const l = [...p.consultationLog]; l[i].status = s; return { ...p, consultationLog: l }; }); };

            const stats = useMemo(() => { const s = { open: 0, inProgress: 0, closed: 0 }; formData.consultationLog.forEach(r => { if (r.status === 'Open') s.open++; else if (r.status === 'In Progress') s.inProgress++; else s.closed++; }); return s; }, [formData.consultationLog]);

            const saveToArchive = () => { const a = JSON.parse(localStorage.getItem('isoArchive5')) || { drafts: [], approved: [] }; a.drafts.unshift({ ...formData, version: 'DRAFT', author: session?.user || 'Unknown', role: session?.role || 'System', timestamp: new Date().toLocaleString() }); localStorage.setItem('isoArchive5', JSON.stringify(a)); alert("Saved to Repository!"); };

            if (!session) return null;

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="w-64 bg-slate-900 text-white flex flex-col shadow-2xl">
                        <div className="p-6 border-b border-slate-700/50">
                            <div className="flex items-center gap-3">
                                <a href="home.html" className="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center text-slate-400 hover:text-white transition-colors"><i className="fas fa-home text-sm"></i></a>
                                <div><h1 className="text-lg font-bold">Leadership</h1><p className="text-[10px] text-blue-400 font-mono uppercase">Clause 5</p></div>
                            </div>
                            <div className="mt-4 text-[10px] bg-slate-800/50 p-3 rounded-xl text-center font-mono text-slate-400">{formData.orgCode} / {formData.siteCode}</div>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            {[['dashboard', 'fa-chart-pie', 'Dashboard'], ['consultation', 'fa-comments', 'Consultation'], ['policy', 'fa-file-shield', 'OH&S Policy'], ['rasci', 'fa-users-rectangle', 'RASCI Matrix']].map(([id, icon, label]) => (
                                <button key={id} onClick={() => setActiveTab(id)} className={`w-full text-left p-4 rounded-xl font-medium flex items-center gap-3 transition-all ${activeTab === id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-700/50'}`}><i className={`fas ${icon} w-5`}></i>{label}</button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-700/50 space-y-3">
                            <button onClick={() => generateManualPDF(formData)} className="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold text-xs uppercase flex items-center justify-center gap-2"><i className="fas fa-file-pdf"></i> Export PDF</button>
                            <button onClick={saveToArchive} className="w-full bg-orange-600 hover:bg-orange-500 py-3 rounded-xl font-bold text-xs uppercase flex items-center justify-center gap-2"><i className="fas fa-save"></i> Save to Archive</button>
                            <a href="archive5.html" className="block text-center py-2 text-[10px] text-slate-500 hover:text-white">View Repository â†’</a>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-y-auto bg-slate-50 p-8">
                        {/* DASHBOARD TAB */}
                        {activeTab === 'dashboard' && (
                            <div className="max-w-6xl mx-auto space-y-8">
                                <div><h2 className="text-2xl font-bold text-slate-800">Consultation Dashboard</h2><p className="text-slate-500 text-sm">Track consultation and participation activities.</p></div>
                                <div className="grid grid-cols-3 gap-6">
                                    {[['Open', stats.open, 'fa-folder-open', 'orange'], ['In Progress', stats.inProgress, 'fa-spinner', 'blue'], ['Closed', stats.closed, 'fa-check-circle', 'emerald']].map(([l, v, i, c]) => (
                                        <div key={l} className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                            <div className="flex justify-between items-start"><div><p className="text-xs font-bold text-slate-400 uppercase">{l}</p><p className={`text-4xl font-bold text-${c}-500 mt-2`}>{v}</p></div><div className={`w-12 h-12 bg-${c}-50 rounded-xl flex items-center justify-center text-${c}-500`}><i className={`fas ${i} text-xl`}></i></div></div>
                                        </div>
                                    ))}
                                </div>
                                <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                                    <div className="p-6 border-b border-slate-100"><h3 className="font-bold text-slate-700">Action Item Tracker</h3></div>
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50"><tr><th className="p-4 font-bold text-slate-500 text-xs uppercase">Meeting</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Action</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Responsible</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Due</th><th className="p-4 font-bold text-slate-500 text-xs uppercase">Status</th><th className="p-4"></th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {formData.consultationLog.map((r, i) => (
                                                <tr key={i} className="hover:bg-slate-50">
                                                    <td className="p-4 font-medium text-slate-700">{r.meeting}</td>
                                                    <td className="p-4 text-slate-600 text-xs">{r.actions}</td>
                                                    <td className="p-4 text-blue-600 font-medium text-xs">{r.responsible}</td>
                                                    <td className="p-4 text-slate-500 font-mono text-xs">{r.due}</td>
                                                    <td className="p-4"><select className={`text-xs font-bold uppercase bg-transparent outline-none ${r.status === 'Closed' ? 'text-emerald-600' : r.status === 'In Progress' ? 'text-blue-500' : 'text-orange-500'}`} value={r.status} onChange={e => handleStatusChange(i, e.target.value)}><option>Open</option><option>In Progress</option><option>Closed</option></select></td>
                                                    <td className="p-4"><button onClick={() => deleteLogItem(i)} className="text-slate-300 hover:text-red-500"><i className="fas fa-trash"></i></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* CONSULTATION TAB */}
                        {activeTab === 'consultation' && (
                            <div className="max-w-4xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-slate-800">Log Consultation Activity</h2>
                                <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <input className="border-2 border-slate-200 p-4 rounded-xl focus:border-blue-500 outline-none" placeholder="Meeting Type (e.g., Safety Committee)" value={newItem.meeting} onChange={e => setNewItem({ ...newItem, meeting: e.target.value })} />
                                        <select className="border-2 border-slate-200 p-4 rounded-xl focus:border-blue-500 outline-none bg-white" value={newItem.option} onChange={e => setNewItem({ ...newItem, option: e.target.value })}><option value="">Select Requirement...</option>{CONSULT_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                    </div>
                                    <textarea className="w-full border-2 border-slate-200 p-4 rounded-xl focus:border-blue-500 outline-none h-24" placeholder="Discussion Details / Actions..." value={newItem.actions} onChange={e => setNewItem({ ...newItem, actions: e.target.value })}></textarea>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input className="border-2 border-slate-200 p-4 rounded-xl focus:border-blue-500 outline-none" placeholder="Responsible Person" value={newItem.responsible} onChange={e => setNewItem({ ...newItem, responsible: e.target.value })} />
                                        <input type="date" className="border-2 border-slate-200 p-4 rounded-xl focus:border-blue-500 outline-none" value={newItem.due} onChange={e => setNewItem({ ...newItem, due: e.target.value })} />
                                    </div>
                                    <button onClick={addLogItem} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-4 rounded-xl font-bold uppercase tracking-wider transition-colors">Add to Log</button>
                                </div>
                            </div>
                        )}

                        {/* POLICY TAB (UPDATED WITH NOTES) */}
                        {activeTab === 'policy' && (
                            <div className="max-w-4xl mx-auto space-y-6">
                                <div><h2 className="text-2xl font-bold text-slate-800">OH&S Policy (5.2)</h2><p className="text-slate-500 text-sm">Define your organization's safety commitments.</p></div>
                                <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                                    {[['a', 'Safe & Healthy Working Conditions', 'Commitment to prevent injury/ill health appropriate to size and context...'], ['b', 'Objectives Framework', 'How the policy supports the setting of safety objectives...'], ['c', 'Legal Requirements', 'Commitment to fulfill legal and other requirements...'], ['d', 'Hazard Elimination & Risk Reduction', 'Commitment to eliminate hazards and reduce OH&S risks (Ref 8.1.2)...'], ['e', 'Continual Improvement', 'Commitment to enhance OH&S management system performance...'], ['f', 'Consultation & Participation', 'Commitment to involve workers and their representatives...']].map(([k, l, p]) => (
                                        <div key={k}>
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2 mb-2"><span className="w-6 h-6 bg-blue-100 text-blue-600 rounded flex items-center justify-center text-xs font-bold">5.2({k})</span>{l}</label>
                                            <textarea className="w-full border-2 border-slate-200 p-4 rounded-xl focus:border-blue-500 outline-none h-24" placeholder={p} value={formData.policySpecifics?.[k] || ''} onChange={e => setFormData(p => ({ ...p, policySpecifics: { ...p.policySpecifics, [k]: e.target.value } }))} />
                                        </div>
                                    ))}

                                    {/* --- NEW SECTION: ADDITIONAL NOTES --- */}
                                    <div className="pt-6 border-t border-slate-100">
                                        <label className="text-sm font-bold text-slate-800 uppercase tracking-wider block mb-2"><i className="fas fa-sticky-note mr-2 text-orange-500"></i>Additional Notes / Policy Context</label>
                                        <textarea 
                                            className="w-full border-2 border-slate-200 p-4 rounded-xl focus:border-blue-500 outline-none h-32 bg-slate-50" 
                                            placeholder="Enter any additional details, scope information, or context relevant to the OH&S Policy..." 
                                            value={formData.policyText} 
                                            onChange={e => setFormData(p => ({ ...p, policyText: e.target.value }))} 
                                        />
                                    </div>

                                </div>
                            </div>
                        )}

                        {/* RASCI TAB */}
                        {activeTab === 'rasci' && (
                            <div className="max-w-6xl mx-auto space-y-6">
                                <div className="flex justify-between items-end"><div><h2 className="text-2xl font-bold text-slate-800">RASCI Matrix (5.3)</h2><p className="text-slate-500 text-sm">Define responsibilities for key processes.</p></div><div className="text-xs text-slate-400 bg-white px-4 py-2 rounded-lg border">R=Responsible, A=Accountable, S=Support, C=Consulted, I=Informed</div></div>
                                <div className="bg-white p-4 rounded-xl flex gap-3 items-center border border-slate-200"><span className="text-xs font-bold text-slate-500">Add Role:</span><input className="flex-1 border-2 border-slate-200 p-3 rounded-xl text-sm focus:border-blue-500 outline-none" placeholder="e.g. Fire Marshal" value={newRoleName} onChange={e => setNewRoleName(e.target.value)} /><button onClick={addRole} className="bg-blue-600 text-white px-6 py-3 rounded-xl text-xs font-bold hover:bg-blue-500">+ Add Role</button></div>
                                <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-800 text-white"><tr><th className="p-4 text-left min-w-[200px]">Process / Activity</th>{formData.definedRoles.map((r, i) => (<th key={i} className="p-4 text-center min-w-[100px]">{r.title}<button onClick={() => removeRole(i)} className="ml-2 text-slate-400 hover:text-red-400 text-xs"><i className="fas fa-times"></i></button></th>))}<th className="p-4 w-12"></th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {formData.rasciProcesses.map((pr, pi) => (
                                                <tr key={pi} className="hover:bg-slate-50">
                                                    <td className="p-4 font-medium text-slate-700">{pr.name}</td>
                                                    {formData.definedRoles.map((r, ri) => (<td key={ri} className="p-2 text-center border-l border-slate-100"><select className={`w-full text-center font-bold bg-transparent outline-none cursor-pointer ${getAssignment(pi, r.title) === 'R' ? 'text-red-600' : getAssignment(pi, r.title) === 'A' ? 'text-blue-600' : 'text-slate-400'}`} value={getAssignment(pi, r.title)} onChange={e => updateAssignment(pi, r.title, e.target.value)}><option value=""></option><option value="R">R</option><option value="A">A</option><option value="S">S</option><option value="C">C</option><option value="I">I</option></select></td>))}
                                                    <td className="p-4 text-center"><button onClick={() => removeProcess(pi)} className="text-slate-300 hover:text-red-500"><i className="fas fa-trash"></i></button></td>
                                                </tr>
                                            ))}
                                            <tr className="bg-slate-50"><td className="p-3"><input className="w-full p-3 border-2 border-slate-200 rounded-xl text-sm focus:border-blue-500 outline-none" placeholder="+ Add New Process" value={newProcessName} onChange={e => setNewProcessName(e.target.value)} /></td><td colSpan={formData.definedRoles.length + 1} className="p-3"><button onClick={addProcess} className="w-full bg-emerald-600 text-white py-3 rounded-xl text-xs font-bold hover:bg-emerald-500">Add Process Row</button></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
