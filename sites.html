<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO 45001 | Site Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { 'display': ['Space Grotesk', 'sans-serif'], 'mono': ['JetBrains Mono', 'monospace'] }, colors: { 'glass': 'rgba(30, 41, 59, 0.7)' } } } }
    </script>
    <style>
        body { font-family: 'Space Grotesk', sans-serif; background-color: #0f172a; color: white; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s; }
        .glass-panel:hover { border-color: rgba(59, 130, 246, 0.3); transform: translateY(-2px); box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        #google-map { width: 100%; height: 100%; border-radius: 0.75rem; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; } 
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script>window.initMapCallback = function() { window.isGoogleMapsLoaded = true; };</script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k&callback=initMapCallback&libraries=places" async defer></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, remove, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", 
            authDomain: "ohsms-fa534.firebaseapp.com",
            databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/",
            projectId: "ohsms-fa534",
            storageBucket: "ohsms-fa534.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { get, ref, set, remove, child };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- GOOGLE MAPS PICKER ---
        const MapModal = ({ onClose, onConfirm }) => {
            const mapRef = useRef(null);
            const [selected, setSelected] = useState(null);
            const [mapObj, setMapObj] = useState(null);

            useEffect(() => {
                if (!window.isGoogleMapsLoaded) { alert("Maps API loading..."); return; }
                const map = new google.maps.Map(mapRef.current, {
                    zoom: 5, center: { lat: 20.5937, lng: 78.9629 },
                    styles: [
                        { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                        { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                        { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                        { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] }
                    ]
                });
                setMapObj(map);
                map.addListener("click", (e) => handlePin(e.latLng, map));
            }, []);

            const handlePin = (latLng, map) => {
                if (window.currentMarker) window.currentMarker.setMap(null);
                window.currentMarker = new google.maps.Marker({ position: latLng, map, animation: google.maps.Animation.DROP });
                
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: latLng }, (res, status) => {
                    let city = "Unknown";
                    if (status === "OK" && res[0]) {
                        const comp = res[0].address_components;
                        const locality = comp.find(c => c.types.includes("locality"));
                        city = locality ? locality.long_name : res[0].formatted_address.split(',')[0];
                    }
                    setSelected({ lat: latLng.lat(), lng: latLng.lng(), city });
                });
            };

            const useGPS = () => {
                if(navigator.geolocation && mapObj) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        const ll = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                        mapObj.setCenter(ll); mapObj.setZoom(14);
                        handlePin(ll, mapObj);
                    });
                }
            };

            return (
                <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-6">
                    <div className="bg-slate-900 w-full max-w-4xl h-[80vh] rounded-2xl border border-slate-700 flex flex-col relative overflow-hidden">
                        <button onClick={onClose} className="absolute top-4 right-4 z-10 bg-slate-800 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-500 transition-colors"><i className="fas fa-times"></i></button>
                        <div ref={mapRef} id="google-map" className="flex-1"></div>
                        <div className="absolute bottom-6 left-6 right-6 flex gap-4">
                            <div className="bg-slate-900/90 backdrop-blur p-4 rounded-xl border border-slate-700 flex-1">
                                <p className="text-[10px] uppercase font-bold text-slate-500">Selected Location</p>
                                {selected ? <div><div className="font-bold text-lg">{selected.city}</div><div className="text-xs font-mono text-emerald-400">{selected.lat.toFixed(5)}, {selected.lng.toFixed(5)}</div></div> : <div className="text-sm text-slate-500 italic">Click map to pin location</div>}
                            </div>
                            <button onClick={useGPS} className="bg-slate-700 w-14 rounded-xl flex items-center justify-center text-white hover:bg-slate-600 border border-slate-600"><i className="fas fa-crosshairs text-xl"></i></button>
                            <button onClick={()=>selected && onConfirm(selected)} disabled={!selected} className={`px-8 rounded-xl font-bold ${selected?'bg-blue-600 text-white hover:bg-blue-500':'bg-slate-800 text-slate-600'}`}>Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [session, setSession] = useState(null);
            const [sites, setSites] = useState([]);
            const [showMap, setShowMap] = useState(false);
            const [form, setForm] = useState({ name: '', code: '', city: '', lat: null, lng: null });

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if (!s) { window.location.href = "index.html"; return; }
                const sess = JSON.parse(s);
                if(sess.role !== 'Owner') { alert("Access Denied."); window.location.href = "home.html"; return; }
                setSession(sess);
                fetchData(sess.orgId);
            }, []);

            const fetchData = async (orgId) => {
                const dbRef = window.fb.ref(window.db);
                const snap = await window.fb.get(window.fb.child(dbRef, `organizations/${orgId}/sites`));
                if(snap.exists()) setSites(Object.values(snap.val()));
                else setSites([]);
            };

            const addSite = async (e) => {
                e.preventDefault();
                if(!form.lat) { alert("Please use the map to pin the location."); return; }
                const newSite = { ...form, code: form.code.toUpperCase(), id: Date.now() };
                await window.fb.set(window.fb.ref(window.db, `organizations/${session.orgId}/sites/${newSite.code}`), newSite);
                setForm({ name: '', code: '', city: '', lat: null, lng: null });
                fetchData(session.orgId);
            };

            const deleteSite = async (code) => {
                if(!confirm(`Delete site ${code}?`)) return;
                await window.fb.remove(window.fb.ref(window.db, `organizations/${session.orgId}/sites/${code}`));
                fetchData(session.orgId);
            };

            if(!session) return null;

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-white">
                    {showMap && <MapModal onClose={()=>setShowMap(false)} onConfirm={(loc)=>{ setForm({...form, city: loc.city, lat: loc.lat, lng: loc.lng}); setShowMap(false); }} />}
                    
                    <div className="h-16 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-6">
                        <div className="flex items-center gap-4">
                            <a href="home.html" className="text-slate-400 hover:text-white"><i className="fas fa-arrow-left"></i> Back</a>
                            <h1 className="font-bold text-lg">Site Management</h1>
                        </div>
                        <span className="text-xs bg-slate-800 px-3 py-1 rounded text-slate-400">{session.orgId}</span>
                    </div>

                    <div className="p-8 max-w-7xl mx-auto w-full flex-1 overflow-y-auto">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            {/* ADD FORM */}
                            <div className="glass-panel p-6 rounded-2xl h-fit border border-blue-500/20">
                                <h2 className="font-bold text-lg mb-6 flex items-center gap-2 text-blue-400"><i className="fas fa-plus-circle"></i> Register Site</h2>
                                <form onSubmit={addSite} className="space-y-4">
                                    <div>
                                        <label className="text-[10px] uppercase font-bold text-slate-500">Site Code</label>
                                        <input value={form.code} onChange={e=>setForm({...form, code:e.target.value})} className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white outline-none focus:border-blue-500 font-mono uppercase" placeholder="e.g. HYD-01" required />
                                    </div>
                                    <div>
                                        <label className="text-[10px] uppercase font-bold text-slate-500">Site Name</label>
                                        <input value={form.name} onChange={e=>setForm({...form, name:e.target.value})} className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white outline-none focus:border-blue-500" placeholder="e.g. Hyderabad Plant" required />
                                    </div>
                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700 border-dashed">
                                        <label className="text-[10px] uppercase font-bold text-slate-500 block mb-2">Location</label>
                                        <div className="flex items-center gap-2 mb-3">
                                            <i className="fas fa-city text-purple-400"></i>
                                            <span className={form.city ? "text-white font-bold" : "text-slate-500 italic"}>{form.city || "No location set"}</span>
                                        </div>
                                        <button type="button" onClick={()=>setShowMap(true)} className={`w-full py-2 rounded-lg text-xs font-bold border transition-all flex items-center justify-center gap-2 ${form.lat ? 'bg-emerald-500/10 border-emerald-500 text-emerald-400' : 'bg-slate-700 border-slate-600 text-slate-400 hover:text-white'}`}>
                                            {form.lat ? 'Update Location' : 'Pin on Map'}
                                        </button>
                                    </div>
                                    <button className="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold text-sm shadow-lg">Save Site</button>
                                </form>
                            </div>

                            {/* LIST */}
                            <div className="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4 content-start">
                                {sites.length === 0 && <div className="col-span-full py-20 text-center text-slate-500 border-2 border-dashed border-slate-800 rounded-2xl">No sites registered yet.</div>}
                                {sites.map(s => (
                                    <div key={s.code} className="glass-panel p-5 rounded-2xl border-l-4 border-emerald-500 relative group animate-fade-in">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <span className="bg-slate-800 text-blue-300 border border-slate-700 px-2 py-1 rounded text-[10px] font-mono">{s.code}</span>
                                                <h3 className="font-bold text-lg mt-2">{s.name}</h3>
                                            </div>
                                            <button onClick={()=>deleteSite(s.code)} className="opacity-0 group-hover:opacity-100 transition-opacity bg-red-500/10 text-red-400 w-8 h-8 rounded flex items-center justify-center hover:bg-red-500 hover:text-white"><i className="fas fa-trash"></i></button>
                                        </div>
                                        <div className="mt-4 pt-4 border-t border-slate-700/50 flex justify-between items-center">
                                            <div className="text-sm text-slate-300"><i className="fas fa-map-marker-alt text-red-400 mr-2"></i>{s.city}</div>
                                            <div className="text-[10px] font-mono text-emerald-500 bg-emerald-900/20 px-2 py-1 rounded">{s.lat.toFixed(4)}, {s.lng.toFixed(4)}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
