<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO 45001 | Site Registry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Space Grotesk', sans-serif; }</style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [session, setSession] = useState(null);
            const [sites, setSites] = useState([]);
            const [users, setUsers] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [newSite, setNewSite] = useState({ name: '', code: '', location: '', ownerEmail: '' });

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if (!s) { window.location.href = "index.html"; return; }
                const sess = JSON.parse(s);

                if (sess.role !== 'Owner') {
                    alert("Access Denied: Only Organization Owners can manage sites.");
                    window.location.href = "home.html";
                    return;
                }
                setSession(sess);

                const dbKey = `ISO_DB_${sess.orgId}`;
                const db = JSON.parse(localStorage.getItem(dbKey) || '{}');
                setSites(db.sites || []);
                setUsers(db.users || []);
            }, []);

            const saveDB = (updates) => {
                const dbKey = `ISO_DB_${session.orgId}`;
                const db = JSON.parse(localStorage.getItem(dbKey));
                const newDB = { ...db, ...updates };
                localStorage.setItem(dbKey, JSON.stringify(newDB));
            };

            const handleAddSite = (e) => {
                e.preventDefault();
                
                if (sites.find(s => s.code.toLowerCase() === newSite.code.toLowerCase())) {
                    alert("Site code must be unique!");
                    return;
                }

                const ownerUser = users.find(u => u.email === newSite.ownerEmail);

                const siteObj = {
                    ...newSite,
                    code: newSite.code.toUpperCase(),
                    ownerName: ownerUser?.name || 'Unassigned',
                    id: `SITE-${Date.now().toString().substr(-6)}`,
                    created: new Date().toLocaleDateString()
                };

                const updatedSites = [...sites, siteObj];
                setSites(updatedSites);
                saveDB({ sites: updatedSites });
                setShowModal(false);
                setNewSite({ name: '', code: '', location: '', ownerEmail: '' });
            };

            const handleDelete = (code) => {
                if (!confirm("Delete this site? This will not delete associated documents.")) return;
                const updatedSites = sites.filter(s => s.code !== code);
                setSites(updatedSites);
                saveDB({ sites: updatedSites });
            };

            if (!session) return null;

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <header className="bg-slate-900 text-white">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <a href="home.html" className="w-10 h-10 bg-slate-800 rounded-xl flex items-center justify-center text-slate-400 hover:text-white transition-colors">
                                    <i className="fas fa-arrow-left"></i>
                                </a>
                                <div>
                                    <h1 className="text-lg font-bold">Site Registry</h1>
                                    <p className="text-xs text-slate-400 font-mono">{session.orgId} - Location Management</p>
                                </div>
                            </div>
                            <button onClick={() => setShowModal(true)} className="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold text-xs uppercase flex items-center gap-2 transition-colors shadow-lg shadow-indigo-500/20">
                                <i className="fas fa-building-circle-check"></i> Register Site
                            </button>
                        </div>
                    </header>

                    {/* Add Site Modal */}
                    {showModal && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl">
                                <h3 className="text-xl font-bold text-slate-800 mb-6">Register New Site</h3>
                                <form onSubmit={handleAddSite} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Site Name</label>
                                            <input required className="w-full border-2 border-slate-200 p-4 rounded-xl focus:border-indigo-500 outline-none" placeholder="e.g. Texas Plant" value={newSite.name} onChange={e => setNewSite({ ...newSite, name: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Site Code</label>
                                            <input required className="w-full border-2 border-slate-200 p-4 rounded-xl focus:border-indigo-500 outline-none font-mono uppercase" placeholder="e.g. TX-01" value={newSite.code} onChange={e => setNewSite({ ...newSite, code: e.target.value.toUpperCase() })} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Location / Address</label>
                                        <input required className="w-full border-2 border-slate-200 p-4 rounded-xl focus:border-indigo-500 outline-none" placeholder="City, State, Country" value={newSite.location} onChange={e => setNewSite({ ...newSite, location: e.target.value })} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Assign Site Owner</label>
                                        <select className="w-full border-2 border-slate-200 p-4 rounded-xl focus:border-indigo-500 outline-none bg-white" value={newSite.ownerEmail} onChange={e => setNewSite({ ...newSite, ownerEmail: e.target.value })}>
                                            <option value="">Select a User...</option>
                                            {users.map(u => <option key={u.email} value={u.email}>{u.name} ({u.role})</option>)}
                                        </select>
                                        <p className="text-[10px] text-slate-400 mt-1">Only registered users appear here.</p>
                                    </div>
                                    <div className="flex gap-4 pt-4">
                                        <button type="button" onClick={() => setShowModal(false)} className="flex-1 py-4 rounded-xl font-bold bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors">Cancel</button>
                                        <button type="submit" className="flex-1 py-4 rounded-xl font-bold bg-indigo-600 text-white hover:bg-indigo-500 transition-colors">Create Site</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-6 py-8">
                        
                        {/* Stats */}
                        <div className="grid grid-cols-3 gap-6 mb-8">
                            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <p className="text-xs font-bold text-slate-400 uppercase">Total Sites</p>
                                <p className="text-3xl font-bold text-slate-800 mt-1">{sites.length}</p>
                            </div>
                            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <p className="text-xs font-bold text-slate-400 uppercase">Active Locations</p>
                                <p className="text-3xl font-bold text-indigo-600 mt-1">{sites.length}</p>
                            </div>
                            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <p className="text-xs font-bold text-slate-400 uppercase">Users Assigned</p>
                                <p className="text-3xl font-bold text-emerald-600 mt-1">{users.filter(u => u.assignedSite).length}</p>
                            </div>
                        </div>

                        {/* Sites Grid */}
                        {sites.length === 0 ? (
                            <div className="bg-white p-16 rounded-2xl border border-slate-200 text-center">
                                <div className="w-20 h-20 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                    <i className="fas fa-map-location-dot text-3xl text-slate-300"></i>
                                </div>
                                <h3 className="text-lg font-bold text-slate-600 mb-2">No Sites Registered</h3>
                                <p className="text-slate-400 text-sm mb-6">Start by adding your first operational site.</p>
                                <button onClick={() => setShowModal(true)} className="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold text-sm transition-colors">
                                    <i className="fas fa-plus mr-2"></i> Add First Site
                                </button>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {sites.map((site, i) => (
                                    <div key={i} className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:border-indigo-300 transition-colors group relative overflow-hidden">
                                        <div className="absolute top-0 right-0 w-24 h-24 bg-indigo-50 rounded-full blur-2xl -mr-12 -mt-12 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                        
                                        <div className="relative">
                                            <div className="flex justify-between items-start mb-4">
                                                <div className="w-14 h-14 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600 text-xl">
                                                    <i className="fas fa-industry"></i>
                                                </div>
                                                <button onClick={() => handleDelete(site.code)} className="p-2 text-slate-300 hover:text-red-500 transition-colors">
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            
                                            <h3 className="text-xl font-bold text-slate-800 mb-1">{site.name}</h3>
                                            <div className="flex items-center gap-2 mb-4">
                                                <span className="bg-slate-100 text-slate-600 text-xs font-mono font-bold px-2 py-1 rounded">{site.code}</span>
                                                <span className="text-slate-400 text-xs flex items-center gap-1">
                                                    <i className="fas fa-map-marker-alt"></i> {site.location}
                                                </span>
                                            </div>
                                            
                                            <div className="pt-4 border-t border-slate-100">
                                                <p className="text-[10px] text-slate-400 font-bold uppercase mb-2">Site Owner</p>
                                                <div className="flex items-center gap-2">
                                                    <div className="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center text-indigo-600 text-xs">
                                                        <i className="fas fa-user"></i>
                                                    </div>
                                                    <span className="text-sm font-medium text-slate-700">{site.ownerName || 'Unassigned'}</span>
                                                </div>
                                            </div>

                                            <div className="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center">
                                                <span className="text-[10px] text-slate-400">Created: {site.created}</span>
                                                <span className="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded">Active</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
