<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Safety Assistant | Enterprise Hub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'sans': ['Space Grotesk', 'sans-serif'], 'mono': ['JetBrains Mono', 'monospace'] },
                    colors: { 'slate-850': '#1e293b', 'slate-950': '#020617' },
                    animation: { 'bounce-slow': 'bounce 3s infinite' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.5; animation: fadeIn 0.3s ease-out; }
        .user-bubble { background: #3b82f6; color: white; border-bottom-right-radius: 2px; align-self: flex-end; }
        .bot-bubble { background: #1e293b; border: 1px solid #334155; color: #e2e8f0; border-bottom-left-radius: 2px; align-self: flex-start; }
        .typing-dot { width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; display: inline-block; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, get, child, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", authDomain: "ohsms-fa534.firebaseapp.com", databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/", projectId: "ohsms-fa534", storageBucket: "ohsms-fa534.appspot.com", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { ref, push, get, child, update };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect } = React;

        const SCENARIOS = {
            IDLE: 'IDLE',
            INCIDENT_TYPE: 'INCIDENT_TYPE',
            INCIDENT_DESC: 'INCIDENT_DESC',
            INCIDENT_SEVERITY: 'INCIDENT_SEVERITY',
            INCIDENT_REVIEW: 'INCIDENT_REVIEW',
            TRAINING_TOPIC: 'TRAINING_TOPIC',
            TRAINING_ATTENDEES: 'TRAINING_ATTENDEES',
            TRAINING_REVIEW: 'TRAINING_REVIEW'
        };

        const ChatBot = () => {
            const [session, setSession] = useState(null);
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [state, setState] = useState(SCENARIOS.IDLE);
            const [draft, setDraft] = useState({});
            const chatEndRef = useRef(null);

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) { window.location.href='index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);
                addBotMessage(`Hi ${sess.user.split(' ')[0]}. I can help you report data or find anything in the system.`, [
                    { label: 'ðŸ” Search Everything', value: 'HELP_SEARCH' },
                    { label: 'âš ï¸ Report Incident', value: 'START_INCIDENT' },
                    { label: 'ðŸ“š Log Training', value: 'START_TRAINING' },
                    { label: 'ðŸ“‹ My Tasks', value: 'SHOW_TASKS' }
                ]);
            }, []);

            useLayoutEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isTyping]);

            const addBotMessage = (text, options = null, type = 'text', data = null) => {
                setIsTyping(true);
                setTimeout(() => {
                    setMessages(prev => [...prev, { sender: 'bot', text, options, type, data }]);
                    setIsTyping(false);
                }, 600);
            };

            const addUserMessage = (text) => setMessages(prev => [...prev, { sender: 'user', text }]);

            // --- UNIVERSAL SWEEP FUNCTION ---
            const performSweep = async (query) => {
                setIsTyping(true);
                try {
                    const orgRef = window.fb.child(window.fb.ref(window.db), `organizations/${session.orgId}`);
                    const snap = await window.fb.get(orgRef);
                    
                    if (!snap.exists()) {
                        addBotMessage("System is empty.");
                        return;
                    }

                    const val = snap.val();
                    const results = [];
                    const q = query.toLowerCase();

                    // 1. INCIDENTS
                    if (val.incidents) {
                        Object.entries(val.incidents).forEach(([k, v]) => {
                            if (v.description.toLowerCase().includes(q) || v.type.toLowerCase().includes(q) || v.id.toLowerCase().includes(q)) {
                                results.push({ type: 'Incident', title: `${v.type}: ${v.description.substring(0,30)}...`, id: v.id, link: `incidents.html?site=${session.assignedSite}&highlight=${k}`, icon: 'fa-triangle-exclamation', color: 'text-orange-400' });
                            }
                        });
                    }

                    // 2. DOCUMENTS
                    if (val.standards) {
                        Object.entries(val.standards).forEach(([k, v]) => {
                            if (v.title.toLowerCase().includes(q) || v.category.toLowerCase().includes(q)) {
                                results.push({ type: 'Document', title: v.title, id: `v${v.version}`, link: v.file, external: true, icon: 'fa-file-pdf', color: 'text-blue-400' });
                            }
                        });
                    }

                    // 3. CAPA (Actions)
                    if (val.incidents) { // Searching CAPA inside incidents
                         Object.entries(val.incidents).forEach(([k, v]) => {
                            if(v.capa) {
                                v.capa.forEach(c => {
                                    if(c.action.toLowerCase().includes(q) || c.assignedTo.toLowerCase().includes(q)) {
                                        results.push({ type: 'CAPA', title: c.action, id: c.status, link: `capa.html?site=${session.assignedSite}`, icon: 'fa-check-double', color: 'text-emerald-400' });
                                    }
                                });
                            }
                        });
                    }

                    // 4. AUDITS
                    if (val.audits) {
                        Object.entries(val.audits).forEach(([k, v]) => {
                            if (v.title.toLowerCase().includes(q) || v.auditor.toLowerCase().includes(q)) {
                                results.push({ type: 'Audit', title: v.title, id: v.date, link: `audit.html?site=${session.assignedSite}`, icon: 'fa-clipboard-check', color: 'text-purple-400' });
                            }
                        });
                    }
                     // 5. TRAINING
                     if (val.trainingRecords) {
                        Object.entries(val.trainingRecords).forEach(([k, v]) => {
                            if (v.topic.toLowerCase().includes(q) || v.user.toLowerCase().includes(q)) {
                                results.push({ type: 'Training', title: `${v.topic} - ${v.user}`, id: v.date, link: `training.html?site=${session.assignedSite}`, icon: 'fa-graduation-cap', color: 'text-yellow-400' });
                            }
                        });
                    }

                    if (results.length > 0) {
                        addBotMessage(`I found ${results.length} matches across the system:`, null, 'search_results', results.slice(0, 10)); // Limit to 10
                    } else {
                        addBotMessage(`I searched Incidents, Docs, Training, and Audits but found nothing for "${query}".`);
                    }

                } catch (e) {
                    addBotMessage("Error during system sweep: " + e.message);
                }
                setIsTyping(false);
            };

            const findMyTasks = async () => {
                performSweep(session.user); // Simple heuristic: search for own name
            };

            // --- MAIN LOGIC ---
            const handleInput = (text, payload = null) => {
                if(!text.trim() && !payload) return;
                if(text) addUserMessage(text);
                const val = payload || text;

                // GLOBAL KEYWORD INTERCEPTOR (If user types "audit" while in IDLE)
                if (state === SCENARIOS.IDLE && !payload) {
                    const lower = val.toLowerCase();
                    if (lower.includes('audit')) { addBotMessage("Opening Audit Module...", [{ label: 'Go to Audits', value: 'NAV_AUDIT' }]); return; }
                    if (lower.includes('risk')) { addBotMessage("Opening Risk Assessment...", [{ label: 'Go to Risk', value: 'NAV_RISK' }]); return; }
                    if (lower.includes('search') || lower.includes('find') || lower.includes('show')) {
                        // Extract query
                        const query = lower.replace(/search|find|show|me/g, '').trim();
                        if(query) { performSweep(query); return; }
                    }
                    if (lower.length > 3) { performSweep(lower); return; } // Default to search if it's a specific word
                }

                switch(state) {
                    case SCENARIOS.IDLE:
                        if (val === 'START_INCIDENT') {
                            setState(SCENARIOS.INCIDENT_TYPE);
                            setDraft({ siteId: session.assignedSite || 'GLOBAL', date: new Date().toISOString().split('T')[0] });
                            addBotMessage("What type of incident?", [{ label: 'Near Miss', value: 'Near Miss' }, { label: 'First Aid', value: 'First Aid injury' }, { label: 'Property Damage', value: 'Property Damage' }]);
                        } else if (val === 'START_TRAINING') {
                            setState(SCENARIOS.TRAINING_TOPIC);
                            setDraft({ date: new Date().toISOString().split('T')[0], trainer: session.user });
                            addBotMessage("Topic?", [{ label: 'Fire Safety', value: 'Fire Safety' }, { label: 'LOTO', value: 'LOTO' }]);
                        } else if (val === 'HELP_SEARCH') {
                            addBotMessage("Just type what you are looking for. E.g., 'Fire', 'John Doe', 'Audit 2024'.");
                        } else if (val === 'SHOW_TASKS') {
                            findMyTasks();
                        } else if (val.startsWith('NAV_')) {
                            // Navigation Handler
                            const mod = val.split('_')[1].toLowerCase();
                            window.location.href = `${mod}.html?site=${session.assignedSite}`;
                        } else {
                            performSweep(val); // Default fallback
                        }
                        break;

                    // ... (Keep existing Incident/Training Flows logic here) ...
                     case SCENARIOS.INCIDENT_TYPE:
                        setDraft(prev => ({ ...prev, type: val })); setState(SCENARIOS.INCIDENT_DESC); addBotMessage("Describe it:"); break;
                    case SCENARIOS.INCIDENT_DESC:
                        setDraft(prev => ({ ...prev, description: val })); setState(SCENARIOS.INCIDENT_SEVERITY); addBotMessage("Severity?", [{ label: 'Minor', value: 'Level A' }, { label: 'Major', value: 'Level D' }]); break;
                    case SCENARIOS.INCIDENT_SEVERITY:
                         const finalDraft = { ...draft, severity: val }; setDraft(finalDraft); setState(SCENARIOS.INCIDENT_REVIEW);
                        addBotMessage("Review:", [{ label: 'âœ… Submit', value: 'SUBMIT_INCIDENT' }, { label: 'Cancel', value: 'CANCEL' }], 'review_incident', finalDraft); break;
                    case SCENARIOS.INCIDENT_REVIEW:
                        if (val === 'SUBMIT_INCIDENT') saveIncident(draft); else { setState(SCENARIOS.IDLE); addBotMessage("Cancelled."); } break;
                    case SCENARIOS.TRAINING_TOPIC:
                         setDraft(prev => ({...prev, topic: val})); setState(SCENARIOS.TRAINING_ATTENDEES); addBotMessage("Attendees (comma separated):"); break;
                    case SCENARIOS.TRAINING_ATTENDEES:
                        const names = val.split(',').map(n => n.trim()).filter(n => n); setDraft({ ...draft, attendees: names }); setState(SCENARIOS.TRAINING_REVIEW);
                        addBotMessage(`Review: ${draft.topic} for ${names.length} people.`, [{ label: 'âœ… Save', value: 'SUBMIT_TRAINING' }]); break;
                    case SCENARIOS.TRAINING_REVIEW:
                         if (val === 'SUBMIT_TRAINING') saveTraining(draft); else { setState(SCENARIOS.IDLE); addBotMessage("Cancelled."); } break;
                }
            };

            const saveIncident = async (data) => {
                await window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/incidents`), { ...data, id: `INC-AI-${Date.now().toString().slice(-4)}`, timestamp: new Date().toISOString() });
                addBotMessage("âœ… Incident reported."); setState(SCENARIOS.IDLE);
            };
            const saveTraining = async (data) => {
                 const batch = data.attendees.map(name => window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/trainingRecords`), { topic: data.topic, date: data.date, user: name, trainer: data.trainer, siteId: session.assignedSite||'GEN', createdBy: session.user, timestamp: new Date().toISOString() }));
                 await Promise.all(batch); addBotMessage("âœ… Training logged."); setState(SCENARIOS.IDLE);
            };

            return (
                <div className="flex flex-col h-screen bg-slate-950">
                    <div className="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 shadow-lg z-10">
                        <div className="flex items-center gap-3"><a href="home.html" className="text-slate-400 hover:text-white"><i className="fas fa-arrow-left"></i></a><h1 className="font-bold text-white text-sm">AI Safety Assistant</h1></div>
                        <button onClick={() => window.location.reload()} className="text-slate-500 hover:text-white"><i className="fas fa-rotate-right"></i></button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4 chat-scroll bg-gradient-to-b from-slate-950 to-slate-900">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex flex-col ${m.sender === 'user' ? 'items-end' : 'items-start'}`}>
                                <div className={`chat-bubble ${m.sender === 'user' ? 'user-bubble' : 'bot-bubble'}`}>
                                    {m.text}
                                    {/* SEARCH RESULTS RENDERER */}
                                    {m.type === 'search_results' && (
                                        <div className="mt-3 space-y-2 w-72">
                                            {m.data.map((res, idx) => (
                                                <div key={idx} className="bg-slate-800/80 p-3 rounded-lg border border-slate-700 hover:border-indigo-500 transition group relative">
                                                    <div className="flex justify-between items-start">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <i className={`fas ${res.icon} ${res.color}`}></i>
                                                            <span className={`text-[10px] uppercase font-bold ${res.color}`}>{res.type}</span>
                                                        </div>
                                                        <span className="text-[9px] text-slate-500">{res.id}</span>
                                                    </div>
                                                    <div className="text-xs font-bold text-white mb-2">{res.title}</div>
                                                    {res.external ? (
                                                        <a href={res.link} download target="_blank" className="block text-center bg-slate-700 hover:bg-slate-600 text-xs py-1.5 rounded text-white font-bold transition">Download File</a>
                                                    ) : (
                                                        <a href={res.link} className="block text-center bg-indigo-600 hover:bg-indigo-500 text-xs py-1.5 rounded text-white font-bold transition">Go to Record</a>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                     {m.type === 'review_incident' && (
                                        <div className="mt-3 bg-slate-800 p-3 rounded border border-slate-700 text-xs w-64">
                                            <div className="mb-1"><span className="text-slate-400">Type:</span> <b>{m.data.type}</b></div>
                                            <div className="mb-1"><span className="text-slate-400">Severity:</span> <b className="text-yellow-400">{m.data.severity}</b></div>
                                            <p className="bg-slate-900 p-2 rounded italic text-slate-300">{m.data.description}</p>
                                        </div>
                                    )}
                                </div>
                                {m.options && (
                                    <div className="flex flex-wrap gap-2 mt-2 max-w-[85%]">
                                        {m.options.map((opt, k) => (
                                            <button key={k} onClick={() => handleInput(null, opt.value)} className="bg-slate-800 hover:bg-indigo-600 border border-slate-700 text-white text-xs px-3 py-2 rounded-full transition-all shadow-sm">{opt.label}</button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                        {isTyping && <div className="bot-bubble chat-bubble w-16 flex items-center justify-center gap-1"><div className="typing-dot"></div><div className="typing-dot"></div><div className="typing-dot"></div></div>}
                        <div ref={chatEndRef}></div>
                    </div>

                    <div className="p-4 bg-slate-900 border-t border-slate-800">
                        <div className="flex gap-2 max-w-4xl mx-auto">
                            <input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && (handleInput(input), setInput(''))} placeholder="Ask anything... (e.g. 'Audit', 'Fire', 'Show tasks')" className="flex-1 bg-slate-800 border border-slate-700 text-white px-4 py-3 rounded-xl focus:border-indigo-500 focus:outline-none placeholder-slate-500" />
                            <button onClick={() => { handleInput(input); setInput(''); }} className="bg-indigo-600 hover:bg-indigo-500 text-white w-12 rounded-xl flex items-center justify-center transition-colors"><i className="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChatBot />);
    </script>
</body>
</html>
