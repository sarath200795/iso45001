<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Incident Manager | ERP</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Space Grotesk', 'sans-serif'] },
                    colors: { 'slate-850': '#1e293b', 'slate-950': '#020617' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; width: 100%; outline: none; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #3b82f6; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* TREE LINES FOR ETA */
        .tree-line { position: absolute; background: #475569; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", authDomain: "ohsms-fa534.firebaseapp.com", databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/", projectId: "ohsms-fa534", storageBucket: "ohsms-fa534.appspot.com", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { ref, get, push, update, remove };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- KNOWLEDGE BASE FOR SUGGESTIONS ---
        const INCIDENT_KB = {
            "Fire": {
                actions: ["Activate Fire Alarm immediately", "Evacuate via nearest exit", "Do not use elevators", "Account for all personnel", "Isolate electrical supply"],
                eta_barriers: ["Smoke Detector", "Sprinkler System", "Fire Door Closure", "Emergency Evacuation"]
            },
            "Chemical Spill": {
                actions: ["Evacuate affected area", "Consult MSDS/SDS", "Don Chemical Suit & Respirator", "Block drains/manholes", "Use Spill Kit absorbents"],
                eta_barriers: ["Bund Wall / Containment", "Leak Detection Sensor", "Spill Response Team", "PPE Effectiveness"]
            },
            "Work at Height (Fall)": {
                actions: ["Do not move the injured person", "Call Emergency Response Team", "Secure the area from falling objects", "Check for harness suspension trauma"],
                eta_barriers: ["Guardrails", "Safety Net", "Safety Harness (PPE)", "Lanyard Anchor Point"]
            },
            "Machinery Entanglement": {
                actions: ["Hit Emergency Stop immediately", "Isolate power (LOTO)", "Do not attempt to pull victim free if stuck", "Call Medical Aid"],
                eta_barriers: ["Machine Guarding", "Emergency Stop Button", "Light Curtain Sensor", "Operator Training"]
            },
            "Electrical Shock": {
                actions: ["Do not touch the victim", "Isolate power source", "Use non-conductive object to separate victim", "Begin CPR if trained and safe"],
                eta_barriers: ["ELCB/RCCB Trip", "Insulation Mats", "LOTO Procedure", "PPE (Gloves)"]
            }
        };

        const IncidentApp = () => {
            const [session, setSession] = useState(null);
            const [view, setView] = useState('list'); // list | form | investigation
            const [incidents, setIncidents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedIncident, setSelectedIncident] = useState(null);

            // Form State
            const [form, setForm] = useState({
                id: '', type: '', date: '', time: '', location: '', severity: 'Minor', description: '',
                immediateActions: [], 
                investigation: { 
                    method: '5Why', 
                    fiveWhys: ["", "", "", "", ""], 
                    rootCause: "",
                    eta: { initiatingEvent: "", barriers: [] } // { name: "", success: "", fail: "" }
                },
                capa: []
            });

            // LOAD DATA
            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) { window.location.href='index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);

                const fetchData = async () => {
                    const dbRef = window.fb.ref(window.db, `organizations/${sess.orgId}/incidents`);
                    const snap = await window.fb.get(dbRef);
                    if(snap.exists()) {
                        setIncidents(Object.entries(snap.val()).map(([k,v]) => ({...v, firebaseKey: k})));
                    }
                    setLoading(false);
                };
                fetchData();
            }, []);

            // --- SMART LOGIC ---
            const handleTypeChange = (type) => {
                setForm(prev => ({
                    ...prev, 
                    type: type,
                    immediateActions: INCIDENT_KB[type]?.actions.map(a => ({ desc: a, done: false })) || [],
                    investigation: {
                        ...prev.investigation,
                        eta: { ...prev.investigation.eta, initiatingEvent: type, barriers: [] }
                    }
                }));
            };

            const check5WhySmart = (val, idx) => {
                const weakWords = ["human error", "forgot", "mistake", "careless", "didn't know"];
                if (weakWords.some(w => val.toLowerCase().includes(w))) {
                    return "⚠️ Weak Cause: Dig deeper into the system/process failure.";
                }
                return null;
            };

            // --- CRUD ---
            const saveIncident = async () => {
                const payload = { ...form, updatedBy: session.user, updatedAt: new Date().toISOString() };
                if (form.firebaseKey) {
                    await window.fb.update(window.fb.ref(window.db, `organizations/${session.orgId}/incidents/${form.firebaseKey}`), payload);
                } else {
                    payload.status = 'Open';
                    payload.docId = `INC-${Date.now().toString().slice(-6)}`;
                    await window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/incidents`), payload);
                }
                alert("Incident Report Saved!");
                window.location.reload();
            };

            const toggleAction = (idx) => {
                const newActions = [...form.immediateActions];
                newActions[idx].done = !newActions[idx].done;
                setForm({...form, immediateActions: newActions});
            };

            // --- RENDER HELPERS ---
            if(loading) return <div className="flex h-screen items-center justify-center text-white">Loading Incidents...</div>;

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-white font-sans overflow-hidden">
                    
                    {/* Header */}
                    <div className="h-16 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-6">
                        <div className="flex items-center gap-4">
                            <a href="home.html" className="text-slate-400 hover:text-white flex items-center gap-2"><i className="fas fa-arrow-left"></i> Back</a>
                            <h1 className="font-bold text-lg">Smart Incident Manager</h1>
                        </div>
                        <div className="flex bg-slate-800 p-1 rounded-lg gap-1">
                            <button onClick={()=>setView('list')} className={`px-4 py-1.5 rounded text-xs font-bold uppercase transition ${view==='list'?'bg-orange-600 text-white':'text-slate-400 hover:text-white'}`}>Dashboard</button>
                            <button onClick={()=>{
                                setForm({
                                    id:'', type:'', date: new Date().toISOString().split('T')[0], time:'', location:'', severity:'Minor', description:'',
                                    immediateActions: [], investigation: { method: '5Why', fiveWhys: ["", "", "", "", ""], rootCause: "", eta: { initiatingEvent: "", barriers: [] } }, capa: []
                                });
                                setView('form');
                            }} className={`px-4 py-1.5 rounded text-xs font-bold uppercase transition ${view==='form'?'bg-orange-600 text-white':'text-slate-400 hover:text-white'}`}>Report Incident</button>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-8 custom-scroll">
                        <div className="max-w-6xl mx-auto">

                            {/* 1. DASHBOARD VIEW */}
                            {view === 'list' && (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div className="glass-panel p-6 rounded-xl border-l-4 border-red-500">
                                            <div className="text-slate-400 text-xs uppercase font-bold">Open Incidents</div>
                                            <div className="text-3xl font-bold">{incidents.filter(i=>i.status!=='Closed').length}</div>
                                        </div>
                                        <div className="glass-panel p-6 rounded-xl border-l-4 border-yellow-500">
                                            <div className="text-slate-400 text-xs uppercase font-bold">Investigation Pending</div>
                                            <div className="text-3xl font-bold">{incidents.filter(i=>!i.investigation?.rootCause).length}</div>
                                        </div>
                                        <div className="glass-panel p-6 rounded-xl border-l-4 border-emerald-500">
                                            <div className="text-slate-400 text-xs uppercase font-bold">Actions Closed</div>
                                            <div className="text-3xl font-bold">0</div>
                                        </div>
                                    </div>

                                    <div className="glass-panel rounded-xl overflow-hidden">
                                        <table className="w-full text-left text-sm text-slate-300">
                                            <thead className="bg-slate-900 text-xs uppercase font-bold text-slate-500">
                                                <tr><th className="p-4">ID</th><th className="p-4">Type</th><th className="p-4">Date</th><th className="p-4">Severity</th><th className="p-4">Status</th><th className="p-4 text-right">Action</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-800">
                                                {incidents.map(inc => (
                                                    <tr key={inc.firebaseKey} className="hover:bg-slate-800/50">
                                                        <td className="p-4 font-mono text-orange-400">{inc.docId}</td>
                                                        <td className="p-4">{inc.type}</td>
                                                        <td className="p-4">{inc.date}</td>
                                                        <td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${inc.severity==='Major'?'bg-red-500/20 text-red-400':'bg-blue-500/20 text-blue-400'}`}>{inc.severity}</span></td>
                                                        <td className="p-4">{inc.status}</td>
                                                        <td className="p-4 text-right">
                                                            <button onClick={()=>{setForm(inc); setView('investigation');}} className="text-blue-400 hover:text-white px-3 py-1 rounded hover:bg-slate-700 mr-2"><i className="fas fa-microscope"></i> Investigate</button>
                                                            <button onClick={()=>{setForm(inc); setView('form');}} className="text-slate-400 hover:text-white px-3 py-1 rounded hover:bg-slate-700"><i className="fas fa-edit"></i></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* 2. REPORT FORM */}
                            {view === 'form' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="glass-panel p-6 rounded-xl border-l-4 border-orange-500">
                                        <h3 className="font-bold text-lg mb-4">Incident Details</h3>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="lbl">Incident Type</label><select value={form.type} onChange={e=>handleTypeChange(e.target.value)}>{Object.keys(INCIDENT_KB).map(t=><option key={t}>{t}</option>)}</select></div>
                                            <div><label className="lbl">Severity</label><select value={form.severity} onChange={e=>setForm({...form, severity:e.target.value})}><option>Minor</option><option>Major</option><option>Critical</option><option>Near Miss</option></select></div>
                                            <div><label className="lbl">Date</label><input type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} /></div>
                                            <div><label className="lbl">Time</label><input type="time" value={form.time} onChange={e=>setForm({...form, time:e.target.value})} /></div>
                                            <div className="col-span-2"><label className="lbl">Location</label><input value={form.location} onChange={e=>setForm({...form, location:e.target.value})} placeholder="Where did it happen?" /></div>
                                            <div className="col-span-2"><label className="lbl">Description</label><textarea rows="3" value={form.description} onChange={e=>setForm({...form, description:e.target.value})} placeholder="What happened?"></textarea></div>
                                        </div>
                                    </div>

                                    {form.immediateActions.length > 0 && (
                                        <div className="glass-panel p-6 rounded-xl border-l-4 border-blue-500">
                                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><i className="fas fa-robot text-blue-400"></i> Smart Suggested Actions</h3>
                                            <div className="space-y-2">
                                                {form.immediateActions.map((act, i) => (
                                                    <label key={i} className="flex items-center gap-3 p-3 bg-slate-900/50 rounded hover:bg-slate-900 cursor-pointer">
                                                        <input type="checkbox" checked={act.done} onChange={()=>toggleAction(i)} className="accent-blue-500 w-4 h-4" />
                                                        <span className={act.done ? 'text-slate-500 line-through' : 'text-white'}>{act.desc}</span>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <div className="flex justify-end"><button onClick={saveIncident} className="bg-orange-600 hover:bg-orange-500 text-white px-8 py-3 rounded-xl font-bold">Save Report</button></div>
                                </div>
                            )}

                            {/* 3. SMART INVESTIGATION VIEW */}
                            {view === 'investigation' && (
                                <div className="space-y-8 animate-fade-in">
                                    <div className="glass-panel p-4 rounded-xl flex justify-between items-center">
                                        <div>
                                            <h2 className="font-bold text-xl">{form.type} - {form.docId}</h2>
                                            <p className="text-slate-400 text-sm">{form.description}</p>
                                        </div>
                                        <div className="flex bg-slate-900 p-1 rounded">
                                            <button onClick={()=>setForm({...form, investigation: {...form.investigation, method: '5Why'}})} className={`px-4 py-1 rounded text-xs font-bold ${form.investigation.method==='5Why'?'bg-blue-600':'text-slate-400'}`}>5 Whys</button>
                                            <button onClick={()=>setForm({...form, investigation: {...form.investigation, method: 'ETA'}})} className={`px-4 py-1 rounded text-xs font-bold ${form.investigation.method==='ETA'?'bg-purple-600':'text-slate-400'}`}>Event Tree</button>
                                        </div>
                                    </div>

                                    {/* 5 WHYS TOOL */}
                                    {form.investigation.method === '5Why' && (
                                        <div className="glass-panel p-8 rounded-xl border-l-4 border-blue-500">
                                            <h3 className="font-bold text-lg mb-6">Root Cause Analysis (5 Whys)</h3>
                                            <div className="space-y-4">
                                                {form.investigation.fiveWhys.map((why, i) => {
                                                    const warning = check5WhySmart(why, i);
                                                    return (
                                                        <div key={i} className="relative pl-8 border-l-2 border-slate-700 pb-4">
                                                            <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-blue-600 flex items-center justify-center text-[10px] font-bold">{i+1}</div>
                                                            <label className="text-xs font-bold text-blue-400 uppercase mb-1 block">Why did {i===0 ? 'the incident occur' : 'that happen'}?</label>
                                                            <input 
                                                                value={why} 
                                                                onChange={e=>{
                                                                    const newWhys = [...form.investigation.fiveWhys];
                                                                    newWhys[i] = e.target.value;
                                                                    setForm({...form, investigation: {...form.investigation, fiveWhys: newWhys}});
                                                                }}
                                                                className="bg-slate-900 w-full p-3 rounded border border-slate-700 focus:border-blue-500"
                                                                placeholder={i===0 ? "e.g. The machine stopped working..." : "Because..."}
                                                            />
                                                            {warning && <div className="mt-1 text-xs text-yellow-400 flex items-center gap-1"><i className="fas fa-lightbulb"></i> {warning}</div>}
                                                        </div>
                                                    );
                                                })}
                                                <div>
                                                    <label className="lbl">Conclusion: Root Cause</label>
                                                    <textarea 
                                                        value={form.investigation.rootCause} 
                                                        onChange={e=>setForm({...form, investigation: {...form.investigation, rootCause: e.target.value}})}
                                                        className="w-full bg-slate-900 border-green-500/50 p-3 rounded" 
                                                        placeholder="Summarize the fundamental system failure..."
                                                    ></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* EVENT TREE ANALYSIS (ETA) TOOL */}
                                    {form.investigation.method === 'ETA' && (
                                        <div className="glass-panel p-8 rounded-xl border-l-4 border-purple-500 overflow-x-auto">
                                            <h3 className="font-bold text-lg mb-6">Event Tree Analysis (ETA)</h3>
                                            
                                            <div className="min-w-[800px]">
                                                {/* 1. Initiating Event */}
                                                <div className="mb-8">
                                                    <label className="lbl">Initiating Event</label>
                                                    <input 
                                                        value={form.investigation.eta.initiatingEvent} 
                                                        onChange={e=>setForm({...form, investigation: {...form.investigation, eta: {...form.investigation.eta, initiatingEvent: e.target.value}}})}
                                                        className="w-64 bg-slate-900 border-purple-500 text-center font-bold" 
                                                    />
                                                </div>

                                                {/* 2. Barriers Builder */}
                                                <div className="flex gap-4 mb-8 items-start">
                                                    {(form.investigation.eta.barriers || []).map((barrier, i) => (
                                                        <div key={i} className="flex flex-col items-center relative group">
                                                            <div className="w-32 h-16 bg-slate-800 border border-slate-600 rounded flex items-center justify-center text-center text-xs p-2 relative z-10">
                                                                {barrier.name}
                                                                <button onClick={()=>{
                                                                    const newB = form.investigation.eta.barriers.filter((_, idx)=>idx!==i);
                                                                    setForm({...form, investigation: {...form.investigation, eta: {...form.investigation.eta, barriers: newB}}});
                                                                }} className="absolute -top-2 -right-2 bg-red-500 rounded-full w-4 h-4 flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100 transition">x</button>
                                                            </div>
                                                            {/* Lines to next step (Simulation) */}
                                                            <div className="h-8 w-px bg-slate-600"></div>
                                                            <div className="flex gap-8 text-[10px] w-full justify-between px-2">
                                                                <span className="text-green-400">Success</span>
                                                                <span className="text-red-400">Fail</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    
                                                    {/* Add Barrier */}
                                                    <div className="relative">
                                                        <select 
                                                            onChange={(e)=>{
                                                                if(e.target.value){
                                                                    const newB = [...(form.investigation.eta.barriers || []), {name: e.target.value}];
                                                                    setForm({...form, investigation: {...form.investigation, eta: {...form.investigation.eta, barriers: newB}}});
                                                                    e.target.value = "";
                                                                }
                                                            }}
                                                            className="w-32 bg-purple-900/20 border border-purple-500/50 text-xs rounded p-2"
                                                        >
                                                            <option value="">+ Add Barrier</option>
                                                            {INCIDENT_KB[form.type]?.eta_barriers.map(b => <option key={b} value={b}>{b}</option>)}
                                                            <option value="Custom Barrier">Custom...</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div className="text-xs text-slate-500 italic">
                                                    * This represents the sequence of safety functions. If the barrier succeeds, the accident sequence stops or mitigates. If it fails, it escalates.
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* 3. CAPA LINKING */}
                                    <div className="glass-panel p-6 rounded-xl border-t border-slate-700">
                                        <h3 className="font-bold mb-4">Corrective & Preventive Actions (CAPA)</h3>
                                        <div className="flex gap-2 mb-4">
                                            <input id="newCapa" placeholder="Describe action..." className="flex-1 bg-slate-900" />
                                            <input id="capaOwner" placeholder="Owner" className="w-32 bg-slate-900" />
                                            <input type="date" id="capaDate" className="w-32 bg-slate-900" />
                                            <button onClick={()=>{
                                                const desc = document.getElementById('newCapa').value;
                                                const own = document.getElementById('capaOwner').value;
                                                const due = document.getElementById('capaDate').value;
                                                if(desc){
                                                    setForm({...form, capa: [...form.capa, {action: desc, owner: own, due: due, status: 'Open'}]});
                                                    document.getElementById('newCapa').value = "";
                                                }
                                            }} className="bg-emerald-600 px-4 rounded text-xs font-bold">Add</button>
                                        </div>
                                        <div className="space-y-2">
                                            {form.capa.map((c, i) => (
                                                <div key={i} className="flex justify-between bg-slate-900 p-2 rounded text-sm items-center">
                                                    <span>{c.action} <span className="text-slate-500">({c.owner})</span></span>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-xs text-orange-400">{c.due}</span>
                                                        <button onClick={()=>{
                                                            const newC = [...form.capa];
                                                            newC.splice(i, 1);
                                                            setForm({...form, capa: newC});
                                                        }} className="text-red-400 hover:text-white">x</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="flex justify-end pt-4">
                                        <button onClick={saveIncident} className="bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg">Save Investigation</button>
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                    <style>{`.lbl { display:block; font-size:9px; font-weight:bold; color:#64748b; text-transform:uppercase; margin-bottom:2px; }`}</style>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<IncidentApp />);
    </script>
</body>
</html>
