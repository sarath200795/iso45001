<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incident Management</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'slate-850': '#1e293b', 'slate-950': '#020617' },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-in-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; }
        
        /* DIAGRAM STYLES */
        .fishbone-container { position: relative; padding: 20px 0; overflow-x: auto; }
        .spine { position: absolute; top: 50%; left: 0; right: 120px; height: 3px; background: #64748b; z-index: 0; }
        .spine::after { content: ''; position: absolute; right: -20px; top: -10px; border-left: 20px solid #64748b; border-top: 10px solid transparent; border-bottom: 10px solid transparent; }
        .head { position: absolute; top: 50%; right: 0; transform: translateY(-50%); width: 100px; height: 80px; border: 3px solid #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #1e293b; z-index: 10; color: #ef4444; font-weight: bold; text-align: center; font-size: 12px; }
        .ribs-top, .ribs-bottom { display: flex; justify-content: space-between; padding-right: 120px; }
        .rib-box { background: #1e293b; border: 1px solid #475569; padding: 8px; border-radius: 6px; width: 18%; position: relative; transition: all 0.2s; }
        .ribs-top .rib-box { margin-bottom: 40px; }
        .ribs-bottom .rib-box { margin-top: 40px; }
        .ribs-top .rib-box::after { content: ''; position: absolute; bottom: -40px; left: 50%; width: 2px; height: 40px; background: #64748b; transform: skewX(-20deg); transform-origin: top; }
        .ribs-bottom .rib-box::before { content: ''; position: absolute; top: -40px; left: 50%; width: 2px; height: 40px; background: #64748b; transform: skewX(20deg); transform-origin: bottom; }

        .tree ul { padding-top: 20px; position: relative; display: flex; justify-content: center; transition: all 0.5s; }
        .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; transition: all 0.5s; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 2px solid #64748b; width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 2px solid #64748b; }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 2px solid #64748b; border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 2px solid #64748b; width: 0; height: 20px; }
        .tree-node { display: inline-block; padding: 10px; border-radius: 8px; background: #1e293b; border: 1px solid #475569; min-width: 140px; position: relative; z-index: 10; transition: all 0.2s; }
        
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; outline: none; width: 100%; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #3b82f6; }
        input:disabled, select:disabled, textarea:disabled { opacity: 0.6; cursor: not-allowed; }

        /* --- PDF GENERATION STYLES --- */
        @media print {
            @page { size: A4; margin: 10mm; }
            
            body, html, #root, .app-container, .main-content { 
                width: 100% !important; height: auto !important; overflow: visible !important; 
                background: white !important; color: black !important; display: block !important; position: static !important;
                -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
            }

            .no-print, header, .repo-view, .form-view-tabs, .action-buttons { display: none !important; }

            .print-overlay { 
                display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; z-index: 9999;
            }

            .print-overlay * { visibility: visible !important; color: black !important; }
            .print-overlay h1 { font-size: 24pt; font-weight: bold; border-bottom: 2px solid black; margin-bottom: 20px; }
            .print-overlay h2 { font-size: 16pt; font-weight: bold; margin-top: 20px; border-bottom: 1px solid #ccc; background: #eee !important; padding: 5px; -webkit-print-color-adjust: exact; }
            .print-overlay p, .print-overlay li, .print-overlay td { font-size: 11pt; }
            
            /* FORCE DIAGRAMS TO PRINT */
            .rib-box, .tree-node { border: 1px solid black !important; background: white !important; color: black !important; }
            .spine, .spine::after, .ribs-top .rib-box::after, .ribs-bottom .rib-box::before, 
            .tree li::before, .tree li::after, .tree ul ul::before { background: black !important; border-color: black !important; }
            .head { border: 2px solid black !important; background: white !important; color: black !important; }
            
            /* ATTACHMENT IMAGE */
            .incident-image { max-width: 300px; max-height: 200px; border: 1px solid black; margin-top: 10px; }

            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid black !important; padding: 5px; }
        }
        .print-overlay { display: none; }
    </style>
</head>
<body class="min-h-screen">
    <div id="root" class="app-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, get, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", authDomain: "ohsms-fa534.firebaseapp.com", databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/", projectId: "ohsms-fa534", storageBucket: "ohsms-fa534.appspot.com", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { ref, push, get, update, remove };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- COMPONENTS ---
        const UserSelect = ({ users, value, onChange, disabled, placeholder }) => (
            <select value={value} onChange={e => onChange(e.target.value)} disabled={disabled} className="w-full">
                <option value="">{placeholder || 'Select User...'}</option>
                {users.map(u => <option key={u.id} value={u.name}>{u.name} ({u.role})</option>)}
            </select>
        );

        const SiteSelect = ({ sites, value, onChange, disabled }) => (
            <select value={value} onChange={e => onChange(e.target.value)} disabled={disabled} className="w-full">
                <option value="">Select Site...</option>
                {sites.map(s => <option key={s.code} value={s.code}>{s.name} ({s.code})</option>)}
            </select>
        );

        const RibBox = ({ title, cat, data, onAdd, onUpdate, onRemove, disabled }) => (
            <div className="rib-box">
                <div className="flex justify-between mb-1 border-b border-slate-600 pb-1">
                    <span className="text-[9px] font-bold uppercase text-slate-400 print:text-black">{title}</span>
                    {!disabled && <button onClick={() => onAdd(cat)} className="text-[10px] text-green-400 no-print hover:text-green-300">+</button>}
                </div>
                {(data[cat] || []).map((v, i) => (
                    <div key={i} className="flex group mb-1">
                        <input value={v} onChange={(e) => onUpdate(cat, i, e.target.value)} disabled={disabled} className="w-full bg-transparent text-[10px] border-b border-slate-700 mb-1 outline-none text-white print:text-black focus:border-blue-500" />
                        {!disabled && <button onClick={() => onRemove(cat, i)} className="text-red-500 text-[8px] opacity-0 group-hover:opacity-100 ml-1 no-print">x</button>}
                    </div>
                ))}
            </div>
        );

        const Fishbone = ({ data, onChange, disabled }) => {
            const update = (cat, i, val) => { const arr = [...data[cat]]; arr[i] = val; onChange({ ...data, [cat]: arr }); };
            const add = (cat) => onChange({ ...data, [cat]: [...(data[cat] || []), ''] });
            const remove = (cat, i) => { const arr = [...data[cat]]; arr.splice(i, 1); onChange({ ...data, [cat]: arr }); };
            return (
                <div className="fishbone-container mt-8">
                    <div className="spine"></div><div className="head">INCIDENT</div>
                    <div className="ribs-top">
                        <RibBox title="Man" cat="man" data={data} onAdd={add} onUpdate={update} onRemove={remove} disabled={disabled} />
                        <RibBox title="Machine" cat="machine" data={data} onAdd={add} onUpdate={update} onRemove={remove} disabled={disabled} />
                        <RibBox title="Material" cat="material" data={data} onAdd={add} onUpdate={update} onRemove={remove} disabled={disabled} />
                    </div>
                    <div className="ribs-bottom">
                        <RibBox title="Method" cat="method" data={data} onAdd={add} onUpdate={update} onRemove={remove} disabled={disabled} />
                        <RibBox title="Environment" cat="environment" data={data} onAdd={add} onUpdate={update} onRemove={remove} disabled={disabled} />
                        <div style={{ width: '18%' }}></div>
                    </div>
                </div>
            );
        };

        const FaultTreeNode = ({ node, onUpdate, onDelete, onAddSibling, disabled }) => {
            const handleAddChild = () => { onUpdate({ ...node, children: [...(node.children || []), { id: Date.now(), label: 'New Cause', type: 'EVENT', children: [] }] }); };
            const toggleType = () => { const types = ['EVENT', 'AND', 'OR', 'ROOT']; onUpdate({ ...node, type: types[(types.indexOf(node.type) + 1) % types.length] }); };
            const updateChild = (i, d) => { const k = [...node.children]; k[i] = d; onUpdate({ ...node, children: k }); };
            const deleteChild = (i) => { onUpdate({ ...node, children: node.children.filter((_, x) => x !== i) }); };
            const addSiblingToChild = () => { onUpdate({ ...node, children: [...node.children, { id: Date.now(), label: 'Parallel Cause', type: 'EVENT', children: [] }] }); };

            return (
                <li>
                    <div className="tree-node group">
                        {!disabled && (
                            <div className="absolute -top-3 right-0 opacity-0 group-hover:opacity-100 flex gap-1 no-print z-30 transition-opacity">
                                <button onClick={handleAddChild} className="bg-blue-600 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center shadow hover:scale-110" title="Add Child">↓</button>
                                {onAddSibling && <button onClick={onAddSibling} className="bg-purple-600 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center shadow hover:scale-110" title="Add Parallel">→</button>}
                                {onDelete && <button onClick={onDelete} className="bg-red-600 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center shadow hover:scale-110" title="Delete">x</button>}
                            </div>
                        )}
                        <input value={node.label} onChange={e=>onUpdate({...node, label: e.target.value})} disabled={disabled} className="bg-transparent text-center text-xs font-bold w-full outline-none border-b border-transparent focus:border-blue-500 pb-1" placeholder="Event..." />
                        {!disabled && <div onClick={toggleType} className="mt-1 cursor-pointer no-print select-none"><span className={`text-[9px] px-1.5 rounded font-mono border ${node.type==='AND'?'border-purple-500 text-purple-400':node.type==='OR'?'border-orange-500 text-orange-400':node.type==='ROOT'?'border-emerald-500 text-emerald-400':'border-slate-600 text-slate-500'}`}>{node.type}</span></div>}
                        <div className="hidden print:block text-[8px] font-bold text-center mt-1">[{node.type}]</div>
                    </div>
                    {node.children && node.children.length > 0 && <ul>{node.children.map((child, i) => (<FaultTreeNode key={child.id} node={child} onUpdate={d=>updateChild(i,d)} onDelete={()=>deleteChild(i)} onAddSibling={addSiblingToChild} disabled={disabled} />))}</ul>}
                </li>
            );
        };

        const IncidentRepository = ({ incidents, onEdit, onPrint, onDelete, permissions }) => {
            const [filterType, setFilterType] = useState('All');
            const [filterLevel, setFilterLevel] = useState('All');
            const [filterSite, setFilterSite] = useState('All');
            const [dateFrom, setDateFrom] = useState('');
            const [dateTo, setDateTo] = useState('');

            const uniqueSites = useMemo(() => ['All', ...new Set(incidents.map(i => i.siteId).filter(Boolean))], [incidents]);

            const filteredData = useMemo(() => {
                return incidents.filter(item => {
                    const matchType = filterType === 'All' || item.type === filterType;
                    const matchLevel = filterLevel === 'All' || item.severity === filterLevel;
                    const matchSite = filterSite === 'All' || item.siteId === filterSite;
                    let matchDate = true;
                    if (dateFrom && dateTo) { matchDate = item.date >= dateFrom && item.date <= dateTo; }
                    return matchType && matchLevel && matchDate && matchSite;
                });
            }, [incidents, filterType, filterLevel, filterSite, dateFrom, dateTo]);

            const exportToExcel = () => {
                const dataToExport = filteredData.map(({ id, date, time, siteId, type, severity, description }) => ({ ID: id, Date: date, Time: time, Site: siteId, Type: type, Severity: severity, Description: description }));
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Incidents");
                XLSX.writeFile(wb, "Incident_Repository.xlsx");
            };

            return (
                <div className="space-y-6 animate-fade-in glass-panel-filters repo-view">
                    <div className="p-6 rounded-xl bg-gradient-to-r from-purple-900/40 to-slate-900 border border-purple-500/30 mb-6">
                        <div className="flex justify-between items-start mb-6">
                            <div><h2 className="text-2xl font-bold text-white flex items-center gap-3"><span className="w-10 h-10 rounded-lg bg-purple-600 flex items-center justify-center text-lg"><i className="fas fa-database"></i></span>Incident Repository</h2><p className="text-slate-400 text-sm mt-1 ml-14">Central database of all reported incidents.</p></div>
                            <button onClick={exportToExcel} className="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg"><i className="fas fa-file-excel"></i> Export</button>
                        </div>
                        <div className="flex gap-4 items-end flex-wrap">
                            <div><label className="text-[10px] text-purple-300 font-bold uppercase block mb-1">From</label><input type="date" value={dateFrom} onChange={e=>setDateFrom(e.target.value)} className="w-32 bg-slate-800 border-slate-600 text-xs rounded-lg p-2" /></div>
                            <div><label className="text-[10px] text-purple-300 font-bold uppercase block mb-1">To</label><input type="date" value={dateTo} onChange={e=>setDateTo(e.target.value)} className="w-32 bg-slate-800 border-slate-600 text-xs rounded-lg p-2" /></div>
                            <div><label className="text-[10px] text-purple-300 font-bold uppercase block mb-1">Site</label><select value={filterSite} onChange={e=>setFilterSite(e.target.value)} className="w-32 bg-slate-800 border-slate-600 text-xs rounded-lg p-2">{uniqueSites.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                            <div><label className="text-[10px] text-purple-300 font-bold uppercase block mb-1">Type</label><select value={filterType} onChange={e=>setFilterType(e.target.value)} className="w-32 bg-slate-800 border-slate-600 text-xs rounded-lg p-2"><option value="All">All Types</option><option>Near Miss</option><option>Accident</option><option>Hazard</option><option>Property Damage</option></select></div>
                            <div><label className="text-[10px] text-purple-300 font-bold uppercase block mb-1">Severity</label><select value={filterLevel} onChange={e=>setFilterLevel(e.target.value)} className="w-32 bg-slate-800 border-slate-600 text-xs rounded-lg p-2"><option value="All">All Levels</option><option value="Level A">Level A</option><option value="Level B">Level B</option><option value="Level C">Level C</option><option value="Level D">Level D</option></select></div>
                        </div>
                    </div>
                    <div className="glass-panel rounded-xl overflow-hidden border border-slate-700 shadow-xl">
                        <table className="w-full text-left text-sm text-slate-300">
                            <thead className="bg-slate-900 text-xs uppercase font-bold text-slate-500"><tr><th className="p-4">Incident ID</th><th className="p-4">Date</th><th className="p-4">Site</th><th className="p-4">Type</th><th className="p-4">Level</th><th className="p-4 text-right">Actions</th></tr></thead>
                            <tbody className="divide-y divide-slate-800">
                                {filteredData.map(inc => (
                                    <tr key={inc.id} className="hover:bg-slate-800/50 transition-colors">
                                        <td className="p-4 font-mono font-bold text-white">{inc.id}</td>
                                        <td className="p-4">{inc.date}</td>
                                        <td className="p-4 text-emerald-400 font-mono text-xs">{inc.siteId}</td>
                                        <td className="p-4">{inc.type}</td>
                                        <td className="p-4"><span className={`px-2 py-1 rounded text-[10px] font-bold border ${inc.severity==='Level A'?'bg-red-500/10 text-red-400 border-red-500/20':inc.severity==='Level B'?'bg-orange-500/10 text-orange-400 border-orange-500/20':inc.severity==='Level C'?'bg-yellow-500/10 text-yellow-400 border-yellow-500/20':'bg-blue-500/10 text-blue-400 border-blue-500/20'}`}>{inc.severity}</span></td>
                                        <td className="p-4 text-right flex justify-end gap-2">
                                            <button onClick={()=>onPrint(inc)} className="text-blue-400 hover:text-white bg-blue-500/10 hover:bg-blue-500 px-3 py-1.5 rounded transition" title="Print Report"><i className="fas fa-print"></i></button>
                                            {!permissions.viewOnly && <button onClick={()=>onEdit(inc)} className="text-purple-400 hover:text-white bg-purple-500/10 hover:bg-purple-500 px-3 py-1.5 rounded transition">Edit</button>}
                                            {permissions.canDelete && <button onClick={()=>onDelete(inc)} className="text-slate-400 hover:text-white bg-slate-700 hover:bg-red-600 px-3 py-1.5 rounded transition"><i className="fas fa-trash-alt"></i></button>}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('form'); 
            const [step, setStep] = useState(1);
            const [session, setSession] = useState(null);
            const [isGlobal, setIsGlobal] = useState(false);
            const [incidentsList, setIncidentsList] = useState([]);
            const [seq, setSeq] = useState(0);
            const [sites, setSites] = useState([]);
            const [users, setUsers] = useState([]);
            const [permissions, setPermissions] = useState({ viewOnly: false, canEditOwnedActions: false, canDelete: false });
            
            // PRINT STATE
            const [printData, setPrintData] = useState(null);

            const [data, setData] = useState({
                id: '', siteId: '', date: new Date().toISOString().split('T')[0], time: '', 
                type: 'Near Miss', severity: 'Level A', description: '',
                imageEvidence: null, // New field for image
                consultationSummary: '', 
                investigation: { 
                    fiveWhys: [ { id: 1, name: 'Analysis Path 1', whys: ['','','','',''] } ], 
                    fishbone: { man:[], machine:[], material:[], method:[], environment:[] }, 
                    faultTree: { id:1, label:'Top Event', type:'AND', children:[] }, 
                    rootCause: '' 
                },
                capa: [], riskUpdated: false
            });

            const siteUsers = useMemo(() => {
                if (!data.siteId) return users;
                return users.filter(u => u.role === 'Owner' || (u.accessibleSites && u.accessibleSites.includes(data.siteId)) || u.assignedSite === data.siteId);
            }, [users, data.siteId]);

            const canEdit = !permissions.viewOnly || (permissions.canEditOwnedActions && data.capa.some(c => c.own === session?.user));

            const getTypeCode = (type) => {
                if(type === 'Near Miss') return 'NM';
                if(type === 'Accident') return 'AC';
                if(type === 'Hazard') return 'HA';
                if(type === 'Property Damage') return 'PD';
                return 'XX';
            };

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) { window.location.href='index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);

                const params = new URLSearchParams(window.location.search);
                let ctxSite = params.get('site');
                if (!ctxSite || ctxSite === 'GLOBAL') { setIsGlobal(true); ctxSite = ''; } else { setIsGlobal(false); }

                const viewOnly = params.get('viewOnly') === 'true';
                const role = params.get('role') || sess.role;

                setPermissions({
                    viewOnly: viewOnly || role === 'User',
                    canEditOwnedActions: role === 'Manager',
                    canDelete: role === 'Owner'
                });

                const newSeq = Math.floor(100000 + Math.random() * 900000); 
                setSeq(newSeq);
                setData(prev => ({ ...prev, siteId: ctxSite }));

                const dbRef = window.fb.ref(window.db, `organizations/${sess.orgId}`);
                window.fb.get(dbRef).then(snap => {
                    if(snap.exists()) {
                        const orgData = snap.val();
                        if(orgData.incidents) setIncidentsList(Object.entries(orgData.incidents).map(([k,v]) => ({firebaseKey:k, ...v})));
                        if(orgData.sites) {
                            const allSites = Object.values(orgData.sites);
                            if (sess.role === 'Owner') setSites(allSites);
                            else {
                                const accessible = sess.accessibleSites || (sess.assignedSite ? [sess.assignedSite] : []);
                                setSites(allSites.filter(s => accessible.includes(s.code)));
                            }
                        }
                        if(orgData.users) setUsers(Object.entries(orgData.users).map(([k,v]) => ({id:k, ...v})).filter(u => u.status === 'Active'));
                    }
                });
            }, []);

            useEffect(() => {
                if(session && !data.firebaseKey) {
                    const sId = data.siteId ? data.siteId : 'GEN';
                    const typeCode = getTypeCode(data.type);
                    const newId = `${session.orgId}-${sId}-${typeCode}-${seq}`;
                    setData(prev => ({ ...prev, id: newId }));
                }
            }, [data.siteId, data.type, session, seq]);

            const saveData = async () => {
                if(!data.siteId) { alert("Please select a Site"); return; }
                if(data.firebaseKey) {
                    await window.fb.update(window.fb.ref(window.db, `organizations/${session.orgId}/incidents/${data.firebaseKey}`), data);
                } else {
                    await window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/incidents`), data);
                }
                alert("Saved!");
                window.location.reload();
            };

            const handleDelete = async (incident) => {
                if(confirm("Delete this record?")) {
                    await window.fb.remove(window.fb.ref(window.db, `organizations/${session.orgId}/incidents/${incident.firebaseKey}`));
                    alert("Deleted.");
                    window.location.reload();
                }
            };

            const handleEdit = (incident) => {
                let updatedWhys = incident.investigation?.fiveWhys || [{ id: 1, name: 'Analysis Path 1', whys: ['','','','',''] }];
                if (Array.isArray(updatedWhys) && typeof updatedWhys[0] === 'string') {
                    updatedWhys = [{ id: Date.now(), name: 'Legacy Analysis', whys: updatedWhys }];
                }
                setData({ ...incident, investigation: { ...incident.investigation, fiveWhys: updatedWhys } });
                setView('form');
                setStep(1);
            };

            const handleRepoPrint = (incident) => {
                let updatedWhys = incident.investigation?.fiveWhys || [{ id: 1, name: 'Analysis Path 1', whys: ['','','','',''] }];
                if (Array.isArray(updatedWhys) && typeof updatedWhys[0] === 'string') {
                    updatedWhys = [{ id: Date.now(), name: 'Legacy Analysis', whys: updatedWhys }];
                }
                const formattedIncident = { ...incident, investigation: { ...incident.investigation, fiveWhys: updatedWhys } };
                
                setPrintData(formattedIncident);
                setTimeout(() => window.print(), 500); 
            };

            const handleFormPrint = () => {
                setPrintData(data);
                setTimeout(() => window.print(), 500);
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const base64 = await fileToBase64(file);
                    setData({ ...data, imageEvidence: base64 });
                }
            };

            const openInvestigationMeeting = () => {
                if(!data.siteId) { alert("Please select a Site first."); return; }
                const agendaText = `Discussion on Incident ${data.id} (${data.severity}): ${data.description.substring(0, 100)}...`;
                const params = new URLSearchParams({ site: data.siteId, interaction: 'Consultation', category: 'Incident Investigation', date: data.date, time: data.time, agenda: agendaText });
                window.open(`consultation.html?${params.toString()}`, '_blank');
            };

            const addFiveWhyPath = () => { const newCount = data.investigation.fiveWhys.length + 1; setData(prev => ({ ...prev, investigation: { ...prev.investigation, fiveWhys: [...prev.investigation.fiveWhys, { id: Date.now(), name: `Analysis Path ${newCount}`, whys: ['','','','',''] }] } })); };
            const updateFiveWhy = (pIdx, wIdx, val) => { const paths = [...data.investigation.fiveWhys]; paths[pIdx].whys[wIdx] = val; setData(prev => ({ ...prev, investigation: { ...prev.investigation, fiveWhys: paths } })); };
            const updatePathName = (pIdx, val) => { const paths = [...data.investigation.fiveWhys]; paths[pIdx].name = val; setData(prev => ({ ...prev, investigation: { ...prev.investigation, fiveWhys: paths } })); };
            const removeFiveWhyPath = (idx) => { setData(prev => ({ ...prev, investigation: { ...prev.investigation, fiveWhys: prev.investigation.fiveWhys.filter((_, i) => i !== idx) } })); };

            const addCapa = () => {
                const act = document.getElementById('act').value;
                const own = document.getElementById('own').value;
                const due = document.getElementById('due').value;
                if(act && own) { 
                    setData({...data, capa:[...data.capa, {act, own, due, status:'Open'}]}); 
                    document.getElementById('act').value=''; 
                    document.getElementById('own').value='';
                    document.getElementById('due').value='';
                }
            };

            const canEditCapa = (row) => {
                if (!permissions.viewOnly) return true;
                if (permissions.canEditOwnedActions && row.own === session?.user) return true;
                return false;
            };

            if(!session) return null;

            const STEPS = [ { id: 1, label: 'Initial' }, ...(data.severity !== 'Level D' ? [{ id: 2, label: 'Team & Consult' }] : []), { id: 3, label: 'Investigate' }, { id: 4, label: 'CAPA' }, { id: 5, label: 'Review' } ];

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-white overflow-hidden main-content">
                    <header className="h-16 border-b border-slate-800 flex items-center justify-between px-6 no-print bg-slate-900">
                        <div className="flex items-center gap-4">
                            <a href="home.html" className="text-slate-400 hover:text-white"><i className="fas fa-arrow-left"></i> Back</a>
                            <h1 className="font-bold text-lg">Incident Module</h1>
                            <span className="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded border border-blue-500/30">{session.role}</span>
                            {permissions.viewOnly && <span className="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded border border-yellow-500/30">View Only</span>}
                        </div>
                        <div className="flex bg-slate-800 p-1 rounded-lg">
                            <button onClick={() => setView('form')} className={`px-4 py-1.5 rounded text-xs font-bold uppercase ${view === 'form' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>New Report</button>
                            <button onClick={() => setView('repo')} className={`px-4 py-1.5 rounded text-xs font-bold uppercase ${view === 'repo' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>Repository</button>
                        </div>
                    </header>

                    <div className="flex-1 overflow-y-auto p-6">
                        {view === 'repo' ? <IncidentRepository incidents={incidentsList} onEdit={handleEdit} onPrint={handleRepoPrint} onDelete={handleDelete} permissions={permissions} /> : (
                            <div className="max-w-5xl mx-auto">
                                <div className="flex gap-2 mb-8 no-print tab-buttons form-view-tabs">
                                    {STEPS.map((s, i) => (<button key={s.id} onClick={() => setStep(s.id)} className={`flex-1 py-3 rounded-xl text-xs font-bold transition-all ${step === s.id ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{i + 1}. {s.label}</button>))}
                                </div>

                                {step === 1 && (
                                    <div className="report-section-edit">
                                        <h2 className="section-heading text-xl font-bold text-blue-400 mb-6 flex items-center gap-3 border-b border-blue-500/20 pb-4"><i className="fas fa-clipboard-list"></i> 1. Initial Report</h2>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Site ID</label><SiteSelect sites={sites} value={data.siteId} onChange={v => setData({...data, siteId: v})} disabled={!canEdit || !isGlobal} /></div>
                                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Date</label><input type="date" value={data.date} onChange={e=>setData({...data, date:e.target.value})} disabled={!canEdit} /></div>
                                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Time</label><input type="time" value={data.time} onChange={e=>setData({...data, time:e.target.value})} disabled={!canEdit} /></div>
                                            <div><label className="text-[10px] uppercase font-bold text-slate-500">ID</label><input value={data.id} className="font-mono bg-slate-800" disabled /></div>
                                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Type</label><select value={data.type} onChange={e=>setData({...data, type:e.target.value})} disabled={!canEdit}><option>Near Miss</option><option>Accident</option><option>Hazard</option><option>Property Damage</option></select></div>
                                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Severity</label><select value={data.severity} onChange={e=>setData({...data, severity:e.target.value})} disabled={!canEdit}><option>Level A</option><option>Level B</option><option>Level C</option><option>Level D</option></select></div>
                                        </div>
                                        <div className="mb-4"><label className="text-[10px] uppercase font-bold text-slate-500">Description</label><textarea rows="4" value={data.description} onChange={e=>setData({...data, description:e.target.value})} className="w-full mt-1" disabled={!canEdit}></textarea></div>
                                        <div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Image Evidence</label>
                                            {data.imageEvidence && <img src={data.imageEvidence} alt="Evidence" className="h-32 object-cover rounded mb-2 border border-slate-700" />}
                                            <input type="file" onChange={handleImageUpload} disabled={!canEdit} className="text-xs" />
                                        </div>
                                    </div>
                                )}

                                {step === 2 && data.severity !== 'Level D' && (
                                    <div className="report-section-edit">
                                        <h2 className="section-heading text-xl font-bold text-teal-400 mb-6 flex items-center gap-3 border-b border-teal-500/20 pb-4"><i className="fas fa-users"></i> 2. Team & Consultation</h2>
                                        <div className="bg-slate-800/50 p-8 rounded-2xl border border-slate-700 shadow-xl flex flex-col items-center text-center space-y-6 no-print">
                                            <div className="w-16 h-16 rounded-full bg-teal-500/10 flex items-center justify-center text-3xl text-teal-400"><i className="fas fa-comments"></i></div>
                                            <div><h3 className="text-xl font-bold text-white mb-2">Record Investigation Meeting</h3><p className="text-slate-400 text-sm max-w-lg mx-auto">Open Consultation module to record minutes for "Incident Investigation".</p></div>
                                            {canEdit && <button onClick={openInvestigationMeeting} className="bg-teal-600 hover:bg-teal-500 text-white font-bold py-4 px-8 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex items-center gap-3">Launch Meeting <i className="fas fa-external-link-alt"></i></button>}
                                        </div>
                                        <div className="mt-6">
                                            <label className="text-[11px] uppercase font-bold text-slate-500 block mb-2 tracking-wider">Consultation Key Outcomes & Team Inputs</label>
                                            <textarea className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white h-32 focus:border-teal-500 outline-none resize-none" value={data.consultationSummary} onChange={e=>setData({...data, consultationSummary:e.target.value})} placeholder="Paste key points from the consultation meeting here for the report..." disabled={!canEdit}></textarea>
                                        </div>
                                    </div>
                                )}

                                {step === 3 && (
                                    <div className="report-section-edit">
                                        <h2 className="section-heading text-xl font-bold text-purple-400 mb-6 flex items-center gap-3 border-b border-purple-500/20 pb-4"><i className="fas fa-search"></i> 3. Root Cause Analysis</h2>
                                        <div className="bg-slate-800/50 p-8 rounded-2xl border border-slate-700 shadow-xl">
                                            <div><h3 className="font-bold text-white mb-2 pl-2 border-l-4 border-blue-500 text-black print:text-black">Fishbone Diagram</h3><Fishbone data={data.investigation.fishbone} onChange={fb => setData({...data, investigation:{...data.investigation, fishbone:fb}})} disabled={!canEdit} /></div>
                                            <div className="border-t border-slate-700 pt-8 mt-8"><h3 className="font-bold text-white mb-2 pl-2 border-l-4 border-orange-500 text-black print:text-black">Fault Tree Analysis</h3><div className="tree overflow-x-auto pb-4"><ul><FaultTreeNode node={data.investigation.faultTree} onUpdate={rt => setData({...data, investigation:{...data.investigation, faultTree:rt}})} disabled={!canEdit} /></ul></div></div>
                                            <div className="border-t border-slate-700 pt-8 mt-8">
                                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-white pl-2 border-l-4 border-purple-500 text-black print:text-black">5 Whys Analysis</h3>{canEdit && <button onClick={addFiveWhyPath} className="bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1 rounded-lg transition no-print">+ Add Analysis Path</button>}</div>
                                                {data.investigation.fiveWhys.map((path, pIdx) => (
                                                    <div key={path.id} className="mb-6 bg-slate-900/50 p-4 rounded-xl border border-slate-700 relative group">
                                                        <div className="flex justify-between items-center mb-3 border-b border-slate-700 pb-2"><input value={path.name || `Analysis Path ${pIdx+1}`} onChange={e => updatePathName(pIdx, e.target.value)} disabled={!canEdit} className="bg-transparent text-[10px] font-bold text-purple-300 uppercase tracking-wider outline-none border-b border-transparent focus:border-purple-500 w-64 transition-all" />{canEdit && data.investigation.fiveWhys.length > 1 && <button onClick={() => removeFiveWhyPath(pIdx)} className="text-red-400 hover:text-red-300 text-xs no-print hover:bg-red-900/20 px-2 py-1 rounded transition"><i className="fas fa-trash-alt mr-1"></i> Remove</button>}</div>
                                                        {path.whys.map((w, i) => (<div key={i} className="flex gap-4 mb-3 items-center"><span className="text-slate-500 font-mono text-xs w-16 text-right font-bold">WHY {i+1}?</span><input className="flex-1 bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-blue-500 outline-none shadow-sm" value={w} onChange={e => updateFiveWhy(pIdx, i, e.target.value)} placeholder="Enter cause..." disabled={!canEdit} /></div>))}
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="border-t border-slate-700 pt-8"><label className="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-2 block">Final Root Cause</label><textarea className="w-full bg-emerald-900/10 border border-emerald-500/30 p-4 rounded-xl text-white h-24 focus:ring-1 focus:ring-emerald-500 outline-none" value={data.investigation.rootCause} onChange={e=>setData({...data, investigation:{...data.investigation, rootCause:e.target.value}})} disabled={!canEdit}></textarea></div>
                                        </div>
                                    </div>
                                )}

                                {step === 4 && (
                                    <div className="report-section-edit">
                                        <h2 className="section-heading text-xl font-bold text-orange-400 mb-6 flex items-center gap-3 border-b border-orange-500/20 pb-4"><i className="fas fa-clipboard-check"></i> 4. CAPA</h2>
                                        <div className="bg-slate-800/50 p-8 rounded-2xl border border-slate-700 shadow-xl">
                                            {canEdit && (
                                                <div className="grid grid-cols-4 gap-4 mb-6 no-print">
                                                    <input id="act" placeholder="Action Description" className="col-span-2 bg-slate-900 border border-slate-700 p-3 rounded-xl text-sm text-white focus:border-blue-500 outline-none"/>
                                                    <div><UserSelect users={siteUsers} value="" onChange={() => {}} disabled={false} placeholder="Action Owner..." /></div>
                                                    <input id="due" type="date" className="bg-slate-900 border border-slate-700 p-3 rounded-xl text-sm text-white focus:border-blue-500 outline-none"/>
                                                </div>
                                            )}
                                            {canEdit && <button onClick={addCapa} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl text-sm font-bold w-full mb-8 no-print shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-2"><i className="fas fa-plus"></i> Add Action Item</button>}
                                            <div className="overflow-hidden rounded-xl border border-slate-700">
                                                <table className="w-full text-left text-sm text-slate-300">
                                                    <thead className="bg-slate-900 text-xs uppercase font-bold text-slate-500"><tr><th className="p-4">Action</th><th className="p-4">Owner</th><th className="p-4">Due Date</th><th className="p-4">Status</th></tr></thead>
                                                    <tbody className="divide-y divide-slate-700">
                                                        {data.capa.map((c,i)=>(
                                                            <tr key={i}>
                                                                <td className="p-4">{c.act}</td>
                                                                <td className="p-4 text-blue-400">{c.own}</td>
                                                                <td className="p-4">{c.due}</td>
                                                                <td className="p-4">
                                                                    {canEditCapa(c) ? (
                                                                        <select value={c.status} onChange={e => { const newCapa = [...data.capa]; newCapa[i].status = e.target.value; setData({...data, capa: newCapa}); }} className="bg-slate-800 text-xs px-2 py-1 rounded">
                                                                            <option>Open</option><option>In Progress</option><option>Closed</option>
                                                                        </select>
                                                                    ) : <span className="bg-orange-500/10 text-orange-400 px-2 py-1 rounded text-[10px]">{c.status}</span>}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {step === 5 && (
                                    <div className="report-section-edit">
                                        <h2 className="section-heading text-xl font-bold text-emerald-400 mb-6 flex items-center gap-3 border-b border-emerald-500/20 pb-4"><i className="fas fa-check-double"></i> 5. Review</h2>
                                        <div className="bg-slate-800/50 p-8 rounded-2xl border border-slate-700 shadow-xl">
                                            <div className="flex justify-between items-center bg-slate-900 p-6 rounded-xl border border-slate-700 mb-8 no-print shadow-inner">
                                                <div><h4 className="font-bold text-white text-lg">Update Risk Assessment</h4><p className="text-sm text-slate-400 mt-1">HIRA Update Required for {data.siteId}?</p></div>
                                                <a href={`risk.html?site=${data.siteId}`} target="_blank" className="bg-purple-600 hover:bg-purple-500 text-white px-6 py-3 rounded-xl font-bold text-sm transition-all shadow-lg flex items-center gap-2">Open Risk Module <i className="fas fa-external-link-alt"></i></a>
                                            </div>
                                            <div className="flex gap-4 items-start mb-10 p-6 border border-slate-700 rounded-xl bg-slate-900/30">
                                                <input type="checkbox" className="w-6 h-6 mt-0.5 accent-emerald-500 cursor-pointer" checked={data.riskUpdated} onChange={e=>setData({...data, riskUpdated:e.target.checked})} disabled={!canEdit} />
                                                <div><label className="text-base font-bold text-white block cursor-pointer" onClick={()=>canEdit && setData({...data, riskUpdated:!data.riskUpdated})}>I confirm that the Risk Assessment has been reviewed.</label></div>
                                            </div>
                                            <div className="flex justify-end no-print pt-6 border-t border-slate-700 action-buttons">
                                                <button onClick={handleFormPrint} className="bg-slate-700 hover:bg-slate-600 text-white font-bold px-6 py-4 rounded-xl mr-4"><i className="fas fa-print mr-2"></i>Print PDF</button>
                                                {canEdit && <button onClick={saveData} className="bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white font-bold px-10 py-4 rounded-xl shadow-lg transition-all transform hover:-translate-y-1 flex items-center gap-3"><i className="fas fa-save"></i> Submit Final Report</button>}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* --- DEDICATED PRINT OVERLAY CONTAINER --- */}
                    {printData && (
                        <div className="print-overlay">
                            <div className="pdf-header">
                                <div><h1 className="text-2xl font-bold uppercase">Incident Report</h1><p>Site: {printData.siteId} | Type: {printData.type}</p></div>
                                <div className="text-right"><p className="font-mono text-xl font-bold">{printData.id}</p><p>Date: {printData.date}</p></div>
                            </div>

                            <div className="report-section">
                                <h2 className="section-heading">1. Initial Report</h2>
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div><strong>Date:</strong> {printData.date}</div>
                                    <div><strong>Time:</strong> {printData.time}</div>
                                    <div><strong>Severity:</strong> {printData.severity}</div>
                                </div>
                                <div className="mb-4"><strong>Description:</strong><br/>{printData.description}</div>
                                {printData.imageEvidence && (
                                    <div><strong>Evidence:</strong><br/><img src={printData.imageEvidence} className="incident-image" alt="Evidence" /></div>
                                )}
                            </div>

                            {printData.severity !== 'Level D' && (
                                <div className="report-section">
                                    <h2 className="section-heading">2. Consultation</h2>
                                    <div>{printData.consultationSummary || 'No consultation recorded.'}</div>
                                </div>
                            )}

                            <div className="report-section">
                                <h2 className="section-heading">3. Root Cause Analysis</h2>
                                <div className="mb-6">
                                    <strong>Fishbone Diagram:</strong>
                                    <div style={{transform:'scale(0.8)', transformOrigin:'top left'}}>
                                        <Fishbone data={printData.investigation.fishbone} onChange={()=>{}} disabled={true} />
                                    </div>
                                </div>
                                <div className="mb-6">
                                    <strong>Fault Tree Analysis:</strong>
                                    <div style={{transform:'scale(0.8)', transformOrigin:'top left'}} className="tree">
                                        <ul><FaultTreeNode node={printData.investigation.faultTree} onUpdate={()=>{}} disabled={true} /></ul>
                                    </div>
                                </div>
                                <div className="mb-4">
                                    <strong>5 Whys:</strong>
                                    {printData.investigation.fiveWhys.map((p,i) => (
                                        <div key={i} style={{marginBottom:'10px', fontSize:'10pt'}}>
                                            <em>{p.name}:</em> {p.whys.filter(w=>w).join(' -> ')}
                                        </div>
                                    ))}
                                </div>
                                <div><strong>Final Root Cause:</strong> {printData.investigation.rootCause}</div>
                            </div>

                            <div className="report-section">
                                <h2 className="section-heading">4. CAPA Plan</h2>
                                <table className="w-full border border-black">
                                    <thead><tr className="bg-gray-200">
                                        <th className="border border-black p-1">Action</th>
                                        <th className="border border-black p-1">Owner</th>
                                        <th className="border border-black p-1">Due Date</th>
                                        <th className="border border-black p-1">Status</th>
                                    </tr></thead>
                                    <tbody>
                                        {printData.capa.map((c, i) => (
                                            <tr key={i}>
                                                <td className="border border-black p-1">{c.act}</td>
                                                <td className="border border-black p-1">{c.own}</td>
                                                <td className="border border-black p-1">{c.due}</td>
                                                <td className="border border-black p-1">{c.status}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <div className="report-section">
                                <h2 className="section-heading">5. Review & Signoff</h2>
                                <div className="mb-4">
                                    <strong>Risk Assessment Updated:</strong> {printData.riskUpdated ? 'Yes' : 'No'}
                                </div>
                                <div className="flex justify-between mt-10">
                                    <div className="border-t border-black w-1/3 pt-2 text-center">Safety Officer Signature</div>
                                    <div className="border-t border-black w-1/3 pt-2 text-center">Site Manager Signature</div>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
