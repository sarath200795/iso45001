<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incident Report</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'slate-850': '#1e293b', 'slate-950': '#020617' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; }
        
        /* DIAGRAM STYLES */
        .fishbone-container { position: relative; padding: 20px 0; overflow-x: auto; }
        .spine { position: absolute; top: 50%; left: 0; right: 120px; height: 3px; background: #64748b; z-index: 0; }
        .spine::after { content: ''; position: absolute; right: -20px; top: -10px; border-left: 20px solid #64748b; border-top: 10px solid transparent; border-bottom: 10px solid transparent; }
        .head { position: absolute; top: 50%; right: 0; transform: translateY(-50%); width: 100px; height: 80px; border: 3px solid #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #1e293b; z-index: 10; color: #ef4444; font-weight: bold; text-align: center; font-size: 12px; }
        .ribs-top, .ribs-bottom { display: flex; justify-content: space-between; padding-right: 120px; }
        .rib-box { background: #1e293b; border: 1px solid #475569; padding: 8px; border-radius: 6px; width: 18%; position: relative; transition: all 0.2s; }
        .ribs-top .rib-box { margin-bottom: 40px; }
        .ribs-bottom .rib-box { margin-top: 40px; }
        .ribs-top .rib-box::after { content: ''; position: absolute; bottom: -40px; left: 50%; width: 2px; height: 40px; background: #64748b; transform: skewX(-20deg); transform-origin: top; }
        .ribs-bottom .rib-box::before { content: ''; position: absolute; top: -40px; left: 50%; width: 2px; height: 40px; background: #64748b; transform: skewX(20deg); transform-origin: bottom; }

        .tree ul { padding-top: 20px; position: relative; display: flex; justify-content: center; }
        .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 2px solid #64748b; width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 2px solid #64748b; }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 2px solid #64748b; border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 2px solid #64748b; width: 0; height: 20px; }
        .tree-node { display: inline-block; padding: 8px 12px; border-radius: 6px; background: #1e293b; border: 1px solid #475569; color: white; min-width: 120px; z-index: 10; position: relative; }

        /* PRINT STYLES */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; color: black; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .section-card { border: 1px solid #000 !important; background: white !important; color: black !important; box-shadow: none !important; margin-bottom: 20px; page-break-inside: avoid; }
            input, textarea, select { background: transparent !important; border: 1px solid #ccc !important; color: black !important; }
            .bg-slate-900, .bg-slate-800 { background: white !important; color: black !important; border: 1px solid #ccc !important; }
            
            /* Diagram Print Fixes */
            .rib-box, .tree-node { background: white !important; border: 1px solid black !important; color: black !important; }
            .spine, .spine::after, .ribs-top .rib-box::after, .ribs-bottom .rib-box::before, .tree li::before, .tree li::after, .tree ul ul::before { background: black !important; border-left-color: black !important; border-color: black !important; }
            .head { background: white !important; color: black !important; border-color: black !important; }
            
            .tab-content { display: block !important; margin-bottom: 30px; }
            .tab-header { display: block !important; font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; border-bottom: 2px solid black; }
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", authDomain: "ohsms-fa534.firebaseapp.com", databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/", projectId: "ohsms-fa534", storageBucket: "ohsms-fa534.appspot.com", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { ref, push };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const FaultTreeNode = ({ node, onUpdate }) => {
            const addChild = () => onUpdate({ ...node, children: [...(node.children||[]), { id: Date.now(), label: 'Cause', type: 'AND', children: [] }] });
            return (
                <li>
                    <div className="tree-node group">
                        <div className="flex justify-between items-center mb-1 no-print">
                            <button onClick={addChild} className="text-[9px] bg-blue-600 px-1 rounded text-white">+</button>
                            <span onClick={()=>onUpdate({...node, type: node.type==='AND'?'OR':'AND'})} className="text-[8px] cursor-pointer bg-slate-700 px-1 rounded border border-slate-600">{node.type}</span>
                        </div>
                        <input value={node.label} onChange={e=>onUpdate({...node, label:e.target.value})} className="bg-transparent text-center text-xs font-bold w-full outline-none" />
                        <div className="hidden print:block text-[8px] font-bold text-center mt-1">[{node.type}]</div>
                    </div>
                    {node.children?.length > 0 && <ul>{node.children.map((child, i) => (<FaultTreeNode key={child.id} node={child} onUpdate={d=>{const k=[...node.children];k[i]=d;onUpdate({...node, children:k})}} />))}</ul>}
                </li>
            );
        };

        const Fishbone = ({ data, onChange }) => {
            const update = (cat, i, val) => { const arr=[...data[cat]]; arr[i]=val; onChange({...data, [cat]:arr}); };
            const add = (cat) => onChange({...data, [cat]: [...data[cat], '']});
            const RibBox = ({ title, cat }) => (
                <div className="rib-box">
                    <div className="flex justify-between mb-1 border-b border-slate-600 pb-1">
                        <span className="text-[9px] font-bold uppercase text-slate-400">{title}</span>
                        <button onClick={()=>add(cat)} className="text-[10px] text-green-400 no-print">+</button>
                    </div>
                    {data[cat].map((v, i) => <input key={i} value={v} onChange={e=>update(cat, i, e.target.value)} className="w-full bg-transparent text-[10px] border-b border-slate-700 mb-1 outline-none text-white print:text-black" />)}
                </div>
            );
            return (
                <div className="fishbone-container mt-8">
                    <div className="spine"></div><div className="head">INCIDENT</div>
                    <div className="ribs-top"><RibBox title="Man" cat="man"/><RibBox title="Machine" cat="machine"/><RibBox title="Material" cat="material"/></div>
                    <div className="ribs-bottom"><RibBox title="Method" cat="method"/><RibBox title="Environment" cat="environment"/><div style={{width:'18%'}}></div></div>
                </div>
            );
        };

        const App = () => {
            const [step, setStep] = useState(1);
            const [session, setSession] = useState(null);
            const [isGlobal, setIsGlobal] = useState(false);
            
            const [data, setData] = useState({
                id: '', siteId: '', date: new Date().toISOString().split('T')[0], time: '', type: 'Near Miss', description: '',
                investigation: { fiveWhys: ['','','','',''], fishbone: { man:[], machine:[], material:[], method:[], environment:[] }, faultTree: { id:1, label:'Incident', type:'OR', children:[] }, rootCause: '' },
                capa: [], riskUpdated: false
            });

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) { window.location.href='index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);

                // URL Params Logic
                const params = new URLSearchParams(window.location.search);
                let ctxSite = params.get('site');
                
                // Handling GLOBAL vs Specific
                if (!ctxSite || ctxSite === 'GLOBAL') {
                    setIsGlobal(true); // Enable editing
                    ctxSite = ''; // Empty so user can type
                } else {
                    setIsGlobal(false); // Read-only
                }

                const seq = Math.floor(Math.random()*9999);
                setData(prev => ({ ...prev, id: `${sess.orgId}-${ctxSite || 'GEN'}-${seq}`, siteId: ctxSite }));
            }, []);

            const saveData = async () => {
                if(!data.siteId) { alert("Please enter a Site ID"); return; }
                await window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/incidents`), data);
                alert("Saved!");
                window.location.href = 'home.html';
            };

            if(!session) return null;

            return (
                <div className="max-w-5xl mx-auto p-6">
                    
                    {/* Header */}
                    <div className="flex justify-between items-center mb-8 no-print">
                        <div className="flex items-center gap-4">
                            <a href="home.html" className="text-slate-400 hover:text-white"><i className="fas fa-arrow-left"></i> Back</a>
                            <h1 className="text-xl font-bold text-white">Incident Report</h1>
                        </div>
                        <div className="flex gap-2">
                            {[1,2,3,4].map(n => <button key={n} onClick={()=>setStep(n)} className={`w-8 h-8 rounded-full font-bold text-sm ${step===n ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-500'}`}>{n}</button>)}
                        </div>
                        <button onClick={()=>window.print()} className="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-sm"><i className="fas fa-file-pdf"></i> PDF</button>
                    </div>

                    {/* Print Header */}
                    <div className="hidden print:block text-center border-b-2 border-black pb-4 mb-6">
                        <h1 className="text-2xl font-bold uppercase">Incident Investigation Report</h1>
                        <p className="text-sm font-mono mt-1">ID: {data.id} | Org: {session.orgId}</p>
                    </div>

                    {/* Step 1 */}
                    <div className={`tab-content ${step===1?'active':''} section-card`}>
                        <div className="hidden print:block tab-header">1. Initial Information</div>
                        <div className="bg-slate-800/50 p-6 rounded-xl border border-slate-700">
                            <div className="grid grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Site Location ID</label>
                                    {/* TOGGLE: Input if Global/Empty, Text if Fixed */}
                                    {isGlobal ? (
                                        <input 
                                            className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white" 
                                            placeholder="Enter Site Code (e.g. BLR-01)"
                                            value={data.siteId} 
                                            onChange={e=>setData({...data, siteId:e.target.value})} 
                                        />
                                    ) : (
                                        <div className="w-full bg-slate-900/50 border border-slate-700 p-3 rounded-lg text-emerald-400 font-mono font-bold">
                                            {data.siteId}
                                        </div>
                                    )}
                                </div>
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Type</label>
                                    <select className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white" value={data.type} onChange={e=>setData({...data, type:e.target.value})}><option>Near Miss</option><option>Accident</option><option>Hazard</option></select>
                                </div>
                                <div><label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Date</label><input type="date" className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white" value={data.date} onChange={e=>setData({...data, date:e.target.value})} /></div>
                                <div><label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Time</label><input type="time" className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white" value={data.time} onChange={e=>setData({...data, time:e.target.value})} /></div>
                            </div>
                            <label className="text-[10px] uppercase font-bold text-slate-500 block mb-1">Description</label>
                            <textarea className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white h-32" value={data.description} onChange={e=>setData({...data, description:e.target.value})}></textarea>
                        </div>
                    </div>

                    {/* Step 2 */}
                    <div className={`tab-content ${step===2?'active':''} section-card`}>
                        <div className="hidden print:block tab-header">2. Investigation</div>
                        <div className="bg-slate-800/50 p-6 rounded-xl border border-slate-700 space-y-8">
                            <div><h3 className="font-bold text-blue-400 mb-2">Fishbone</h3><Fishbone data={data.investigation.fishbone} onChange={fb => setData({...data, investigation:{...data.investigation, fishbone:fb}})} /></div>
                            <div><h3 className="font-bold text-orange-400 mb-2">Fault Tree</h3><div className="tree overflow-x-auto pb-4"><ul><FaultTreeNode node={data.investigation.faultTree} onUpdate={rt => setData({...data, investigation:{...data.investigation, faultTree:rt}})} /></ul></div></div>
                            <div><h3 className="font-bold text-purple-400 mb-2">5 Whys</h3>{data.investigation.fiveWhys.map((w,i) => (<div key={i} className="flex gap-2 mb-2"><span className="text-slate-500 font-mono text-sm w-16 pt-2">Why {i+1}?</span><input className="flex-1 bg-slate-900 border-b border-slate-700 p-2 text-sm text-white" value={w} onChange={e=>{const arr=[...data.investigation.fiveWhys]; arr[i]=e.target.value; setData({...data, investigation:{...data.investigation, fiveWhys:arr}})}} /></div>))}</div>
                            <div><label className="text-xs font-bold text-emerald-400 uppercase">Root Cause</label><textarea className="w-full bg-emerald-900/10 border border-emerald-500/30 p-3 rounded-lg text-white mt-1" value={data.investigation.rootCause} onChange={e=>setData({...data, investigation:{...data.investigation, rootCause:e.target.value}})}></textarea></div>
                        </div>
                    </div>

                    {/* Step 3 */}
                    <div className={`tab-content ${step===3?'active':''} section-card`}>
                        <div className="hidden print:block tab-header">3. CAPA</div>
                        <div className="bg-slate-800/50 p-6 rounded-xl border border-slate-700">
                            <div className="grid grid-cols-4 gap-2 mb-4 no-print"><input id="act" placeholder="Action" className="col-span-2 bg-slate-900 border border-slate-700 p-2 rounded text-sm text-white"/><input id="own" placeholder="Owner" className="bg-slate-900 border border-slate-700 p-2 rounded text-sm text-white"/><input id="due" type="date" className="bg-slate-900 border border-slate-700 p-2 rounded text-sm text-white"/></div>
                            <button onClick={()=>{const act=document.getElementById('act').value, own=document.getElementById('own').value, due=document.getElementById('due').value; if(act){ setData({...data, capa:[...data.capa, {act, own, due, status:'Open'}]}); document.getElementById('act').value=''; }}} className="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold w-full mb-6 no-print">+ Add Action</button>
                            <table className="w-full text-left text-sm text-slate-300"><thead className="border-b border-slate-600 text-xs uppercase"><tr><th className="pb-2">Action</th><th>Owner</th><th>Due</th><th>Status</th></tr></thead><tbody className="divide-y divide-slate-700">{data.capa.map((c,i)=>(<tr key={i}><td className="py-2">{c.act}</td><td>{c.own}</td><td>{c.due}</td><td>{c.status}</td></tr>))}</tbody></table>
                        </div>
                    </div>

                    {/* Step 4 */}
                    <div className={`tab-content ${step===4?'active':''} section-card`}>
                        <div className="hidden print:block tab-header">4. Review</div>
                        <div className="bg-slate-800/50 p-6 rounded-xl border border-slate-700">
                            <div className="flex justify-between items-center bg-slate-900 p-4 rounded-lg border border-slate-700 mb-6 no-print">
                                <div><h4 className="font-bold text-white">Update Risk Assessment</h4><p className="text-xs text-slate-400">Update HIRA for {data.siteId || 'this site'}?</p></div>
                                <a href={`risk.html?site=${data.siteId}`} target="_blank" className="bg-purple-600 text-white px-4 py-2 rounded font-bold text-sm">Open Risk Module</a>
                            </div>
                            <div className="flex gap-3 items-center mb-8 p-4 border border-slate-700 rounded-lg"><input type="checkbox" className="w-5 h-5" checked={data.riskUpdated} onChange={e=>setData({...data, riskUpdated:e.target.checked})} /><label className="text-sm font-bold text-white">Confirmed Risk Update</label></div>
                            <div className="flex justify-end no-print"><button onClick={saveData} className="bg-emerald-600 text-white font-bold px-8 py-3 rounded-xl">Submit</button></div>
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
