<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO 45001 | Incident Management</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'display': ['Space Grotesk', 'sans-serif'], 'mono': ['JetBrains Mono', 'monospace'] },
                    colors: { 'glass': 'rgba(30, 41, 59, 0.7)' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Space Grotesk', sans-serif; background-color: #0f172a; color: white; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* Print Styles for Report Generation */
        @media print {
            body { background-color: white; color: black; }
            .no-print { display: none !important; }
            .glass-panel { background: white; border: 1px solid #ddd; color: black; box-shadow: none; }
            .print-only { display: block !important; }
            input, textarea, select { border: none; background: transparent; color: black; padding: 0; }
            .text-white { color: black !important; }
            .text-slate-400 { color: #666 !important; }
            .bg-slate-900 { background: white !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", 
            authDomain: "ohsms-fa534.firebaseapp.com",
            databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/",
            projectId: "ohsms-fa534",
            storageBucket: "ohsms-fa534.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { get, ref, set, update, push };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- HELPER: CALCULATE COMPLETION ---
        const checkStatus = (inc) => {
            let missing = [];
            if (!inc.investigation || !inc.investigation.rootCause) missing.push("Investigation");
            if (!inc.capa || inc.capa.length === 0) missing.push("CAPA");
            if (!inc.riskReview) missing.push("Risk Review");
            
            const isOverdue = inc.capa && inc.capa.some(c => new Date(c.dueDate) < new Date() && c.status !== 'Closed');
            
            return {
                pct: Math.round(((3 - missing.length) / 3) * 100),
                missing,
                isOverdue
            };
        };

        // --- SUB-COMPONENT: INCIDENT LIST CARD ---
        const IncidentCard = ({ incident, onView }) => {
            const status = checkStatus(incident);
            return (
                <div className="glass-panel p-5 rounded-2xl border-l-4 border-blue-500 relative group transition-all hover:-translate-y-1">
                    <div className="flex justify-between items-start mb-2">
                        <div>
                            <span className="text-[10px] font-mono bg-slate-800 px-2 py-1 rounded text-blue-300">{incident.id}</span>
                            <h3 className="font-bold text-lg mt-1">{incident.type === 'Accident' ? 'üö® Accident' : '‚ö†Ô∏è Near Miss'}</h3>
                        </div>
                        {status.isOverdue && <span className="bg-red-500/20 text-red-400 text-[10px] font-bold px-2 py-1 rounded uppercase animate-pulse">Overdue Actions</span>}
                    </div>
                    
                    <p className="text-sm text-slate-400 line-clamp-2 mb-4">{incident.description}</p>
                    
                    <div className="flex items-center gap-4 text-xs text-slate-500 mb-4">
                        <span><i className="fas fa-calendar mr-1"></i> {incident.date}</span>
                        <span><i className="fas fa-map-marker-alt mr-1"></i> {incident.siteId}</span>
                    </div>

                    {/* Progress Bar */}
                    <div className="w-full bg-slate-800 h-1.5 rounded-full mb-2 overflow-hidden">
                        <div className={`h-full ${status.pct === 100 ? 'bg-emerald-500' : 'bg-orange-500'}`} style={{width: `${status.pct}%`}}></div>
                    </div>
                    
                    <div className="flex justify-between items-end">
                        <div className="text-[10px] text-slate-400">
                            {status.pct === 100 ? 
                                <span className="text-emerald-400 font-bold"><i className="fas fa-check-circle"></i> Completed</span> : 
                                <span>Missing: {status.missing.join(', ')}</span>
                            }
                        </div>
                        <button onClick={() => onView(incident)} className="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-4 py-2 rounded-lg">View Report</button>
                    </div>
                </div>
            );
        };

        // --- MAIN FORM COMPONENT ---
        const IncidentForm = ({ session, sites, existingData, onBack, onSave }) => {
            const [step, setStep] = useState(1);
            const [data, setData] = useState(existingData || {
                siteId: '', date: '', time: '', type: 'Near Miss', description: '',
                investigation: { fiveWhys: ['','','','',''], fishbone: { man:[], machine:[], material:[], method:[], env:[] }, faultTree: [] },
                capa: [], riskReview: false, riskId: ''
            });

            // Generate ID on Site/Type change
            useEffect(() => {
                if(!existingData && data.siteId && data.type) {
                    const typeCode = data.type === 'Near Miss' ? 'NM' : 'AC';
                    const seq = Math.floor(Math.random() * 1000).toString().padStart(3, '0'); // In real app, fetch count
                    const newId = `${session.orgId}-${data.siteId}-${typeCode}-${seq}`;
                    setData(d => ({ ...d, id: newId }));
                }
            }, [data.siteId, data.type]);

            const handleSave = () => {
                onSave(data);
            };

            const printReport = () => {
                window.print();
            };

            return (
                <div className="max-w-5xl mx-auto w-full animate-fade-in pb-20">
                    
                    {/* Header / Nav */}
                    <div className="flex items-center justify-between mb-6 no-print">
                        <button onClick={onBack} className="text-slate-400 hover:text-white"><i className="fas fa-arrow-left"></i> Back</button>
                        <div className="flex gap-2">
                            {[1,2,3,4].map(i => (
                                <div key={i} onClick={() => setStep(i)} 
                                    className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold cursor-pointer border ${step === i ? 'bg-blue-600 border-blue-600 text-white' : 'border-slate-700 text-slate-500'}`}>
                                    {i}
                                </div>
                            ))}
                        </div>
                        <button onClick={printReport} className="text-blue-400 hover:text-white"><i className="fas fa-print"></i> PDF</button>
                    </div>

                    {/* REPORT HEADER (PRINT ONLY) */}
                    <div className="print-only mb-8 text-center border-b border-black pb-4">
                        <h1 className="text-2xl font-bold">Incident Investigation Report</h1>
                        <p className="text-sm">Report ID: {data.id} | Organization: {session.orgId}</p>
                    </div>

                    {/* STEP 1: INITIAL INFO */}
                    <div className={`${step === 1 ? 'block' : 'hidden'} glass-panel p-8 rounded-2xl`}>
                        <h2 className="text-xl font-bold mb-6 text-blue-400 border-b border-white/10 pb-2">1. Initial Information</h2>
                        <div className="grid grid-cols-2 gap-6 mb-6">
                            <div>
                                <label className="block text-xs uppercase text-slate-500 font-bold mb-1">Site Location</label>
                                <select value={data.siteId} onChange={e=>setData({...data, siteId: e.target.value})} className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white">
                                    <option value="">Select Site</option>
                                    {sites.map(s => <option key={s.code} value={s.code}>{s.name} ({s.code})</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs uppercase text-slate-500 font-bold mb-1">Incident ID (Auto)</label>
                                <input value={data.id || ''} readOnly className="w-full bg-slate-800 border border-slate-700 p-3 rounded-lg text-slate-400 font-mono" />
                            </div>
                            <div>
                                <label className="block text-xs uppercase text-slate-500 font-bold mb-1">Date & Time</label>
                                <div className="flex gap-2">
                                    <input type="date" value={data.date} onChange={e=>setData({...data, date: e.target.value})} className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white" />
                                    <input type="time" value={data.time} onChange={e=>setData({...data, time: e.target.value})} className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs uppercase text-slate-500 font-bold mb-1">Type</label>
                                <select value={data.type} onChange={e=>setData({...data, type: e.target.value})} className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white">
                                    <option>Near Miss</option>
                                    <option>Accident</option>
                                    <option>Hazard Observation</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs uppercase text-slate-500 font-bold mb-1">Description of Incident</label>
                            <textarea rows="5" value={data.description} onChange={e=>setData({...data, description: e.target.value})} className="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white" placeholder="Describe exactly what happened..."></textarea>
                        </div>
                    </div>

                    {/* STEP 2: INVESTIGATION */}
                    <div className={`${step === 2 ? 'block' : 'hidden'} space-y-6`}>
                        <div className="glass-panel p-8 rounded-2xl">
                            <h2 className="text-xl font-bold mb-6 text-blue-400 border-b border-white/10 pb-2">2. Investigation Tools</h2>
                            
                            {/* 5 Whys */}
                            <div className="mb-8">
                                <h3 className="font-bold mb-3 text-white"><i className="fas fa-question-circle text-purple-400 mr-2"></i> 5 Whys Analysis</h3>
                                <div className="space-y-2 pl-4 border-l-2 border-slate-700">
                                    {data.investigation.fiveWhys.map((why, idx) => (
                                        <div key={idx} className="flex gap-2 items-center">
                                            <span className="text-xs font-bold text-slate-500 w-12">Why {idx+1}?</span>
                                            <input value={why} onChange={e => {
                                                const newWhys = [...data.investigation.fiveWhys];
                                                newWhys[idx] = e.target.value;
                                                setData({...data, investigation: {...data.investigation, fiveWhys: newWhys}});
                                            }} className="flex-1 bg-slate-900 border border-slate-700 p-2 rounded text-sm text-white" placeholder={`Reason ${idx+1}`} />
                                        </div>
                                    ))}
                                    <div className="mt-2">
                                        <label className="text-xs font-bold text-emerald-400">Root Cause Conclusion:</label>
                                        <input value={data.investigation.rootCause || ''} onChange={e => setData({...data, investigation: {...data.investigation, rootCause: e.target.value}})} className="w-full bg-emerald-900/20 border border-emerald-500/30 p-2 rounded text-white mt-1" />
                                    </div>
                                </div>
                            </div>

                            {/* Fishbone Simplified */}
                            <div className="mb-8">
                                <h3 className="font-bold mb-3 text-white"><i className="fas fa-fish text-blue-400 mr-2"></i> Fishbone (6M) Factors</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {['Man', 'Machine', 'Material', 'Method', 'Environment'].map(cat => (
                                        <div key={cat} className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                            <label className="text-xs font-bold uppercase text-slate-400">{cat}</label>
                                            <textarea className="w-full bg-transparent text-sm text-white border-none focus:ring-0 mt-1 resize-none" rows="2" 
                                                placeholder={`Issues with ${cat}...`}
                                                value={data.investigation.fishbone[cat.toLowerCase()] || ''}
                                                onChange={e => {
                                                    const fb = {...data.investigation.fishbone, [cat.toLowerCase()]: e.target.value};
                                                    setData({...data, investigation: {...data.investigation, fishbone: fb}});
                                                }}
                                            ></textarea>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Fault Tree Simplified */}
                            <div>
                                <h3 className="font-bold mb-3 text-white"><i className="fas fa-sitemap text-orange-400 mr-2"></i> Fault Tree Analysis</h3>
                                <div className="bg-slate-900 p-4 rounded-xl border border-slate-700">
                                    <div className="flex gap-2 mb-2">
                                        <input id="newFault" className="flex-1 bg-slate-800 border-none rounded p-2 text-sm text-white" placeholder="Add contributing factor..." />
                                        <button onClick={() => {
                                            const val = document.getElementById('newFault').value;
                                            if(val) {
                                                setData({...data, investigation: {...data.investigation, faultTree: [...data.investigation.faultTree, val]}});
                                                document.getElementById('newFault').value = '';
                                            }
                                        }} className="bg-orange-500 text-white px-3 rounded font-bold">+</button>
                                    </div>
                                    <ul className="list-disc pl-5 text-sm text-slate-300">
                                        {data.investigation.faultTree.map((f, i) => <li key={i}>{f}</li>)}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* STEP 3: CAPA */}
                    <div className={`${step === 3 ? 'block' : 'hidden'} glass-panel p-8 rounded-2xl`}>
                        <h2 className="text-xl font-bold mb-6 text-blue-400 border-b border-white/10 pb-2">3. Corrective & Preventive Actions</h2>
                        
                        <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700 mb-4 no-print">
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-2">
                                <input id="actDesc" placeholder="Action Description" className="md:col-span-2 bg-slate-800 border border-slate-700 p-2 rounded text-white" />
                                <input id="actOwner" placeholder="Assigned Dept/User" className="bg-slate-800 border border-slate-700 p-2 rounded text-white" />
                                <input id="actDate" type="date" className="bg-slate-800 border border-slate-700 p-2 rounded text-white" />
                            </div>
                            <button onClick={() => {
                                const desc = document.getElementById('actDesc').value;
                                const owner = document.getElementById('actOwner').value;
                                const date = document.getElementById('actDate').value;
                                if(desc && owner && date) {
                                    setData({...data, capa: [...data.capa, { desc, owner, dueDate: date, status: 'Open' }]});
                                    document.getElementById('actDesc').value = '';
                                }
                            }} className="w-full mt-2 bg-blue-600 hover:bg-blue-500 py-2 rounded font-bold text-sm">Add Action</button>
                        </div>

                        <table className="w-full text-left text-sm">
                            <thead className="text-xs uppercase text-slate-500 border-b border-slate-700">
                                <tr><th>Action</th><th>Owner</th><th>Due Date</th><th>Status</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800">
                                {data.capa.map((action, idx) => (
                                    <tr key={idx}>
                                        <td className="py-3 pr-2">{action.desc}</td>
                                        <td className="py-3">{action.owner}</td>
                                        <td className="py-3 font-mono">{action.dueDate}</td>
                                        <td className="py-3"><span className="bg-orange-500/20 text-orange-400 px-2 py-1 rounded text-xs">{action.status}</span></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* STEP 4: REVIEW & SUBMIT */}
                    <div className={`${step === 4 ? 'block' : 'hidden'} glass-panel p-8 rounded-2xl`}>
                        <h2 className="text-xl font-bold mb-6 text-blue-400 border-b border-white/10 pb-2">4. Review & Risk Linkage</h2>
                        
                        <div className="bg-slate-800/50 p-6 rounded-xl border border-slate-700 flex justify-between items-center mb-6">
                            <div>
                                <h3 className="font-bold text-white">Risk Assessment Update</h3>
                                <p className="text-sm text-slate-400">Does this incident require updating the HIRA/Risk Register?</p>
                            </div>
                            <a href={`risk.html?site=${data.siteId}`} target="_blank" className="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2">
                                <i className="fas fa-external-link-alt"></i> Open Risk Register
                            </a>
                        </div>
                        
                        <div className="flex items-center gap-3 mb-8">
                            <input type="checkbox" id="riskCheck" checked={data.riskReview} onChange={e => setData({...data, riskReview: e.target.checked})} className="w-5 h-5" />
                            <label htmlFor="riskCheck" className="text-sm text-white">I confirm that the Risk Assessment has been reviewed/updated based on this incident.</label>
                        </div>

                        <div className="border-t border-slate-700 pt-6 flex justify-end gap-4 no-print">
                            <button onClick={onBack} className="px-6 py-3 rounded-xl border border-slate-600 text-slate-300 font-bold">Cancel</button>
                            <button onClick={handleSave} className="px-8 py-3 rounded-xl bg-gradient-to-r from-emerald-600 to-emerald-500 text-white font-bold shadow-lg shadow-emerald-500/20">
                                <i className="fas fa-save mr-2"></i> Save & Close Case
                            </button>
                        </div>
                    </div>

                </div>
            );
        };

        // --- ROOT APP ---
        const App = () => {
            const [view, setView] = useState('list'); // 'list' or 'form'
            const [session, setSession] = useState(null);
            const [sites, setSites] = useState([]);
            const [incidents, setIncidents] = useState([]);
            const [editData, setEditData] = useState(null);

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) window.location.href = 'index.html';
                setSession(JSON.parse(s));
                fetchData(JSON.parse(s).orgId);
            }, []);

            const fetchData = async (orgId) => {
                const dbRef = window.fb.ref(window.db);
                const snapshot = await window.fb.get(window.fb.child(dbRef, `organizations/${orgId}`));
                if(snapshot.exists()) {
                    const val = snapshot.val();
                    setSites(val.sites ? Object.values(val.sites) : []);
                    const incList = val.incidents ? Object.entries(val.incidents).map(([k,v]) => ({firebaseKey: k, ...v})) : [];
                    setIncidents(incList);
                }
            };

            const saveIncident = async (data) => {
                const dbPath = `organizations/${session.orgId}/incidents`;
                if(data.firebaseKey) {
                    // Update
                    await window.fb.update(window.fb.ref(window.db, `${dbPath}/${data.firebaseKey}`), data);
                } else {
                    // New
                    await window.fb.push(window.fb.ref(window.db, dbPath), data);
                }
                fetchData(session.orgId);
                setView('list');
            };

            if(!session) return null;

            return (
                <div className="flex-1 flex flex-col p-6 max-w-7xl mx-auto w-full">
                    {view === 'list' && (
                        <div className="animate-fade-in">
                            <div className="flex justify-between items-center mb-8">
                                <div>
                                    <h1 className="text-3xl font-bold text-white">Incident Dashboard</h1>
                                    <p className="text-slate-400">Track and investigate safety events</p>
                                </div>
                                <div className="flex gap-4">
                                    <a href="home.html" className="px-4 py-2 rounded-lg border border-slate-700 text-slate-400 hover:text-white font-bold">Back to Hub</a>
                                    <button onClick={() => { setEditData(null); setView('form'); }} className="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg">
                                        + Report Incident
                                    </button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {incidents.length === 0 && <div className="col-span-full text-center py-20 text-slate-500">No incidents reported yet.</div>}
                                {incidents.map(inc => (
                                    <IncidentCard key={inc.id} incident={inc} onView={(data) => { setEditData(data); setView('form'); }} />
                                ))}
                            </div>
                        </div>
                    )}

                    {view === 'form' && (
                        <IncidentForm 
                            session={session} 
                            sites={sites} 
                            existingData={editData} 
                            onBack={() => setView('list')} 
                            onSave={saveIncident} 
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <style>.animate-fade-in { animation: fadeIn 0.4s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }</style>
</body>
</html>
