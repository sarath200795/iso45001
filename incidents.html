<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incident Management</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'slate-850': '#1e293b', 'slate-950': '#020617' },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-in-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; }
        
        /* DIAGRAM STYLES */
        .fishbone-container { position: relative; padding: 20px 0; overflow-x: auto; }
        .spine { position: absolute; top: 50%; left: 0; right: 120px; height: 3px; background: #64748b; z-index: 0; }
        .spine::after { content: ''; position: absolute; right: -20px; top: -10px; border-left: 20px solid #64748b; border-top: 10px solid transparent; border-bottom: 10px solid transparent; }
        .head { position: absolute; top: 50%; right: 0; transform: translateY(-50%); width: 100px; height: 80px; border: 3px solid #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #1e293b; z-index: 10; color: #ef4444; font-weight: bold; text-align: center; font-size: 12px; }
        .ribs-top, .ribs-bottom { display: flex; justify-content: space-between; padding-right: 120px; }
        .rib-box { background: #1e293b; border: 1px solid #475569; padding: 8px; border-radius: 6px; width: 18%; position: relative; transition: all 0.2s; }
        .ribs-top .rib-box { margin-bottom: 40px; }
        .ribs-bottom .rib-box { margin-top: 40px; }
        .ribs-top .rib-box::after { content: ''; position: absolute; bottom: -40px; left: 50%; width: 2px; height: 40px; background: #64748b; transform: skewX(-20deg); transform-origin: top; }
        .ribs-bottom .rib-box::before { content: ''; position: absolute; top: -40px; left: 50%; width: 2px; height: 40px; background: #64748b; transform: skewX(20deg); transform-origin: bottom; }

        /* TREE STYLES */
        .tree ul { padding-top: 20px; position: relative; display: flex; justify-content: center; transition: all 0.5s; }
        .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; transition: all 0.5s; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 2px solid #64748b; width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 2px solid #64748b; }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 2px solid #64748b; border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 2px solid #64748b; width: 0; height: 20px; }
        .tree-node { display: inline-block; padding: 10px; border-radius: 8px; background: #1e293b; border: 1px solid #475569; min-width: 140px; position: relative; z-index: 10; transition: all 0.2s; }
        
        /* GENERAL UI */
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; outline: none; width: 100%; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #3b82f6; }

        /* --- PDF PRINT ENGINE FIXES --- */
        @media print {
            @page { size: A4; margin: 10mm; }
            
            /* 1. Reset Page Layout */
            body, html, #root, .flex-col, .h-screen { 
                height: auto !important; 
                overflow: visible !important; 
                display: block !important; 
                background: white !important;
                color: black !important;
            }

            /* 2. Hide Non-Printables */
            .no-print, .glass-panel-filters, header { display: none !important; }

            /* 3. Force Show All Tabs */
            .tab-content { 
                display: block !important; 
                opacity: 1 !important; 
                margin-bottom: 25px; 
                page-break-inside: avoid;
                border: 1px solid #ccc;
                padding: 15px;
                border-radius: 8px;
            }

            /* 4. Fix Typography & Colors */
            .section-heading { 
                color: black !important; 
                border-bottom: 2px solid black !important; 
                margin-bottom: 10px; 
                font-size: 14pt; 
                font-weight: bold;
                display: block !important;
            }
            input, textarea, select { 
                background: white !important; 
                border: 1px solid #ddd !important; 
                color: black !important; 
                font-size: 10pt;
                resize: none;
            }
            .text-white, .text-slate-400, .text-slate-500 { color: black !important; }
            .bg-slate-900, .bg-slate-800 { background: white !important; border: none !important; }

            /* 5. Fix Diagrams */
            .rib-box, .tree-node { 
                background: white !important; 
                border: 1px solid black !important; 
                color: black !important; 
                box-shadow: none !important; 
            }
            .spine, .spine::after, .ribs-top .rib-box::after, .ribs-bottom .rib-box::before, .tree li::before, .tree li::after, .tree ul ul::before { 
                background: black !important; 
                border-left-color: black !important; 
                border-color: black !important; 
            }
            .head { background: white !important; color: black !important; border-color: black !important; }

            /* 6. Header Logic */
            .pdf-header { 
                display: flex !important; 
                justify-content: space-between; 
                border-bottom: 2px solid black; 
                padding-bottom: 10px; 
                margin-bottom: 20px; 
            }
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .pdf-header { display: none; }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, get, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", authDomain: "ohsms-fa534.firebaseapp.com", databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/", projectId: "ohsms-fa534", storageBucket: "ohsms-fa534.appspot.com", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { ref, push, get, update, remove };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- COMPONENTS ---
        const RibBox = ({ title, cat, data, onAdd, onUpdate, onRemove }) => (
            <div className="rib-box">
                <div className="flex justify-between mb-1 border-b border-slate-600 pb-1">
                    <span className="text-[9px] font-bold uppercase text-slate-400 print:text-black">{title}</span>
                    <button onClick={() => onAdd(cat)} className="text-[10px] text-green-400 no-print hover:text-green-300">+</button>
                </div>
                {(data[cat] || []).map((v, i) => (
                    <div key={i} className="flex group mb-1">
                        <input value={v} onChange={(e) => onUpdate(cat, i, e.target.value)} className="w-full bg-transparent text-[10px] border-b border-slate-700 mb-1 outline-none text-white print:text-black focus:border-blue-500" />
                        <button onClick={() => onRemove(cat, i)} className="text-red-500 text-[8px] opacity-0 group-hover:opacity-100 ml-1 no-print">x</button>
                    </div>
                ))}
            </div>
        );

        const Fishbone = ({ data, onChange }) => {
            const update = (cat, i, val) => { const arr = [...data[cat]]; arr[i] = val; onChange({ ...data, [cat]: arr }); };
            const add = (cat) => onChange({ ...data, [cat]: [...(data[cat] || []), ''] });
            const remove = (cat, i) => { const arr = [...data[cat]]; arr.splice(i, 1); onChange({ ...data, [cat]: arr }); };
            return (
                <div className="fishbone-container mt-8">
                    <div className="spine"></div><div className="head">INCIDENT</div>
                    <div className="ribs-top">
                        <RibBox title="Man" cat="man" data={data} onAdd={add} onUpdate={update} onRemove={remove} />
                        <RibBox title="Machine" cat="machine" data={data} onAdd={add} onUpdate={update} onRemove={remove} />
                        <RibBox title="Material" cat="material" data={data} onAdd={add} onUpdate={update} onRemove={remove} />
                    </div>
                    <div className="ribs-bottom">
                        <RibBox title="Method" cat="method" data={data} onAdd={add} onUpdate={update} onRemove={remove} />
                        <RibBox title="Environment" cat="environment" data={data} onAdd={add} onUpdate={update} onRemove={remove} />
                        <div style={{ width: '18%' }}></div>
                    </div>
                </div>
            );
        };

        const FaultTreeNode = ({ node, onUpdate, onDelete, onAddSibling }) => {
            const handleAddChild = () => { onUpdate({ ...node, children: [...(node.children || []), { id: Date.now(), label: 'New Cause', type: 'EVENT', children: [] }] }); };
            const toggleType = () => { const types = ['EVENT', 'AND', 'OR', 'ROOT']; onUpdate({ ...node, type: types[(types.indexOf(node.type) + 1) % types.length] }); };
            const updateChild = (i, d) => { const k = [...node.children]; k[i] = d; onUpdate({ ...node, children: k }); };
            const deleteChild = (i) => { onUpdate({ ...node, children: node.children.filter((_, x) => x !== i) }); };
            const addSiblingToChild = () => { onUpdate({ ...node, children: [...node.children, { id: Date.now(), label: 'Parallel Cause', type: 'EVENT', children: [] }] }); };

            return (
                <li>
                    <div className="tree-node group">
                        <div className="absolute -top-3 right-0 opacity-0 group-hover:opacity-100 flex gap-1 no-print z-30 transition-opacity">
                            <button onClick={handleAddChild} className="bg-blue-600 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center shadow hover:scale-110" title="Add Child (Down)">↓</button>
                            {onAddSibling && <button onClick={onAddSibling} className="bg-purple-600 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center shadow hover:scale-110" title="Add Parallel (Right)">→</button>}
                            {onDelete && <button onClick={onDelete} className="bg-red-600 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center shadow hover:scale-110" title="Delete">x</button>}
                        </div>
                        <input value={node.label} onChange={e=>onUpdate({...node, label: e.target.value})} className="bg-transparent text-center text-xs font-bold w-full outline-none border-b border-transparent focus:border-blue-500 pb-1" placeholder="Event..." />
                        <div onClick={toggleType} className="mt-1 cursor-pointer no-print select-none"><span className={`text-[9px] px-1.5 rounded font-mono border ${node.type==='AND'?'border-purple-500 text-purple-400':node.type==='OR'?'border-orange-500 text-orange-400':node.type==='ROOT'?'border-emerald-500 text-emerald-400':'border-slate-600 text-slate-500'}`}>{node.type}</span></div>
                        <div className="hidden print:block text-[8px] font-bold text-center mt-1">[{node.type}]</div>
                    </div>
                    {node.children && node.children.length > 0 && <ul>{node.children.map((child, i) => (<FaultTreeNode key={child.id} node={child} onUpdate={d=>updateChild(i,d)} onDelete={()=>deleteChild(i)} onAddSibling={addSiblingToChild} />))}</ul>}
                </li>
            );
        };

        // --- REPOSITORY COMPONENT ---
        const IncidentRepository = ({ incidents, onEdit, onPrint, onDelete, userRole }) => {
            const [filterType, setFilterType] = useState('All');
            const [filterLevel, setFilterLevel] = useState('All');
            const [filterSite, setFilterSite] = useState('All');
            const [dateFrom, setDateFrom] = useState('');
            const [dateTo, setDateTo] = useState('');

            const uniqueSites = useMemo(() => {
                const sites = new Set(incidents.map(i => i.siteId).filter(Boolean));
                return ['All', ...Array.from(sites)];
            }, [incidents]);

            const filteredData = useMemo(() => {
                return incidents.filter(item => {
                    const matchType = filterType === 'All' || item.type === filterType;
                    const matchLevel = filterLevel === 'All' || item.severity === filterLevel;
                    const matchSite = filterSite === 'All' || item.siteId === filterSite;
                    let matchDate = true;
                    if (dateFrom && dateTo) { matchDate = item.date >= dateFrom && item.date <= dateTo; }
                    return matchType && matchLevel && matchDate && matchSite;
                });
            }, [incidents, filterType, filterLevel, filterSite, dateFrom, dateTo]);

            const exportToExcel = () => {
                const dataToExport = filteredData.map(({ id, date, time, siteId, type, severity, description }) => ({
                    ID: id, Date: date, Time: time, Site: siteId, Type: type, Severity: severity, Description: description
                }));
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Incidents");
                XLSX.writeFile(wb, "Incident_Repository.xlsx");
            };

            return (
                <div className="space-y-6 animate-fade-in glass-panel-filters">
                    <div className="p-6 rounded-xl bg-gradient-to-r from-purple-900/40 to-slate-900 border border-purple-500/30 mb-6">
                        <div className="flex justify-between items-start mb-6">
                            <div><h2 className="text-2xl font-bold text-white flex items-center gap-3"><span className="w-10 h-10 rounded-lg bg-purple-600 flex items-center justify-center text-lg"><i className="fas fa-database"></i></span>Incident Repository</h2><p className="text-slate-400 text-sm mt-1 ml-14">Central database of all reported incidents.</p></div>
                            <button onClick={exportToExcel} className="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg"><i className="fas fa-file-excel"></i> Export</button>
                        </div>
                        <div className="flex gap-4 items-end flex-wrap">
                            <div><label className="text-[10px] text-purple-300 font-bold uppercase block mb-1">From Date</label><input type="date" value={dateFrom} onChange={e=>setDateFrom(e.target.value)} className="w-32 bg-slate-800 border-slate-600 text-xs rounded-lg p-2" /></div>
                            <div><label className="text-[10px] text-purple-300 font-bold uppercase block mb-1">To Date</label><input type="date" value={dateTo} onChange={e=>setDateTo(e.target.value)} className="w-32 bg-slate-800 border-slate-600 text-xs rounded-lg p-2" /></div>
                            <div><label className="text-[10px] text-purple-300 font-bold uppercase block mb-1">Site ID</label><select value={filterSite} onChange={e=>setFilterSite(e.target.value)} className="w-32 bg-slate-800 border-slate-600 text-xs rounded-lg p-2">{uniqueSites.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                            <div><label className="text-[10px] text-purple-300 font-bold uppercase block mb-1">Type</label><select value={filterType} onChange={e=>setFilterType(e.target.value)} className="w-32 bg-slate-800 border-slate-600 text-xs rounded-lg p-2"><option value="All">All Types</option><option>Near Miss</option><option>Accident</option><option>Hazard</option><option>Property Damage</option></select></div>
                            <div><label className="text-[10px] text-purple-300 font-bold uppercase block mb-1">Severity</label><select value={filterLevel} onChange={e=>setFilterLevel(e.target.value)} className="w-32 bg-slate-800 border-slate-600 text-xs rounded-lg p-2"><option value="All">All Levels</option><option value="Level A">Level A</option><option value="Level B">Level B</option><option value="Level C">Level C</option><option value="Level D">Level D</option></select></div>
                        </div>
                    </div>
                    <div className="glass-panel rounded-xl overflow-hidden border border-slate-700 shadow-xl">
                        <table className="w-full text-left text-sm text-slate-300">
                            <thead className="bg-slate-900 text-xs uppercase font-bold text-slate-500"><tr><th className="p-4">Incident ID</th><th className="p-4">Date</th><th className="p-4">Site</th><th className="p-4">Type</th><th className="p-4">Level</th><th className="p-4 text-right">Actions</th></tr></thead>
                            <tbody className="divide-y divide-slate-800">
                                {filteredData.map(inc => (
                                    <tr key={inc.id} className="hover:bg-slate-800/50 transition-colors">
                                        <td className="p-4 font-mono font-bold text-white">{inc.id}</td>
                                        <td className="p-4">{inc.date}</td>
                                        <td className="p-4 text-emerald-400 font-mono text-xs">{inc.siteId}</td>
                                        <td className="p-4">{inc.type}</td>
                                        <td className="p-4"><span className={`px-2 py-1 rounded text-[10px] font-bold border ${inc.severity==='Level A'?'bg-red-500/10 text-red-400 border-red-500/20':inc.severity==='Level B'?'bg-orange-500/10 text-orange-400 border-orange-500/20':inc.severity==='Level C'?'bg-yellow-500/10 text-yellow-400 border-yellow-500/20':'bg-blue-500/10 text-blue-400 border-blue-500/20'}`}>{inc.severity}</span></td>
                                        <td className="p-4 text-right flex justify-end gap-2">
                                            <button onClick={()=>onPrint(inc)} className="text-red-400 hover:text-white bg-red-500/10 hover:bg-red-500 px-3 py-1.5 rounded transition"><i className="fas fa-file-pdf"></i></button>
                                            <button onClick={()=>onEdit(inc)} className="text-purple-400 hover:text-white bg-purple-500/10 hover:bg-purple-500 px-3 py-1.5 rounded transition">Edit</button>
                                            {userRole === 'Owner' && <button onClick={()=>onDelete(inc)} className="text-slate-400 hover:text-white bg-slate-700 hover:bg-red-600 px-3 py-1.5 rounded transition"><i className="fas fa-trash-alt"></i></button>}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('form'); 
            const [step, setStep] = useState(1);
            const [session, setSession] = useState(null);
            const [isGlobal, setIsGlobal] = useState(false);
            const [incidentsList, setIncidentsList] = useState([]);
            const [seq, setSeq] = useState(0);
            
            const [data, setData] = useState({
                id: '', siteId: '', date: new Date().toISOString().split('T')[0], time: '', 
                type: 'Near Miss', severity: 'Level A', description: '',
                investigation: { 
                    fiveWhys: [ { id: 1, name: 'Analysis Path 1', whys: ['','','','',''] } ], 
                    fishbone: { man:[], machine:[], material:[], method:[], environment:[] }, 
                    faultTree: { id:1, label:'Top Event', type:'AND', children:[] }, 
                    rootCause: '' 
                },
                capa: [], riskUpdated: false
            });

            // Helper to get type code
            const getTypeCode = (type) => {
                if(type === 'Near Miss') return 'NM';
                if(type === 'Accident') return 'AC';
                if(type === 'Hazard') return 'HA';
                if(type === 'Property Damage') return 'PD';
                return 'XX';
            };

            // Initial Load
            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) { window.location.href='index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);

                const params = new URLSearchParams(window.location.search);
                let ctxSite = params.get('site');
                if (!ctxSite || ctxSite === 'GLOBAL') { setIsGlobal(true); ctxSite = ''; } else { setIsGlobal(false); }

                const newSeq = Math.floor(100000 + Math.random() * 900000); 
                setSeq(newSeq);

                setData(prev => ({ 
                    ...prev, 
                    siteId: ctxSite,
                    id: `${sess.orgId}-${ctxSite || 'GEN'}-${getTypeCode(prev.type)}-${newSeq}`
                }));

                window.fb.get(window.fb.ref(window.db, `organizations/${sess.orgId}/incidents`)).then(snap => {
                    if(snap.exists()) {
                        const all = Object.entries(snap.val()).map(([k,v]) => ({firebaseKey:k, ...v}));
                        setIncidentsList(all);
                    }
                });
            }, []);

            const handleTypeChange = (newType) => {
                if (!data.firebaseKey && session) {
                    const newId = `${session.orgId}-${data.siteId || 'GEN'}-${getTypeCode(newType)}-${seq}`;
                    setData(prev => ({ ...prev, type: newType, id: newId }));
                } else {
                    setData(prev => ({ ...prev, type: newType }));
                }
            };

            const saveData = async () => {
                if(!data.siteId) { alert("Please enter a Site ID"); return; }
                if(data.firebaseKey) {
                    await window.fb.update(window.fb.ref(window.db, `organizations/${session.orgId}/incidents/${data.firebaseKey}`), data);
                } else {
                    await window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/incidents`), data);
                }
                alert("Incident Saved!");
                window.location.reload();
            };

            const handleDelete = async (incident) => {
                if(confirm("Are you sure you want to delete this incident record permanently?")) {
                    await window.fb.remove(window.fb.ref(window.db, `organizations/${session.orgId}/incidents/${incident.firebaseKey}`));
                    alert("Deleted.");
                    window.location.reload();
                }
            };

            const handleEdit = (incident) => {
                let updatedWhys = incident.investigation?.fiveWhys || [{ id: 1, name: 'Analysis Path 1', whys: ['','','','',''] }];
                if (Array.isArray(updatedWhys) && typeof updatedWhys[0] === 'string') {
                    updatedWhys = [{ id: Date.now(), name: 'Legacy Analysis', whys: updatedWhys }];
                }
                setData({ ...incident, investigation: { ...incident.investigation, fiveWhys: updatedWhys } });
                setView('form');
                setStep(1);
            };

            const handleRepoPrint = (incident) => {
                handleEdit(incident);
                setTimeout(() => { window.print(); }, 800); 
            };

            const openInvestigationMeeting = () => {
                if(!data.siteId) { alert("Please enter a Site ID first."); return; }
                const agendaText = `Discussion on Incident ${data.id} (${data.severity}): ${data.description.substring(0, 100)}...`;
                const params = new URLSearchParams({ site: data.siteId, interaction: 'Consultation', category: 'Incident Investigation', date: data.date, time: data.time, agenda: agendaText });
                window.open(`consultation.html?${params.toString()}`, '_blank');
            };

            // 5-Why Helpers
            const addFiveWhyPath = () => {
                const newCount = data.investigation.fiveWhys.length + 1;
                setData(prev => ({ ...prev, investigation: { ...prev.investigation, fiveWhys: [...prev.investigation.fiveWhys, { id: Date.now(), name: `Analysis Path ${newCount}`, whys: ['','','','',''] }] } }));
            };
            const updateFiveWhy = (pIdx, wIdx, val) => {
                const paths = [...data.investigation.fiveWhys]; paths[pIdx].whys[wIdx] = val;
                setData(prev => ({ ...prev, investigation: { ...prev.investigation, fiveWhys: paths } }));
            };
            const updatePathName = (pIdx, val) => {
                const paths = [...data.investigation.fiveWhys]; paths[pIdx].name = val;
                setData(prev => ({ ...prev, investigation: { ...prev.investigation, fiveWhys: paths } }));
            };
            const removeFiveWhyPath = (idx) => {
                setData(prev => ({ ...prev, investigation: { ...prev.investigation, fiveWhys: prev.investigation.fiveWhys.filter((_, i) => i !== idx) } }));
            };

            if(!session) return null;

            const STEPS = [ { id: 1, label: 'Initial' }, ...(data.severity !== 'Level D' ? [{ id: 2, label: 'Team & Consult' }] : []), { id: 3, label: 'Investigate' }, { id: 4, label: 'CAPA' }, { id: 5, label: 'Review' } ];

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-white font-sans overflow-hidden">
                    {/* Header */}
                    <div className="h-16 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-6 shadow-lg z-10 no-print">
                        <div className="flex items-center gap-4"><a href="home.html" className="text-slate-400 hover:text-white transition"><i className="fas fa-arrow-left"></i> Back</a><h1 className="font-bold text-lg tracking-tight">Incident Management</h1></div>
                        <div className="flex bg-slate-900 p-1 rounded-xl border border-slate-700 shadow-inner">
                            <button onClick={()=>{setView('form'); if(data.firebaseKey) window.location.reload();}} className={`px-5 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 ${view==='form'?'bg-blue-600 text-white shadow-md transform scale-105':'text-slate-400 hover:text-white'}`}><i className="fas fa-plus-circle"></i> New Report</button>
                            <div className="w-px bg-slate-700 mx-1"></div>
                            <button onClick={()=>setView('repo')} className={`px-5 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 ${view==='repo'?'bg-purple-600 text-white shadow-md transform scale-105':'text-slate-400 hover:text-white'}`}><i className="fas fa-database"></i> Repository</button>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 max-w-7xl mx-auto w-full">
                        {view === 'repo' && <IncidentRepository incidents={incidentsList} onEdit={handleEdit} onPrint={handleRepoPrint} onDelete={handleDelete} userRole={session.role} siteContext={isGlobal ? 'GLOBAL' : data.siteId} />}
                        {view === 'form' && (
                            <div className="animate-fade-in pb-20">
                                {/* PDF HEADER */}
                                <div className="pdf-header">
                                    <div><h1 className="text-2xl font-bold uppercase">Incident Report</h1><p className="text-sm">Org: {session.orgId}</p></div>
                                    <div className="text-right"><p className="text-xl font-mono font-bold">{data.id}</p><p className="text-sm">Date: {data.date}</p></div>
                                </div>

                                <div className="flex flex-col md:flex-row justify-between items-center mb-8 no-print gap-4">
                                    <div className="flex bg-slate-900 p-1 rounded-full border border-slate-700 overflow-x-auto max-w-full">
                                        {STEPS.map(s => <button key={s.id} onClick={()=>setStep(s.id)} className={`px-4 py-2 rounded-full text-[10px] sm:text-xs font-bold whitespace-nowrap transition-all duration-300 ${step===s.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500 hover:text-white hover:bg-slate-800'}`}>{s.label}</button>)}
                                    </div>
                                    <button onClick={()=>window.print()} className="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition-colors shadow-lg shadow-emerald-900/20 flex items-center gap-2"><i className="fas fa-print"></i> PDF</button>
                                </div>

                                <div className={`tab-content ${step===1?'active':''} section-card`}>
                                    <h2 className="section-heading text-xl font-bold text-blue-400 mb-6 flex items-center gap-3 border-b border-blue-500/20 pb-4"><i className="fas fa-info-circle"></i> 1. Initial Information</h2>
                                    <div className="bg-slate-800/50 p-8 rounded-2xl border border-slate-700 shadow-xl">
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-8 mb-6">
                                            <div><label className="text-[11px] uppercase font-bold text-slate-500 block mb-2 tracking-wider">Site Location ID</label>{isGlobal ? <input className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white focus:border-blue-500 outline-none" value={data.siteId} onChange={e=>setData({...data, siteId:e.target.value})} /> : <div className="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-xl text-emerald-400 font-mono font-bold flex items-center gap-2"><i className="fas fa-lock text-slate-600"></i> {data.siteId}</div>}</div>
                                            <div><label className="text-[11px] uppercase font-bold text-slate-500 block mb-2 tracking-wider">Incident Type</label><select className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white focus:border-blue-500 outline-none" value={data.type} onChange={e=>handleTypeChange(e.target.value)}><option>Near Miss</option><option>Accident</option><option>Hazard</option><option>Property Damage</option></select></div>
                                            <div><label className="text-[11px] uppercase font-bold text-slate-500 block mb-2 tracking-wider">Severity</label><select className={`w-full border p-4 rounded-xl text-white font-bold outline-none ${data.severity==='Level D'?'bg-slate-900 border-slate-700':'bg-red-900/20 border-red-500/50 text-red-400'}`} value={data.severity} onChange={e=>setData({...data, severity:e.target.value})}><option value="Level A">Level A (Critical)</option><option value="Level B">Level B (Major)</option><option value="Level C">Level C (Moderate)</option><option value="Level D">Level D (Minor)</option></select></div>
                                            <div><label className="text-[11px] uppercase font-bold text-slate-500 block mb-2 tracking-wider">Date</label><input type="date" className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white" value={data.date} onChange={e=>setData({...data, date:e.target.value})} /></div>
                                            <div><label className="text-[11px] uppercase font-bold text-slate-500 block mb-2 tracking-wider">Time</label><input type="time" className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white" value={data.time} onChange={e=>setData({...data, time:e.target.value})} /></div>
                                        </div>
                                        <label className="text-[11px] uppercase font-bold text-slate-500 block mb-2 tracking-wider">Description</label>
                                        <textarea className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white h-40 focus:border-blue-500 outline-none resize-none" value={data.description} onChange={e=>setData({...data, description:e.target.value})}></textarea>
                                    </div>
                                </div>

                                {data.severity !== 'Level D' && (
                                    <div className={`tab-content ${step===2?'active':''} section-card`}>
                                        <h2 className="section-heading text-xl font-bold text-teal-400 mb-6 flex items-center gap-3 border-b border-teal-500/20 pb-4"><i className="fas fa-users"></i> 2. Team & Consultation</h2>
                                        <div className="bg-slate-800/50 p-8 rounded-2xl border border-slate-700 shadow-xl flex flex-col items-center text-center space-y-6">
                                            <div className="w-16 h-16 rounded-full bg-teal-500/10 flex items-center justify-center text-3xl text-teal-400"><i className="fas fa-comments"></i></div>
                                            <div><h3 className="text-xl font-bold text-white mb-2">Record Investigation Meeting</h3><p className="text-slate-400 text-sm max-w-lg mx-auto">Open Consultation module to record minutes for "Incident Investigation".</p></div>
                                            <button onClick={openInvestigationMeeting} className="bg-teal-600 hover:bg-teal-500 text-white font-bold py-4 px-8 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex items-center gap-3">Launch Meeting <i className="fas fa-external-link-alt"></i></button>
                                        </div>
                                    </div>
                                )}

                                <div className={`tab-content ${step===3?'active':''} section-card`}>
                                    <h2 className="section-heading text-xl font-bold text-purple-400 mb-6 flex items-center gap-3 border-b border-purple-500/20 pb-4"><i className="fas fa-search"></i> 3. Root Cause Analysis</h2>
                                    <div className="bg-slate-800/50 p-8 rounded-2xl border border-slate-700 shadow-xl">
                                        <div><h3 className="font-bold text-white mb-2 pl-2 border-l-4 border-blue-500">Fishbone Diagram</h3><Fishbone data={data.investigation.fishbone} onChange={fb => setData({...data, investigation:{...data.investigation, fishbone:fb}})} /></div>
                                        <div className="border-t border-slate-700 pt-8"><h3 className="font-bold text-white mb-2 pl-2 border-l-4 border-orange-500">Fault Tree Analysis</h3><div className="tree overflow-x-auto pb-4"><ul><FaultTreeNode node={data.investigation.faultTree} onUpdate={rt => setData({...data, investigation:{...data.investigation, faultTree:rt}})} /></ul></div></div>
                                        <div className="border-t border-slate-700 pt-8">
                                            <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-white pl-2 border-l-4 border-purple-500">5 Whys Analysis</h3><button onClick={addFiveWhyPath} className="bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1 rounded-lg transition no-print">+ Add Analysis Path</button></div>
                                            {data.investigation.fiveWhys.map((path, pIdx) => (
                                                <div key={path.id} className="mb-6 bg-slate-900/50 p-4 rounded-xl border border-slate-700 relative group">
                                                    <div className="flex justify-between items-center mb-3 border-b border-slate-700 pb-2"><input value={path.name || `Analysis Path ${pIdx+1}`} onChange={e => updatePathName(pIdx, e.target.value)} className="bg-transparent text-[10px] font-bold text-purple-300 uppercase tracking-wider outline-none border-b border-transparent focus:border-purple-500 w-64 transition-all" />{data.investigation.fiveWhys.length > 1 && <button onClick={() => removeFiveWhyPath(pIdx)} className="text-red-400 hover:text-red-300 text-xs no-print hover:bg-red-900/20 px-2 py-1 rounded transition"><i className="fas fa-trash-alt mr-1"></i> Remove</button>}</div>
                                                    {path.whys.map((w, i) => (<div key={i} className="flex gap-4 mb-3 items-center"><span className="text-slate-500 font-mono text-xs w-16 text-right font-bold">WHY {i+1}?</span><input className="flex-1 bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-blue-500 outline-none shadow-sm" value={w} onChange={e => updateFiveWhy(pIdx, i, e.target.value)} placeholder="Enter cause..." /></div>))}
                                                </div>
                                            ))}
                                        </div>
                                        <div className="border-t border-slate-700 pt-8"><label className="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-2 block">Final Root Cause</label><textarea className="w-full bg-emerald-900/10 border border-emerald-500/30 p-4 rounded-xl text-white h-24 focus:ring-1 focus:ring-emerald-500 outline-none" value={data.investigation.rootCause} onChange={e=>setData({...data, investigation:{...data.investigation, rootCause:e.target.value}})}></textarea></div>
                                    </div>
                                </div>

                                <div className={`tab-content ${step===4?'active':''} section-card`}>
                                    <h2 className="section-heading text-xl font-bold text-orange-400 mb-6 flex items-center gap-3 border-b border-orange-500/20 pb-4"><i className="fas fa-clipboard-check"></i> 4. CAPA</h2>
                                    <div className="bg-slate-800/50 p-8 rounded-2xl border border-slate-700 shadow-xl">
                                        <div className="grid grid-cols-4 gap-4 mb-6 no-print">
                                            <input id="act" placeholder="Action Description" className="col-span-2 bg-slate-900 border border-slate-700 p-3 rounded-xl text-sm text-white focus:border-blue-500 outline-none"/>
                                            <input id="own" placeholder="Assigned To" className="bg-slate-900 border border-slate-700 p-3 rounded-xl text-sm text-white focus:border-blue-500 outline-none"/>
                                            <input id="due" type="date" className="bg-slate-900 border border-slate-700 p-3 rounded-xl text-sm text-white focus:border-blue-500 outline-none"/>
                                        </div>
                                        <button onClick={()=>{const act=document.getElementById('act').value, own=document.getElementById('own').value, due=document.getElementById('due').value; if(act){ setData({...data, capa:[...data.capa, {act, own, due, status:'Open'}]}); document.getElementById('act').value=''; }}} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl text-sm font-bold w-full mb-8 no-print shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-2"><i className="fas fa-plus"></i> Add Action Item</button>
                                        <div className="overflow-hidden rounded-xl border border-slate-700"><table className="w-full text-left text-sm text-slate-300"><thead className="bg-slate-900 text-xs uppercase font-bold text-slate-500"><tr><th className="p-4">Action</th><th className="p-4">Owner</th><th className="p-4">Due Date</th><th className="p-4">Status</th></tr></thead><tbody className="divide-y divide-slate-700">{data.capa.map((c,i)=>(<tr key={i}><td className="p-4">{c.act}</td><td className="p-4">{c.own}</td><td className="p-4">{c.due}</td><td className="p-4"><span className="bg-orange-500/10 text-orange-400 px-2 py-1 rounded text-[10px]">{c.status}</span></td></tr>))}</tbody></table></div>
                                    </div>
                                </div>

                                <div className={`tab-content ${step===5?'active':''} section-card`}>
                                    <h2 className="section-heading text-xl font-bold text-emerald-400 mb-6 flex items-center gap-3 border-b border-emerald-500/20 pb-4"><i className="fas fa-check-double"></i> 5. Review</h2>
                                    <div className="bg-slate-800/50 p-8 rounded-2xl border border-slate-700 shadow-xl">
                                        <div className="flex justify-between items-center bg-slate-900 p-6 rounded-xl border border-slate-700 mb-8 no-print shadow-inner">
                                            <div><h4 className="font-bold text-white text-lg">Update Risk Assessment</h4><p className="text-sm text-slate-400 mt-1">HIRA Update Required for {data.siteId}?</p></div>
                                            <a href={`risk.html?site=${data.siteId}`} target="_blank" className="bg-purple-600 hover:bg-purple-500 text-white px-6 py-3 rounded-xl font-bold text-sm transition-all shadow-lg flex items-center gap-2">Open Risk Module <i className="fas fa-external-link-alt"></i></a>
                                        </div>
                                        <div className="flex gap-4 items-start mb-10 p-6 border border-slate-700 rounded-xl bg-slate-900/30">
                                            <input type="checkbox" className="w-6 h-6 mt-0.5 accent-emerald-500 cursor-pointer" checked={data.riskUpdated} onChange={e=>setData({...data, riskUpdated:e.target.checked})} />
                                            <div><label className="text-base font-bold text-white block cursor-pointer" onClick={()=>setData({...data, riskUpdated:!data.riskUpdated})}>I confirm that the Risk Assessment has been reviewed.</label></div>
                                        </div>
                                        <div className="flex justify-end no-print pt-6 border-t border-slate-700"><button onClick={saveData} className="bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white font-bold px-10 py-4 rounded-xl shadow-lg transition-all transform hover:-translate-y-1 flex items-center gap-3"><i className="fas fa-save"></i> Submit Final Report</button></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
