<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO 45001 | Incident Reporting</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'display': ['Space Grotesk', 'sans-serif'], 'mono': ['JetBrains Mono', 'monospace'] },
                    colors: { 'glass': 'rgba(30, 41, 59, 0.7)' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Space Grotesk', sans-serif; background-color: #0f172a; color: white; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* TREE DIAGRAM CSS */
        .tree ul { padding-top: 20px; position: relative; transition: all 0.5s; display: flex; justify-content: center; }
        .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; transition: all 0.5s; }
        /* Connectors */
        .tree li::before, .tree li::after {
            content: ''; position: absolute; top: 0; right: 50%; border-top: 2px solid #475569; width: 50%; height: 20px;
        }
        .tree li::after { right: auto; left: 50%; border-left: 2px solid #475569; }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 2px solid #475569; border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before {
            content: ''; position: absolute; top: 0; left: 50%; border-left: 2px solid #475569; width: 0; height: 20px;
        }
        /* Node Styling */
        .tree-node {
            display: inline-block; padding: 10px; text-decoration: none; border-radius: 8px;
            background: #1e293b; border: 1px solid #334155; color: white; min-width: 140px; position: relative;
        }
        
        /* Logic Gate Icons */
        .gate-icon {
            position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%);
            background: #0f172a; border: 1px solid #475569; border-radius: 50%; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; z-index: 10;
        }

        /* PRINT STYLES */
        @media print {
            body { background-color: white; color: black; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .glass-panel { background: white; border: 1px solid #000; color: black; box-shadow: none; margin-bottom: 20px; page-break-inside: avoid; }
            .text-white { color: black !important; }
            .text-slate-400, .text-slate-500 { color: #333 !important; }
            input, select, textarea { border: 1px solid #ccc !important; background: white !important; color: black !important; }
            .bg-slate-900, .bg-slate-800, .bg-slate-950 { background: white !important; }
            /* Tree Fixes for Print */
            .tree li::before, .tree li::after, .tree ul ul::before { border-color: #000 !important; }
            .tree-node { border: 1px solid #000 !important; background: #fff !important; color: #000 !important; }
            .gate-icon { border-color: #000 !important; background: #fff !important; color: #000 !important; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", 
            authDomain: "ohsms-fa534.firebaseapp.com",
            databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/",
            projectId: "ohsms-fa534",
            storageBucket: "ohsms-fa534.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { get, ref, set, update, push };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- RECURSIVE FAULT TREE COMPONENT ---
        const FaultTreeNode = ({ node, onUpdate, onDelete }) => {
            const handleAddChild = () => {
                const newChild = { id: Date.now(), label: 'New Event', type: 'EVENT', children: [] };
                onUpdate({ ...node, children: [...(node.children || []), newChild] });
            };

            const handleUpdateChild = (childIndex, updatedChild) => {
                const newChildren = [...node.children];
                newChildren[childIndex] = updatedChild;
                onUpdate({ ...node, children: newChildren });
            };

            const handleDeleteChild = (childIndex) => {
                const newChildren = node.children.filter((_, i) => i !== childIndex);
                onUpdate({ ...node, children: newChildren });
            };

            // Toggle Logic Gate: EVENT -> AND -> OR -> ROOT -> EVENT
            const toggleType = () => {
                const types = ['EVENT', 'AND', 'OR', 'ROOT'];
                const next = types[(types.indexOf(node.type) + 1) % types.length];
                onUpdate({ ...node, type: next });
            };

            return (
                <li>
                    <div className="tree-node group relative">
                        {/* Header Actions */}
                        <div className="absolute -top-3 right-0 opacity-0 group-hover:opacity-100 flex gap-1 no-print">
                            <button onClick={handleAddChild} className="bg-blue-600 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center shadow" title="Add Child">+</button>
                            {onDelete && <button onClick={onDelete} className="bg-red-600 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center shadow" title="Remove Node">x</button>}
                        </div>

                        {/* Node Content */}
                        <input 
                            value={node.label} 
                            onChange={(e) => onUpdate({...node, label: e.target.value})}
                            className="bg-transparent text-center w-full text-xs font-bold outline-none border-b border-transparent focus:border-blue-500 pb-1"
                        />
                        
                        {/* Logic Gate Indicator */}
                        <div className="mt-2 cursor-pointer no-print" onClick={toggleType}>
                            <span className={`text-[10px] px-2 py-0.5 rounded font-bold border 
                                ${node.type === 'AND' ? 'border-purple-500 text-purple-400' : 
                                  node.type === 'OR' ? 'border-orange-500 text-orange-400' : 
                                  node.type === 'ROOT' ? 'border-emerald-500 text-emerald-400' : 'border-slate-600 text-slate-500'}`}>
                                {node.type === 'EVENT' ? 'Event' : node.type}
                            </span>
                        </div>
                        {/* Print View for Gate */}
                        <div className="hidden print:block text-[10px] font-bold mt-1 uppercase">[{node.type}]</div>

                        {/* Connector Icon */}
                        {node.children && node.children.length > 0 && (
                            <div className="gate-icon text-slate-300">
                                {node.type === 'AND' ? '&' : (node.type === 'OR' ? '≥1' : '↓')}
                            </div>
                        )}
                    </div>

                    {node.children && node.children.length > 0 && (
                        <ul>
                            {node.children.map((child, index) => (
                                <FaultTreeNode 
                                    key={child.id} 
                                    node={child} 
                                    onUpdate={(updated) => handleUpdateChild(index, updated)}
                                    onDelete={() => handleDeleteChild(index)}
                                />
                            ))}
                        </ul>
                    )}
                </li>
            );
        };

        // --- INCIDENT FORM ---
        const IncidentForm = ({ session, sites, initialData, onBack, onSave }) => {
            const [step, setStep] = useState(1);
            const [data, setData] = useState(initialData || {
                siteId: '', date: '', time: '', type: 'Near Miss', description: '',
                investigation: { 
                    fiveWhys: ['','','','',''], 
                    fishbone: { man:[], machine:[], material:[], method:[], environment:[] },
                    // Default Root of Fault Tree
                    faultTreeRoot: { id: 1, label: 'Incident Event', type: 'AND', children: [] },
                    rootCause: ''
                },
                capa: [],
                riskUpdated: false
            });

            // ID Generation Logic
            useEffect(() => {
                if(!initialData && data.siteId && data.type && !data.id) {
                    const typeCode = data.type === 'Near Miss' ? 'NM' : (data.type === 'Accident' ? 'AC' : 'HZ');
                    const seq = Math.floor(Math.random() * 999).toString().padStart(3,'0');
                    const newId = `${session.orgId}-${data.siteId}-${typeCode}-${seq}`;
                    setData(prev => ({ ...prev, id: newId }));
                }
            }, [data.siteId, data.type]);

            // Fishbone Helpers
            const updateFishbone = (cat, idx, val) => {
                const arr = [...(data.investigation.fishbone[cat] || [])];
                arr[idx] = val;
                setData({...data, investigation: {...data.investigation, fishbone: {...data.investigation.fishbone, [cat]: arr}}});
            };
            const addFishboneItem = (cat) => {
                const arr = [...(data.investigation.fishbone[cat] || []), ''];
                setData({...data, investigation: {...data.investigation, fishbone: {...data.investigation.fishbone, [cat]: arr}}});
            };

            const handlePrint = () => window.print();

            return (
                <div className="max-w-7xl mx-auto w-full pb-20 animate-fade-in">
                    
                    {/* NAV (Screen Only) */}
                    <div className="flex items-center justify-between mb-6 no-print">
                        <button onClick={onBack} className="flex items-center gap-2 text-slate-400 hover:text-white"><i className="fas fa-arrow-left"></i> Back</button>
                        <div className="flex gap-2 bg-slate-900 p-1 rounded-full border border-slate-700">
                            {['Initial', 'Investigate', 'CAPA', 'Review'].map((label, i) => (
                                <button key={i} onClick={() => setStep(i+1)} className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all ${step === i+1 ? 'bg-blue-600 text-white' : 'text-slate-500 hover:text-slate-300'}`}>{label}</button>
                            ))}
                        </div>
                        <button onClick={handlePrint} className="flex items-center gap-2 text-emerald-400 hover:text-emerald-300 font-bold text-sm bg-emerald-900/20 px-4 py-2 rounded-lg border border-emerald-500/50">
                            <i className="fas fa-file-pdf"></i> Generate Full Report
                        </button>
                    </div>

                    {/* PRINT HEADER */}
                    <div className="hidden print:block text-center border-b-2 border-black pb-4 mb-6">
                        <h1 className="text-3xl font-bold uppercase tracking-widest">Incident Investigation Report</h1>
                        <div className="flex justify-between mt-2 text-sm">
                            <span><strong>ID:</strong> {data.id}</span>
                            <span><strong>Site:</strong> {data.siteId}</span>
                            <span><strong>Date:</strong> {data.date}</span>
                        </div>
                    </div>

                    {/* SECTION 1: INITIAL DATA */}
                    <div className={step === 1 ? 'block' : 'hidden print:block'}>
                        <div className="glass-panel p-8 rounded-2xl mb-6">
                            <h2 className="text-xl font-bold mb-6 text-blue-400 border-b border-white/10 pb-2">1. Initial Information</h2>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-4">
                                <div><label className="text-[10px] uppercase font-bold text-slate-500">Site Location</label><select className="w-full bg-transparent border border-slate-600 rounded p-2 text-sm text-white" value={data.siteId} onChange={e=>setData({...data, siteId:e.target.value})}><option value="">Select</option>{sites.map(s=><option key={s.code} value={s.code}>{s.name}</option>)}</select></div>
                                <div><label className="text-[10px] uppercase font-bold text-slate-500">Type</label><select className="w-full bg-transparent border border-slate-600 rounded p-2 text-sm text-white" value={data.type} onChange={e=>setData({...data, type:e.target.value})}><option>Near Miss</option><option>Accident</option></select></div>
                                <div><label className="text-[10px] uppercase font-bold text-slate-500">Date</label><input type="date" className="w-full bg-transparent border border-slate-600 rounded p-2 text-sm text-white" value={data.date} onChange={e=>setData({...data, date:e.target.value})} /></div>
                                <div><label className="text-[10px] uppercase font-bold text-slate-500">Time</label><input type="time" className="w-full bg-transparent border border-slate-600 rounded p-2 text-sm text-white" value={data.time} onChange={e=>setData({...data, time:e.target.value})} /></div>
                            </div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Description</label><textarea rows="4" className="w-full bg-transparent border border-slate-600 rounded p-2 text-sm text-white" value={data.description} onChange={e=>setData({...data, description:e.target.value})}></textarea></div>
                        </div>
                    </div>

                    {/* SECTION 2: INVESTIGATION */}
                    <div className={step === 2 ? 'block' : 'hidden print:block'}>
                        <div className="glass-panel p-8 rounded-2xl mb-6">
                            <h2 className="text-xl font-bold mb-6 text-purple-400 border-b border-white/10 pb-2">2. Investigation & Root Cause</h2>
                            
                            {/* Visual Fault Tree */}
                            <div className="mb-10 overflow-x-auto pb-4">
                                <h3 className="font-bold text-white mb-2 flex items-center gap-2"><i className="fas fa-sitemap text-orange-400"></i> Fault Tree Analysis</h3>
                                <p className="text-xs text-slate-400 mb-4 no-print">Click items to edit text. Click logic gates (AND/OR) to toggle type. Use + to add branches.</p>
                                <div className="tree">
                                    <ul>
                                        <FaultTreeNode 
                                            node={data.investigation.faultTreeRoot || { id: 1, label: 'Incident', type: 'AND', children: [] }} 
                                            onUpdate={(root) => setData({...data, investigation: {...data.investigation, faultTreeRoot: root}})} 
                                        />
                                    </ul>
                                </div>
                            </div>

                            <hr className="border-slate-700 my-8"/>

                            {/* 5 Whys */}
                            <div className="mb-8">
                                <h3 className="font-bold text-white mb-2"><i className="fas fa-question-circle text-blue-400"></i> 5-Whys Analysis</h3>
                                {data.investigation.fiveWhys.map((w,i) => (
                                    <div key={i} className="flex gap-2 mb-2 items-center">
                                        <span className="text-xs font-bold w-12 text-slate-500">Why {i+1}?</span>
                                        <input className="flex-1 bg-transparent border-b border-slate-700 focus:border-blue-500 outline-none text-sm text-white py-1" value={w} onChange={e=>{const fw=[...data.investigation.fiveWhys]; fw[i]=e.target.value; setData({...data, investigation: {...data.investigation, fiveWhys: fw}})}} />
                                    </div>
                                ))}
                            </div>

                            {/* Fishbone Inputs */}
                            <div className="grid grid-cols-2 gap-6">
                                {['Man', 'Machine', 'Material', 'Method'].map(cat => (
                                    <div key={cat} className="bg-slate-800/30 p-3 rounded border border-slate-700">
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="text-[10px] font-bold uppercase text-slate-400">{cat}</label>
                                            <button onClick={()=>addFishboneItem(cat.toLowerCase())} className="text-xs text-blue-400 no-print">+ Add</button>
                                        </div>
                                        {(data.investigation.fishbone[cat.toLowerCase()] || []).map((cause, i) => (
                                            <input key={i} className="w-full bg-transparent border-b border-slate-600 text-xs text-white mb-1 outline-none" value={cause} onChange={e=>updateFishbone(cat.toLowerCase(), i, e.target.value)} placeholder={`Cause ${i+1}`} />
                                        ))}
                                    </div>
                                ))}
                            </div>

                            <div className="mt-6">
                                <label className="text-xs font-bold text-emerald-400 uppercase">Final Root Cause</label>
                                <textarea rows="2" className="w-full bg-emerald-900/10 border border-emerald-500/30 rounded p-2 text-white mt-1" value={data.investigation.rootCause} onChange={e=>setData({...data, investigation: {...data.investigation, rootCause: e.target.value}})}></textarea>
                            </div>
                        </div>
                    </div>

                    {/* SECTION 3: CAPA */}
                    <div className={step === 3 ? 'block' : 'hidden print:block'}>
                        <div className="glass-panel p-8 rounded-2xl mb-6">
                            <h2 className="text-xl font-bold mb-6 text-orange-400 border-b border-white/10 pb-2">3. Corrective Actions (CAPA)</h2>
                            <div className="bg-slate-900/50 p-4 rounded mb-4 no-print">
                                <div className="grid grid-cols-4 gap-2 mb-2">
                                    <input id="cDesc" placeholder="Action Required" className="col-span-2 bg-slate-800 border border-slate-700 rounded p-2 text-white text-xs"/>
                                    <input id="cOwn" placeholder="Responsibility" className="bg-slate-800 border border-slate-700 rounded p-2 text-white text-xs"/>
                                    <input id="cDate" type="date" className="bg-slate-800 border border-slate-700 rounded p-2 text-white text-xs"/>
                                </div>
                                <button onClick={()=>{
                                    const d=document.getElementById('cDesc').value, o=document.getElementById('cOwn').value, t=document.getElementById('cDate').value;
                                    if(d){ setData({...data, capa: [...data.capa, {desc:d, owner:o, dueDate:t, status:'Open'}]}); document.getElementById('cDesc').value=''; }
                                }} className="bg-blue-600 text-white text-xs font-bold px-4 py-2 rounded">Add Action</button>
                            </div>
                            <table className="w-full text-left text-sm">
                                <thead className="border-b border-slate-700 text-xs uppercase text-slate-500"><tr><th>Action</th><th>Responsibility</th><th>Due Date</th><th>Status</th></tr></thead>
                                <tbody className="divide-y divide-slate-800">
                                    {data.capa.map((c,i)=>(<tr key={i}><td className="py-2">{c.desc}</td><td>{c.owner}</td><td>{c.dueDate}</td><td>{c.status}</td></tr>))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* SECTION 4: REVIEW */}
                    <div className={step === 4 ? 'block' : 'hidden print:block'}>
                        <div className="glass-panel p-8 rounded-2xl mb-6">
                            <h2 className="text-xl font-bold mb-6 text-emerald-400 border-b border-white/10 pb-2">4. Review & Sign-off</h2>
                            <div className="flex justify-between items-center bg-slate-800 p-4 rounded mb-6 no-print">
                                <div><h4 className="font-bold text-white">Risk Register Update</h4><p className="text-xs text-slate-400">Update HIRA with new controls?</p></div>
                                <a href="risk.html" target="_blank" className="bg-purple-600 text-white text-xs font-bold px-4 py-2 rounded">Go to Risk Module</a>
                            </div>
                            <div className="flex gap-2 items-center mb-6">
                                <input type="checkbox" checked={data.riskUpdated} onChange={e=>setData({...data, riskUpdated:e.target.checked})} className="w-4 h-4"/>
                                <label className="text-sm text-white">I confirm the Risk Assessment has been reviewed.</label>
                            </div>
                            <div className="flex justify-end no-print">
                                <button onClick={()=>onSave(data)} className="bg-gradient-to-r from-emerald-600 to-emerald-500 text-white font-bold px-8 py-3 rounded-xl shadow-lg">Save & Close</button>
                            </div>
                        </div>
                    </div>

                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('list');
            const [session, setSession] = useState(null);
            const [sites, setSites] = useState([]);
            const [incidents, setIncidents] = useState([]);
            const [currentData, setCurrentData] = useState(null);

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) { window.location.href = 'index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);
                fetchData(sess.orgId);
            }, []);

            const fetchData = async (orgId) => {
                const dbRef = window.fb.ref(window.db);
                const snap = await window.fb.get(window.fb.child(dbRef, `organizations/${orgId}`));
                if(snap.exists()) {
                    const val = snap.val();
                    setSites(val.sites ? Object.values(val.sites) : []);
                    setIncidents(val.incidents ? Object.entries(val.incidents).map(([k,v]) => ({firebaseKey:k, ...v})) : []);
                }
            };

            const handleSave = async (data) => {
                const dbPath = `organizations/${session.orgId}/incidents`;
                if(data.firebaseKey) await window.fb.update(window.fb.ref(window.db, `${dbPath}/${data.firebaseKey}`), data);
                else await window.fb.push(window.fb.ref(window.db, dbPath), data);
                fetchData(session.orgId);
                setView('list');
            };

            if(!session) return null;

            return (
                <div className="flex flex-col h-full bg-slate-950 text-white min-h-screen">
                    <div className="h-16 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-6 no-print">
                        <div className="flex items-center gap-4"><a href="home.html" className="text-slate-400 hover:text-white"><i className="fas fa-home"></i></a><h1 className="font-bold">Incidents</h1></div>
                        <span className="text-xs bg-slate-800 px-3 py-1 rounded text-slate-400">{session.orgId}</span>
                    </div>
                    <div className="p-6 flex-1 overflow-y-auto">
                        {view === 'list' && (
                            <div className="max-w-7xl mx-auto animate-fade-in">
                                <div className="flex justify-between mb-8">
                                    <h2 className="text-3xl font-bold">Incident Dashboard</h2>
                                    <button onClick={()=>{setCurrentData(null); setView('form')}} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow">+ Report New</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {incidents.map(inc => <IncidentCard key={inc.id} data={inc} onView={(d)=>{setCurrentData(d); setView('form')}} />)}
                                </div>
                            </div>
                        )}
                        {view === 'form' && <IncidentForm session={session} sites={sites} initialData={currentData} onBack={()=>setView('list')} onSave={handleSave} />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <style>.animate-fade-in { animation: fadeIn 0.4s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }</style>
</body>
</html>
