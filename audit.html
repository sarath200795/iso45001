<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internal Audit Management</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { 'slate-850': '#1e293b', 'slate-950': '#020617' } }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; outline: none; width: 100%; }
        input:focus, select:focus, textarea:focus { border-color: #3b82f6; }

        /* PRINT STYLES */
        @media print {
            @page { size: A4; margin: 10mm; }
            body, html, #root { width: 100%; height: auto; background: white !important; color: black !important; overflow: visible !important; }
            .no-print, header, .tabs-nav { display: none !important; }
            .print-section { display: block !important; border: 1px solid black; padding: 15px; margin-bottom: 20px; }
            
            /* Form Simulation for Print */
            .form-box { border: 1px solid black; padding: 5px; margin-bottom: 5px; }
            .form-label { font-weight: bold; font-size: 10pt; text-transform: uppercase; }
            .form-value { font-size: 11pt; }
            
            input, textarea, select { border: none !important; background: transparent !important; color: black !important; padding: 0; resize: none; }
            .bg-slate-900, .bg-slate-800 { background: white !important; }
            .text-white, .text-slate-400 { color: black !important; }
        }
        
        .print-section { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", authDomain: "ohsms-fa534.firebaseapp.com", databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/", projectId: "ohsms-fa534", storageBucket: "ohsms-fa534.appspot.com", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { ref, get, push, update, remove };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- COMPONENTS ---

        // 1. AUDIT SCHEDULING TAB
        const AuditScheduler = ({ siteId, onGenerate }) => {
            const [plan, setPlan] = useState({
                siteId: siteId === 'GLOBAL' ? '' : siteId,
                area: 'Plant',
                auditor: '',
                auditee: '',
                dateFrom: '',
                dateTo: '',
                standard: 'ISO 45001:2018',
                scope: 'Health and Safety management system'
            });

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="glass-panel p-6 rounded-xl border-l-4 border-blue-500 no-print">
                        <h2 className="text-xl font-bold text-white mb-4">1. Audit Scheduling & Plan</h2>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Site ID</label><input value={plan.siteId} onChange={e=>setPlan({...plan, siteId:e.target.value})} disabled={siteId!=='GLOBAL'} /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Area / Department</label><input value={plan.area} onChange={e=>setPlan({...plan, area:e.target.value})} /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Auditor Name</label><input value={plan.auditor} onChange={e=>setPlan({...plan, auditor:e.target.value})} /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Auditee Name</label><input value={plan.auditee} onChange={e=>setPlan({...plan, auditee:e.target.value})} /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Date From</label><input type="date" value={plan.dateFrom} onChange={e=>setPlan({...plan, dateFrom:e.target.value})} /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Date To</label><input type="date" value={plan.dateTo} onChange={e=>setPlan({...plan, dateTo:e.target.value})} /></div>
                            <div className="col-span-2"><label className="text-[10px] uppercase font-bold text-slate-500">Audit Scope / Standard</label><input value={plan.standard} onChange={e=>setPlan({...plan, standard:e.target.value})} /></div>
                        </div>
                        <div className="flex justify-end gap-2">
                            <button onClick={()=>window.print()} className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded font-bold text-sm"><i className="fas fa-print"></i> Print Plan</button>
                            <button onClick={()=>onGenerate(plan)} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold text-sm">Save & Generate Plan</button>
                        </div>
                    </div>

                    {/* PRINT VIEW FOR SCHEDULE */}
                    <div className="print-section">
                        <div className="text-center border-b-2 border-black mb-4 pb-2">
                            <h1 className="text-2xl font-bold uppercase">Internal Audit Plan</h1>
                            <p>ISO 45001 & ISO 14001 Management System</p>
                        </div>
                        <table className="w-full border-collapse border border-black text-sm">
                            <tbody>
                                <tr><td className="border border-black p-2 font-bold">Site:</td><td className="border border-black p-2">{plan.siteId}</td><td className="border border-black p-2 font-bold">Date:</td><td className="border border-black p-2">{plan.dateFrom} to {plan.dateTo}</td></tr>
                                <tr><td className="border border-black p-2 font-bold">Auditor:</td><td className="border border-black p-2">{plan.auditor}</td><td className="border border-black p-2 font-bold">Auditee:</td><td className="border border-black p-2">{plan.auditee}</td></tr>
                                <tr><td className="border border-black p-2 font-bold">Scope:</td><td colSpan="3" className="border border-black p-2">{plan.scope}</td></tr>
                                <tr><td className="border border-black p-2 font-bold">Area:</td><td colSpan="3" className="border border-black p-2">{plan.area}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // 2. INTERNAL AUDITING TAB (The Form)
        const AuditForm = ({ siteId, onSave }) => {
            const [data, setData] = useState({
                // Part A [cite: 1]
                scheduleRef: '', auditDate: new Date().toISOString().split('T')[0],
                department: '', area: '', 
                auditee: '', auditor: '',
                ncRef: '', classification: 'Minor', // [cite: 1]
                standard: 'ISO 45001', clause: '', 
                criteria: '', // [cite: 1]
                ncStatement: '', // [cite: 1]
                evidence: '', // [cite: 2]
                
                // Part B 
                correction: '', rootCause: '', capa: '', responsibility: '', targetDate: '',
                
                // Part C 
                followUp: 'No', verificationStatus: 'Open', verifiedBy: '', verificationDate: '', comments: '',
                status: 'Open'
            });

            const handleSubmit = () => {
                if(!data.department || !data.ncStatement) { alert("Fill required fields"); return; }
                const payload = { ...data, siteId: siteId==='GLOBAL' ? 'GEN' : siteId, timestamp: Date.now() };
                onSave(payload);
            };

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <div className="glass-panel p-6 rounded-xl border border-slate-700">
                        <div className="bg-slate-800 p-2 rounded mb-4 text-xs font-bold text-slate-400 uppercase">Part A - To be filled by Auditor [cite: 1]</div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Schedule Ref</label><input value={data.scheduleRef} onChange={e=>setData({...data, scheduleRef:e.target.value})} placeholder="e.g., IA-02" /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Audit Date</label><input type="date" value={data.auditDate} onChange={e=>setData({...data, auditDate:e.target.value})} /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Department</label><input value={data.department} onChange={e=>setData({...data, department:e.target.value})} /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Area / Phase</label><input value={data.area} onChange={e=>setData({...data, area:e.target.value})} /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Auditor Name</label><input value={data.auditor} onChange={e=>setData({...data, auditor:e.target.value})} /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Auditee Name</label><input value={data.auditee} onChange={e=>setData({...data, auditee:e.target.value})} /></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">NC Ref No</label><input value={data.ncRef} onChange={e=>setData({...data, ncRef:e.target.value})} /></div>
                            <div>
                                <label className="text-[10px] uppercase font-bold text-slate-500">Classification</label>
                                <select value={data.classification} onChange={e=>setData({...data, classification:e.target.value})}>
                                    <option>Minor</option><option>Major</option><option>Observation</option><option>OFI</option>
                                </select>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Standard</label><select value={data.standard} onChange={e=>setData({...data, standard:e.target.value})}><option>ISO 45001</option><option>ISO 14001</option></select></div>
                            <div><label className="text-[10px] uppercase font-bold text-slate-500">Clause / Title</label><input value={data.clause} onChange={e=>setData({...data, clause:e.target.value})} placeholder="e.g. 9.1.2 Evaluation" /></div>
                        </div>
                        <div className="mb-4">
                            <label className="text-[10px] uppercase font-bold text-slate-500">Audit Criteria (Policies/Procedures) [cite: 1]</label>
                            <input value={data.criteria} onChange={e=>setData({...data, criteria:e.target.value})} className="w-full" />
                        </div>
                        <div className="mb-4">
                            <label className="text-[10px] uppercase font-bold text-slate-500">Non-Conformity Statement [cite: 1]</label>
                            <textarea rows="3" value={data.ncStatement} onChange={e=>setData({...data, ncStatement:e.target.value})} className="w-full bg-slate-900 border border-red-500/30"></textarea>
                        </div>
                        <div>
                            <label className="text-[10px] uppercase font-bold text-slate-500">Objective Evidence [cite: 2]</label>
                            <textarea rows="2" value={data.evidence} onChange={e=>setData({...data, evidence:e.target.value})} className="w-full"></textarea>
                        </div>
                    </div>
                    <button onClick={handleSubmit} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg">Save Audit Finding</button>
                </div>
            );
        };

        // 3. AUDIT CLOSURE TAB
        const AuditClosure = ({ audits, onUpdate }) => {
            const [selected, setSelected] = useState(null);

            const handleClose = () => {
                if(!selected) return;
                const updated = { ...selected, status: selected.verificationStatus === 'Completely closed-out' ? 'Closed' : 'Open' };
                onUpdate(updated);
                setSelected(null);
            };

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in h-full">
                    {/* List of Open Audits */}
                    <div className="col-span-1 bg-slate-900 border border-slate-700 rounded-xl overflow-hidden flex flex-col h-[70vh]">
                        <div className="p-4 bg-slate-800 font-bold border-b border-slate-700">Open Findings</div>
                        <div className="overflow-y-auto flex-1 p-2">
                            {audits.filter(a => a.status !== 'Closed').map(a => (
                                <div key={a.id} onClick={()=>setSelected(a)} className={`p-3 mb-2 rounded cursor-pointer border hover:bg-slate-800 ${selected?.id===a.id ? 'border-blue-500 bg-slate-800' : 'border-slate-700 bg-slate-900'}`}>
                                    <div className="flex justify-between mb-1"><span className="text-xs font-mono text-emerald-400">{a.ncRef || 'No Ref'}</span><span className="text-[10px] bg-red-900 text-red-300 px-1 rounded">{a.classification}</span></div>
                                    <div className="text-sm font-bold truncate">{a.department}</div>
                                    <div className="text-[10px] text-slate-400 truncate">{a.ncStatement}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Closure Form */}
                    <div className="col-span-2 glass-panel p-6 rounded-xl h-[70vh] overflow-y-auto">
                        {!selected ? <div className="h-full flex items-center justify-center text-slate-500">Select a finding to close</div> : (
                            <div className="space-y-6">
                                <div className="border-b border-slate-700 pb-4">
                                    <h3 className="text-lg font-bold text-white mb-2">Finding: {selected.ncRef}</h3>
                                    <p className="text-sm text-slate-300 bg-slate-800 p-3 rounded">{selected.ncStatement}</p>
                                </div>

                                {/* Part B  */}
                                <div className="bg-slate-800/50 p-4 rounded border border-slate-700">
                                    <div className="text-xs font-bold text-blue-400 uppercase mb-3">Part B - Auditee Action </div>
                                    <div className="space-y-3">
                                        <div><label className="text-[10px] uppercase">Correction</label><input value={selected.correction || ''} onChange={e=>setSelected({...selected, correction:e.target.value})} className="bg-slate-900 w-full" /></div>
                                        <div><label className="text-[10px] uppercase">Root Cause Analysis</label><textarea value={selected.rootCause || ''} onChange={e=>setSelected({...selected, rootCause:e.target.value})} className="bg-slate-900 w-full" rows="2" /></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-[10px] uppercase">Corrective Action Plan (CAPA)</label><input value={selected.capa || ''} onChange={e=>setSelected({...selected, capa:e.target.value})} className="bg-slate-900 w-full" /></div>
                                            <div><label className="text-[10px] uppercase">Target Date</label><input type="date" value={selected.targetDate || ''} onChange={e=>setSelected({...selected, targetDate:e.target.value})} className="bg-slate-900 w-full" /></div>
                                        </div>
                                    </div>
                                </div>

                                {/* Part C  */}
                                <div className="bg-slate-800/50 p-4 rounded border border-slate-700">
                                    <div className="text-xs font-bold text-emerald-400 uppercase mb-3">Part C - Verification </div>
                                    <div className="space-y-3">
                                        <div><label className="text-[10px] uppercase">Follow-up Required?</label><select value={selected.followUp || 'No'} onChange={e=>setSelected({...selected, followUp:e.target.value})} className="bg-slate-900 w-full"><option>Yes</option><option>No</option></select></div>
                                        <div>
                                            <label className="text-[10px] uppercase">Verification Status </label>
                                            <select value={selected.verificationStatus || 'No action initiated'} onChange={e=>setSelected({...selected, verificationStatus:e.target.value})} className="bg-slate-900 w-full">
                                                <option>No action initiated</option>
                                                <option>Initiated & In-progress</option>
                                                <option>Completely closed-out</option>
                                            </select>
                                        </div>
                                        <div><label className="text-[10px] uppercase">Comments / Evidence</label><textarea value={selected.comments || ''} onChange={e=>setSelected({...selected, comments:e.target.value})} className="bg-slate-900 w-full" rows="2" /></div>
                                    </div>
                                </div>

                                <button onClick={handleClose} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg shadow-lg">Update & Close</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 4. DASHBOARD TAB
        const Dashboard = ({ audits, siteId }) => {
            const [filterSite, setFilterSite] = useState(siteId === 'GLOBAL' ? 'All' : siteId);
            const [filterArea, setFilterArea] = useState('All');

            // Derived Data
            const stats = useMemo(() => {
                let filtered = audits;
                if(filterSite !== 'All') filtered = filtered.filter(a => a.siteId === filterSite);
                if(filterArea !== 'All') filtered = filtered.filter(a => a.department === filterArea);

                const total = filtered.length;
                const open = filtered.filter(a => a.status !== 'Closed').length;
                const closed = filtered.filter(a => a.status === 'Closed').length;
                const major = filtered.filter(a => a.classification === 'Major').length;
                const minor = filtered.filter(a => a.classification === 'Minor').length;
                const ofi = filtered.filter(a => a.classification === 'OFI').length;

                return { total, open, closed, major, minor, ofi, filtered };
            }, [audits, filterSite, filterArea]);

            // Unique Areas for Filter
            const areas = [...new Set(audits.map(a => a.department))];

            return (
                <div className="space-y-6 animate-fade-in">
                    {/* Filters */}
                    <div className="flex gap-4 mb-6">
                        <select className="bg-slate-800 p-2 rounded" value={filterSite} onChange={e=>setFilterSite(e.target.value)} disabled={siteId!=='GLOBAL'}>
                            <option value="All">All Sites</option>
                            {[...new Set(audits.map(a=>a.siteId))].map(s=><option key={s}>{s}</option>)}
                        </select>
                        <select className="bg-slate-800 p-2 rounded" value={filterArea} onChange={e=>setFilterArea(e.target.value)}>
                            <option value="All">All Areas</option>
                            {areas.map(a=><option key={a}>{a}</option>)}
                        </select>
                    </div>

                    {/* KPI Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-slate-800 p-4 rounded border-l-4 border-blue-500"><h3 className="text-slate-400 text-xs uppercase">Total Findings</h3><p className="text-2xl font-bold">{stats.total}</p></div>
                        <div className="bg-slate-800 p-4 rounded border-l-4 border-red-500"><h3 className="text-slate-400 text-xs uppercase">Open NCs</h3><p className="text-2xl font-bold">{stats.open}</p></div>
                        <div className="bg-slate-800 p-4 rounded border-l-4 border-green-500"><h3 className="text-slate-400 text-xs uppercase">Closed</h3><p className="text-2xl font-bold">{stats.closed}</p></div>
                        <div className="bg-slate-800 p-4 rounded border-l-4 border-yellow-500"><h3 className="text-slate-400 text-xs uppercase">Major NCs</h3><p className="text-2xl font-bold">{stats.major}</p></div>
                    </div>

                    {/* Table */}
                    <div className="bg-slate-900 rounded-lg overflow-hidden border border-slate-700">
                        <table className="w-full text-left text-sm text-slate-300">
                            <thead className="bg-slate-800 text-xs uppercase font-bold text-slate-500"><tr><th className="p-3">Ref</th><th className="p-3">Site</th><th className="p-3">Area</th><th className="p-3">Type</th><th className="p-3">Statement</th><th className="p-3">Status</th></tr></thead>
                            <tbody className="divide-y divide-slate-800">
                                {stats.filtered.map(a => (
                                    <tr key={a.id} className="hover:bg-slate-800">
                                        <td className="p-3 font-mono">{a.ncRef}</td>
                                        <td className="p-3">{a.siteId}</td>
                                        <td className="p-3">{a.department}</td>
                                        <td className="p-3">{a.classification}</td>
                                        <td className="p-3 truncate max-w-xs">{a.ncStatement}</td>
                                        <td className="p-3"><span className={`px-2 py-1 rounded text-[10px] ${a.status==='Closed'?'bg-green-900 text-green-300':'bg-red-900 text-red-300'}`}>{a.status}</span></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [tab, setTab] = useState('schedule');
            const [session, setSession] = useState(null);
            const [audits, setAudits] = useState([]);
            const [siteId, setSiteId] = useState('GLOBAL');

            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) { window.location.href='index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);

                const params = new URLSearchParams(window.location.search);
                const ctx = params.get('site');
                if(ctx && ctx !== 'GLOBAL') setSiteId(ctx);

                // Load Data
                const dbRef = window.fb.ref(window.db, `organizations/${sess.orgId}/audits`);
                window.fb.get(dbRef).then(snap => {
                    if(snap.exists()) setAudits(Object.entries(snap.val()).map(([k,v])=>({id:k,...v})));
                });
            }, []);

            const handleSaveAudit = async (data) => {
                await window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/audits`), data);
                alert("Audit Saved");
                window.location.reload();
            };

            const handleUpdateAudit = async (data) => {
                await window.fb.update(window.fb.ref(window.db, `organizations/${session.orgId}/audits/${data.id}`), data);
                alert("Audit Updated");
                window.location.reload();
            };

            if(!session) return null;

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-white font-sans">
                    {/* Header */}
                    <div className="h-16 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-6 no-print">
                        <div className="flex items-center gap-4"><a href="home.html" className="text-slate-400 hover:text-white"><i className="fas fa-arrow-left"></i> Back</a><h1 className="font-bold text-lg">Internal Audit</h1></div>
                        <div className="flex bg-slate-800 p-1 rounded-lg tabs-nav">
                            {['schedule','audit','closure','dashboard'].map(t => (
                                <button key={t} onClick={()=>setTab(t)} className={`px-4 py-1.5 rounded text-xs font-bold uppercase ${tab===t?'bg-blue-600 text-white':'text-slate-400'}`}>{t}</button>
                            ))}
                        </div>
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto p-6 max-w-7xl mx-auto w-full">
                        {tab === 'schedule' && <AuditScheduler siteId={siteId} onGenerate={handleSaveAudit} />}
                        {tab === 'audit' && <AuditForm siteId={siteId} onSave={handleSaveAudit} />}
                        {tab === 'closure' && <AuditClosure audits={audits} onUpdate={handleUpdateAudit} />}
                        {tab === 'dashboard' && <Dashboard audits={audits} siteId={siteId} />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
