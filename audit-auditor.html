<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor Workplace</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Space Grotesk', 'sans-serif'] },
                    colors: { 'slate-850': '#1e293b', 'slate-950': '#020617' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        input, select, textarea { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; outline: none; width: 100%; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #3b82f6; }
        input:disabled { opacity: 0.7; cursor: not-allowed; }
        
        /* STATUS COLORS */
        .task-card { border-left-width: 4px; transition: transform 0.2s; }
        .task-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .status-red { border-left-color: #ef4444; background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, rgba(30, 41, 59, 0.4) 100%); }
        .status-yellow { border-left-color: #eab308; background: linear-gradient(90deg, rgba(234, 179, 8, 0.1) 0%, rgba(30, 41, 59, 0.4) 100%); opacity: 0.8; }
        .status-orange { border-left-color: #f97316; background: linear-gradient(90deg, rgba(249, 115, 22, 0.1) 0%, rgba(30, 41, 59, 0.4) 100%); }
        .status-green { border-left-color: #22c55e; background: linear-gradient(90deg, rgba(34, 197, 94, 0.1) 0%, rgba(30, 41, 59, 0.4) 100%); opacity: 0.8; }

        /* FINDING BADGES */
        .type-major { background-color: rgba(127, 29, 29, 0.5); color: #fca5a5; border: 1px solid #f87171; }
        .type-minor { background-color: rgba(124, 45, 18, 0.5); color: #fdba74; border: 1px solid #fb923c; }
        .type-ofi { background-color: rgba(113, 63, 18, 0.5); color: #fde047; border: 1px solid #facc15; }
        .type-obs { background-color: rgba(30, 58, 138, 0.5); color: #93c5fd; border: 1px solid #60a5fa; }

        /* PRINT STYLES */
        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            body * { visibility: hidden; }
            .print-container, .print-container * { visibility: visible !important; color: black !important; }
            .print-container { position: absolute; left: 0; top: 0; width: 100%; background: white; z-index: 9999; display: block !important; }
            table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 10pt; }
            th, td { border: 1px solid black !important; padding: 6px; text-align: left; page-break-inside: avoid; }
            th { background-color: #f0f0f0 !important; font-weight: bold; }
            .doc-header { text-align: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; }
            .doc-id { font-family: monospace; font-weight: bold; float: right; font-size: 9pt; }
            .section-box { border: 1px solid black; padding: 10px; margin-bottom: 15px; }
            .field-label { font-weight: bold; font-size: 9pt; text-transform: uppercase; color: #555; }
            .field-value { font-weight: bold; font-size: 10pt; }
        }
        .print-container { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, push, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k", authDomain: "ohsms-fa534.firebaseapp.com", databaseURL: "https://ohsms-fa534-default-rtdb.firebaseio.com/", projectId: "ohsms-fa534", storageBucket: "ohsms-fa534.appspot.com", messagingSenderId: "YOUR_SENDER_ID", appId: "YOUR_APP_ID" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.fb = { ref, get, push, update };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- HELPER: COLOR CODING ---
        const getTypeClass = (type) => {
            const t = type || '';
            if (t.includes('Major')) return 'type-major';
            if (t.includes('Minor')) return 'type-minor';
            if (t.includes('OFI')) return 'type-ofi';
            return 'type-obs'; 
        };

        const AuditorWorkplace = () => {
            const [session, setSession] = useState(null);
            const [view, setView] = useState('list');
            const [myTasks, setMyTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            
            // Filters
            const [filters, setFilters] = useState({ date: '', auditor: '', auditee: '', id: '' });

            const [currentTask, setCurrentTask] = useState(null);
            const [findings, setFindings] = useState([]);
            const [docId, setDocId] = useState('');
            const [criteria, setCriteria] = useState('');

            // LOAD DATA
            useEffect(() => {
                const s = sessionStorage.getItem('isoSession');
                if(!s) { window.location.href='index.html'; return; }
                const sess = JSON.parse(s);
                setSession(sess);

                const dbRef = window.fb.ref(window.db, `organizations/${sess.orgId}/auditPlans`);
                window.fb.get(dbRef).then(snap => {
                    if(snap.exists()) {
                        const plans = Object.entries(snap.val()).map(([k, v]) => ({...v, firebaseId: k}));
                        const tasks = [];
                        
                        plans.forEach(plan => {
                            if(plan.matrix && Array.isArray(plan.matrix)) {
                                plan.matrix.forEach(row => {
                                    if(row.auditor === sess.user || sess.role === 'Owner') {
                                        tasks.push({
                                            auditor: row.auditor || '',
                                            auditee: row.auditee || '',
                                            dept: row.dept || '',
                                            area: row.area || '',
                                            date: row.date || '',
                                            time: row.time || '',
                                            aspect: row.aspect || row.aspects || '', 
                                            planId: plan.docId || '',
                                            siteId: plan.siteId || '',
                                            leadAuditor: plan.leadAuditor || '',
                                            standard: plan.standard || '',
                                            scope: plan.scope || 'OH&S Management System',
                                            status: 'Planned', 
                                            findingRecord: null
                                        });
                                    }
                                });
                            }
                        });
                        
                        window.fb.get(window.fb.ref(window.db, `organizations/${sess.orgId}/auditFindings`)).then(fSnap => {
                            const existingFindings = fSnap.exists() ? Object.entries(fSnap.val()).map(([k,v]) => ({...v, firebaseKey: k})) : [];
                            const mergedTasks = tasks.map(t => {
                                const match = existingFindings.find(f => f.taskDetails.planId === t.planId && f.taskDetails.auditor === t.auditor && f.taskDetails.area === t.area);
                                if(match) return { ...t, status: match.status, findingRecord: match };
                                return t;
                            });
                            setMyTasks(mergedTasks);
                            setLoading(false);
                        });
                    } else { setLoading(false); }
                });
            }, []);

            // FILTER LOGIC
            const filteredTasks = useMemo(() => {
                return myTasks.filter(t => {
                    const matchDate = !filters.date || t.date.includes(filters.date);
                    const matchAuditor = !filters.auditor || t.auditor.toLowerCase().includes(filters.auditor.toLowerCase());
                    const matchAuditee = !filters.auditee || t.auditee.toLowerCase().includes(filters.auditee.toLowerCase());
                    
                    // Search ID in main doc ID OR inside findings array
                    const matchId = !filters.id || 
                        (t.findingRecord && t.findingRecord.docId.toLowerCase().includes(filters.id.toLowerCase())) ||
                        (t.findingRecord && t.findingRecord.findings && t.findingRecord.findings.some(f => f.id.toLowerCase().includes(filters.id.toLowerCase())));

                    return matchDate && matchAuditor && matchAuditee && matchId;
                });
            }, [myTasks, filters]);

            // GENERATE ID
            useEffect(() => {
                if(currentTask && !currentTask.findingRecord) {
                    const seq = Math.floor(10000 + Math.random() * 90000);
                    setDocId(`${session.orgId}-${currentTask.siteId}-IAF-${seq}`);
                } else if (currentTask && currentTask.findingRecord) {
                    setDocId(currentTask.findingRecord.docId);
                }
            }, [currentTask]);

            const generateID = () => `AF-${Math.floor(10000 + Math.random() * 90000)}`;

            // ACTIONS
            const handleCardClick = (task) => {
                setCurrentTask(task);
                setCriteria(task.standard || ''); 
                
                if (task.status === 'Planned') {
                    setFindings([{ id: generateID(), type: 'Observation', desc: '', clause: '', evidence: '', fileName: '' }]); 
                    setView('perform');
                } else {
                    setFindings(task.findingRecord.findings || []);
                    setCriteria(task.findingRecord.taskDetails.criteria || task.standard || '');
                    
                    if(task.status === 'Reported' || task.status === 'Closed') {
                        setView('readOnly'); 
                    } else if (task.status === 'Submitted for Verification') {
                        setView('verify'); 
                    }
                }
            };

            const addRow = () => setFindings([...findings, { id: generateID(), type: 'Observation', desc: '', clause: '', evidence: '', fileName: '' }]);
            const removeRow = (i) => setFindings(findings.filter((_, idx) => idx !== i));
            const updateRow = (i, f, v) => { const u = [...findings]; u[i][f] = v; setFindings(u); };
            const handleFile = (i, f) => { 
                const r = new FileReader(); r.readAsDataURL(f); 
                r.onload = () => { const u = [...findings]; u[i].evidence = r.result; u[i].fileName = f.name; setFindings(u); }; 
            };

            const handleSave = async () => {
                if(findings.some(f => !f.desc)) return alert("Please fill description for all findings.");
                
                const cleanTask = { ...currentTask, criteria: criteria || '' };
                const cleanFindings = findings.map(f => ({ ...f, id: f.id || generateID() }));

                const payload = {
                    docId: docId || '',
                    taskDetails: cleanTask,
                    findings: cleanFindings,
                    status: 'Reported',
                    auditDate: new Date().toISOString(),
                    auditor: session.user || '',
                    siteId: cleanTask.siteId
                };

                try {
                    await window.fb.push(window.fb.ref(window.db, `organizations/${session.orgId}/auditFindings`), payload);
                    alert("Audit Saved & Sent to Auditee.");
                    window.location.reload();
                } catch (e) { alert("Error saving: " + e.message); }
            };

            const handleVerifyClose = async () => {
                if(!currentTask.findingRecord) return;
                try {
                    await window.fb.update(window.fb.ref(window.db, `organizations/${session.orgId}/auditFindings/${currentTask.findingRecord.firebaseKey}`), {
                        status: 'Closed',
                        closureDate: new Date().toISOString()
                    });
                    alert("Audit Verified & Closed!");
                    window.location.reload();
                } catch(e) { alert("Error closing: " + e.message); }
            };

            if(loading) return <div className="flex h-screen items-center justify-center text-white">Loading...</div>;

            // --- PRINT VIEW ---
            const renderPrintView = (data) => (
                <div className="print-container">
                    <div className="doc-header">
                        <span className="doc-id">Doc Ref: {data.docId || docId}</span>
                        <h1>Internal Audit Report</h1>
                        <p>{data.taskDetails?.scope || currentTask.scope}</p>
                    </div>
                    <div className="section-box">
                        <div style={{display:'flex', justifyContent:'space-between', marginBottom:'5px'}}>
                            <div><span className="field-label">Site:</span> <span className="field-value">{data.taskDetails?.siteId || currentTask.siteId}</span></div>
                            <div><span className="field-label">Date:</span> <span className="field-value">{data.auditDate?.split('T')[0] || new Date().toISOString().split('T')[0]}</span></div>
                        </div>
                        <div style={{display:'flex', justifyContent:'space-between', marginBottom:'5px'}}>
                            <div><span className="field-label">Department:</span> <span className="field-value">{data.taskDetails?.dept || currentTask.dept}</span></div>
                            <div><span className="field-label">Area:</span> <span className="field-value">{data.taskDetails?.area || currentTask.area}</span></div>
                        </div>
                        <div style={{display:'flex', justifyContent:'space-between', marginBottom:'5px'}}>
                            <div><span className="field-label">Auditor:</span> <span className="field-value">{data.taskDetails?.auditor || currentTask.auditor}</span></div>
                            <div><span className="field-label">Auditee:</span> <span className="field-value">{data.taskDetails?.auditee || currentTask.auditee}</span></div>
                        </div>
                    </div>
                    <h3>Audit Findings</h3>
                    <table>
                        <thead><tr><th style={{width:'15%'}}>ID</th><th style={{width:'15%'}}>Type</th><th style={{width:'40%'}}>Description</th><th style={{width:'10%'}}>Clause</th><th style={{width:'20%'}}>Evidence</th></tr></thead>
                        <tbody>
                            {(data.findings || findings).map((f, i) => (
                                <tr key={i}><td>{f.id}</td><td>{f.type}</td><td>{f.desc}</td><td>{f.clause}</td><td>{f.fileName || 'N/A'}</td></tr>
                            ))}
                        </tbody>
                    </table>
                    {data.rootCause && (
                        <div className="section-box" style={{marginTop:'20px'}}>
                            <h3>Closure</h3>
                            <div><strong>Root Cause:</strong> {data.rootCause}</div>
                            <div><strong>Correction:</strong> {data.correction}</div>
                            {data.actions && (
                                <div style={{marginTop:'5px'}}>
                                    <strong>CAPA Plan:</strong>
                                    <ul>{data.actions.map((a,k) => <li key={k}>{a.action} (By: {a.resp}, Due: {a.target})</li>)}</ul>
                                </div>
                            )}
                        </div>
                    )}
                    <div className="section-box" style={{marginTop:'30px', border:'none'}}>
                        <div style={{display:'flex', justifyContent:'space-between'}}>
                            <div style={{borderTop:'1px solid black', width:'40%', paddingTop:'5px', textAlign:'center'}}>Auditor Signature</div>
                            <div style={{borderTop:'1px solid black', width:'40%', paddingTop:'5px', textAlign:'center'}}>Auditee Signature</div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-white font-sans overflow-hidden">
                    <div className="h-16 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-6 no-print">
                        <div className="flex items-center gap-4"><a href="audit.html" className="text-slate-400 hover:text-white flex items-center gap-2 transition"><i className="fas fa-arrow-left"></i> Back</a><h1 className="font-bold text-lg tracking-wide">Auditor Workplace</h1></div>
                        <div className="text-xs bg-slate-800 px-3 py-1 rounded text-emerald-400 border border-emerald-900">{session.user}</div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-8">
                        <div className="max-w-7xl mx-auto">
                            
                            {/* VIEW 1: TASK LIST + FILTER */}
                            {view === 'list' && (
                                <div className="screen-ui">
                                    <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                                        <h2 className="text-xl font-bold text-white flex items-center gap-2"><i className="fas fa-tasks text-blue-400"></i> Assigned Audits</h2>
                                        
                                        {/* FILTER BAR */}
                                        <div className="flex gap-2 bg-slate-900 p-2 rounded-lg border border-slate-800">
                                            <input type="date" className="bg-slate-800 text-xs w-32 border-none" value={filters.date} onChange={e=>setFilters({...filters, date:e.target.value})} />
                                            <input type="text" placeholder="Auditor Name" className="bg-slate-800 text-xs w-32 border-none" value={filters.auditor} onChange={e=>setFilters({...filters, auditor:e.target.value})} />
                                            <input type="text" placeholder="Auditee Name" className="bg-slate-800 text-xs w-32 border-none" value={filters.auditee} onChange={e=>setFilters({...filters, auditee:e.target.value})} />
                                            <input type="text" placeholder="ID (AF-xxx)" className="bg-slate-800 text-xs w-24 border-none" value={filters.id} onChange={e=>setFilters({...filters, id:e.target.value})} />
                                            <button onClick={()=>setFilters({date:'',auditor:'',auditee:'',id:''})} className="text-xs text-red-400 hover:text-white px-2"><i className="fas fa-times"></i></button>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {filteredTasks.length === 0 ? <div className="col-span-3 text-center text-slate-500 py-10">No audits match filters.</div> : 
                                        filteredTasks.map((task, i) => {
                                            const isEnabled = task.status === 'Planned' || task.status === 'Submitted for Verification' || task.status === 'Reported' || task.status === 'Closed';
                                            const statusClass = 
                                                task.status === 'Planned' ? 'status-red' : 
                                                task.status === 'Reported' ? 'status-yellow' : 
                                                task.status === 'Submitted for Verification' ? 'status-orange' : 'status-green';
                                            
                                            let statusText = 'Needs Audit';
                                            if(task.status === 'Reported') statusText = 'Sent for Correction';
                                            if(task.status === 'Submitted for Verification') statusText = 'Correction Received';
                                            if(task.status === 'Closed') statusText = 'Closed';

                                            return (
                                                <div key={i} onClick={() => isEnabled && handleCardClick(task)} className={`glass-panel p-6 rounded-xl relative task-card ${statusClass} ${isEnabled?'cursor-pointer':'cursor-not-allowed opacity-80'}`}>
                                                    <div className="flex justify-between mb-4">
                                                        <span className="text-[10px] font-bold uppercase bg-slate-900/50 px-2 py-1 rounded text-white border border-slate-700">{task.status}</span>
                                                        <span className="text-xs font-bold text-slate-300">{task.date}</span>
                                                    </div>
                                                    <div className="space-y-1 text-sm text-slate-300 mb-4">
                                                        <div><span className="text-slate-500 text-xs uppercase mr-2">Site:</span><b className="text-white">{task.siteId}</b></div>
                                                        <div><span className="text-slate-500 text-xs uppercase mr-2">Auditor:</span><b className="text-white">{task.auditor}</b></div>
                                                        <div><span className="text-slate-500 text-xs uppercase mr-2">Time:</span><b className="text-white">{task.time}</b></div>
                                                        <div className="pt-2 italic text-slate-400">Auditee: {task.auditee}</div>
                                                    </div>
                                                    <div className="pt-3 border-t border-slate-700/50 text-center">
                                                        <span className="text-xs font-bold uppercase text-white">{statusText}</span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* VIEW 2: EXECUTION FORM */}
                            {view === 'perform' && currentTask && (
                                <div className="animate-fade-in screen-ui">
                                    <div className="glass-panel p-6 rounded-2xl border-l-4 border-emerald-500 mb-6">
                                        <h3 className="text-emerald-400 font-bold uppercase text-sm mb-4">Section 1: Audit Context</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-6 text-sm">
                                            <div><label className="text-[10px] text-slate-500 uppercase block mb-1">Site</label><div className="font-bold">{currentTask.siteId}</div></div>
                                            <div><label className="text-[10px] text-slate-500 uppercase block mb-1">Auditor</label><div className="font-bold">{currentTask.auditor}</div></div>
                                            <div><label className="text-[10px] text-slate-500 uppercase block mb-1">Auditee</label><div className="font-bold text-amber-400">{currentTask.auditee}</div></div>
                                            <div><label className="text-[10px] text-slate-500 uppercase block mb-1">Date</label><div className="font-bold">{currentTask.date}</div></div>
                                            <div className="col-span-2"><label className="text-[10px] text-slate-500 uppercase block mb-1">Criteria</label><input value={criteria} onChange={e=>setCriteria(e.target.value)} className="bg-slate-900 border-slate-700 w-full text-xs"/></div>
                                        </div>
                                    </div>

                                    <div className="glass-panel p-6 rounded-2xl border-t-4 border-blue-500">
                                        <div className="flex justify-between items-center mb-4"><h3 className="text-blue-400 font-bold uppercase text-sm">Section 2: Audit Findings</h3><button onClick={addRow} className="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-xs">+ Add Finding</button></div>
                                        <div className="space-y-4">{findings.map((f, i) => (<div key={i} className="bg-slate-900/50 p-4 rounded-xl border border-slate-700 relative"><div className="absolute top-2 right-2 text-xs font-bold text-emerald-400 font-mono bg-emerald-900/30 px-2 rounded">{f.id}</div><div className="grid grid-cols-12 gap-4 items-start"><div className="col-span-2"><label className="text-[10px] text-slate-500 uppercase block mb-1">Type</label><select value={f.type} onChange={e=>updateRow(i, 'type', e.target.value)} className={`w-full text-xs font-bold border rounded p-2 outline-none ${getTypeClass(f.type)}`}><option value="Observation" className="text-black">Observation</option><option value="OFI" className="text-black">Opp. for Improv.</option><option value="Minor NC" className="text-black">Minor NC</option><option value="Major NC" className="text-black">Major NC</option></select></div><div className="col-span-2"><label className="text-[10px] text-slate-500 uppercase block mb-1">Clause</label><input value={f.clause} onChange={e=>updateRow(i, 'clause', e.target.value)} className="bg-slate-900 text-xs w-full border border-slate-700 rounded p-2" placeholder="e.g. 9.1" /></div><div className="col-span-4"><label className="text-[10px] text-slate-500 uppercase block mb-1">Description of Finding</label><textarea value={f.desc} onChange={e=>updateRow(i, 'desc', e.target.value)} className="bg-slate-900 text-xs w-full border border-slate-700 rounded p-2" rows="2"></textarea></div><div className="col-span-3"><label className="text-[10px] text-slate-500 uppercase block mb-1">Objective Evidence</label><input type="file" onChange={(e)=>handleFile(i, e.target.files[0])} className="text-[10px] text-slate-400 file:bg-slate-700 file:text-white file:border-none file:rounded file:px-2 file:py-1" />{f.fileName && <div className="text-[9px] text-emerald-400 mt-1 truncate"><i className="fas fa-paperclip mr-1"></i>{f.fileName}</div>}</div><div className="col-span-1 flex justify-center pt-6"><button onClick={()=>removeRow(i)} className="text-red-400 hover:text-white transition"><i className="fas fa-trash"></i></button></div></div></div>))}</div>
                                        <div className="mt-8 flex justify-end gap-3 pt-4 border-t border-slate-700"><button onClick={()=>setView('list')} className="px-6 py-2 rounded-lg border border-slate-600 text-slate-400 hover:text-white text-sm">Cancel</button><button onClick={handleSave} className="bg-emerald-600 hover:bg-emerald-500 px-6 py-2 rounded-lg text-white font-bold text-sm shadow-lg flex items-center gap-2"><i className="fas fa-save"></i> Save & Send</button><button onClick={()=>window.print()} className="bg-purple-600 hover:bg-purple-500 px-6 py-2 rounded-lg text-white font-bold text-sm shadow-lg flex items-center gap-2"><i className="fas fa-print"></i> Print Report</button></div>
                                    </div>
                                    {renderPrintView({ docId, taskDetails: {...currentTask, criteria}, findings, auditDate: new Date().toISOString() })}
                                </div>
                            )}

                            {/* VIEW 3: READ ONLY / VERIFY */}
                            {(view === 'readOnly' || view === 'verify') && currentTask.findingRecord && (
                                <div className="animate-fade-in screen-ui">
                                    <div className="flex justify-between mb-4">
                                        <button onClick={()=>setView('list')} className="text-slate-400"><i className="fas fa-arrow-left"></i> Back</button>
                                        <div className="flex gap-2">
                                            <button onClick={()=>window.print()} className="bg-slate-700 px-4 py-2 rounded text-xs font-bold"><i className="fas fa-print mr-2"></i>Print</button>
                                            {view === 'verify' && <button onClick={handleVerifyClose} className="bg-blue-600 px-4 py-2 rounded text-xs font-bold animate-pulse">Verify & Close Audit</button>}
                                        </div>
                                    </div>
                                    
                                    {/* VERIFICATION DISPLAY */}
                                    <div className="glass-panel p-6 rounded-xl border-l-4 border-orange-500 mb-6">
                                        <h3 className="text-orange-400 font-bold uppercase text-sm mb-4">Auditee Closure Response</h3>
                                        <div className="space-y-4 text-sm text-slate-300">
                                            
                                            {/* 1. Root Cause */}
                                            <div className="bg-slate-900 p-4 rounded-lg border border-slate-800">
                                                <div className="text-xs text-slate-500 uppercase font-bold mb-1">1. Root Cause</div>
                                                <div>{currentTask.findingRecord.rootCause || 'Pending...'}</div>
                                            </div>

                                            {/* 2. Correction */}
                                            <div className="bg-slate-900 p-4 rounded-lg border border-slate-800">
                                                <div className="text-xs text-slate-500 uppercase font-bold mb-1">2. Correction (Immediate)</div>
                                                <div>{currentTask.findingRecord.correction || 'Pending...'}</div>
                                            </div>

                                            {/* 3. CAPA Table */}
                                            <div className="bg-slate-900 p-4 rounded-lg border border-slate-800">
                                                <div className="text-xs text-slate-500 uppercase font-bold mb-2">3. Corrective Action Plan (CAPA)</div>
                                                {currentTask.findingRecord.actions && currentTask.findingRecord.actions.length > 0 ? (
                                                    <table className="w-full text-xs text-left text-slate-300">
                                                        <thead className="bg-slate-800 text-slate-500 uppercase">
                                                            <tr><th className="p-2">Action</th><th className="p-2">Responsibility</th><th className="p-2">Target Date</th></tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-slate-700">
                                                            {currentTask.findingRecord.actions.map((act, idx) => (
                                                                <tr key={idx}>
                                                                    <td className="p-2">{act.action}</td>
                                                                    <td className="p-2">{act.resp}</td>
                                                                    <td className="p-2">{act.target}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                ) : <div className="text-xs text-slate-500 italic">No actions listed.</div>}
                                            </div>

                                            {/* 4. Evidence */}
                                            <div className="bg-slate-900 p-4 rounded-lg border border-slate-800 flex items-center justify-between">
                                                <div>
                                                    <div className="text-xs text-slate-500 uppercase font-bold mb-1">4. Evidence of Closure</div>
                                                    <div className="text-emerald-400">{currentTask.findingRecord.evidenceFileName || 'No file attached'}</div>
                                                </div>
                                                {currentTask.findingRecord.evidenceFile && (
                                                    <a href={currentTask.findingRecord.evidenceFile} download={currentTask.findingRecord.evidenceFileName} className="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-xs">
                                                        Download Evidence
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    {renderPrintView(currentTask.findingRecord)}
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AuditorWorkplace />);
    </script>
</body>
</html>
